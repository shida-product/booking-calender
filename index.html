<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 32px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆæ¤œè¨¼ç”¨ï¼‰ */
        .reset-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 8px 12px;
            background: #ffffff;
            color: #1565c0;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.25);
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .tabs {
            display: flex;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            background: #fafafa;
            transition: all 0.3s ease;
            position: relative;
            color: #757575;
        }

        .tab:hover {
            background: #f5f5f5;
            color: #424242;
        }

        .tab.active {
            background: white;
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
        }

        .tab .badge {
            position: absolute;
            top: 8px;
            right: 16px;
            background: #f44336;
            color: white;
            border-radius: 10px;
            padding: 3px 8px;
            font-size: 11px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€±ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: #f5f5f5;
            border-radius: 12px;
        }

        .week-nav button {
            padding: 10px 20px;
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .week-nav button:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
        }

        .week-nav .week-info {
            font-size: 18px;
            font-weight: 600;
            color: #424242;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ(åˆ©ç”¨è€…ç”»é¢) */
        .menu-selection {
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 12px;
        }

        .menu-selection h3 {
            margin-bottom: 16px;
            color: #424242;
            font-size: 16px;
            font-weight: 600;
        }

        .menu-options {
            display: flex;
            gap: 16px;
        }

        .menu-option {
            flex: 1;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .menu-option:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.12);
        }

        .menu-option.selected {
            border-color: #1976d2;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .menu-option .menu-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #212121;
        }

        .menu-option .menu-duration {
            font-size: 14px;
            color: #757575;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            overflow-x: auto;
            margin-top: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .calendar-table th {
            background: linear-gradient(180deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 14px 8px;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .calendar-table th:last-child {
            border-right: none;
        }

        .calendar-table th.date-header {
            padding: 8px;
        }

        .date-header .day-name {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .date-header .date-num {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
        }

        .date-header .block-all-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            width: 100%;
        }

        .date-header .block-all-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
        }

        .calendar-table td {
            border: 1px solid #f0f0f0;
            padding: 0;
            text-align: center;
            vertical-align: middle;
        }

        .time-label {
            background: #fafafa;
            font-weight: 600;
            color: #616161;
            font-size: 13px;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #e0e0e0;
            padding: 12px 8px;
        }

        /* ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ(æ–½è¡“è€…ç”»é¢ - 15åˆ†åˆ»ã¿) */
        .time-slot {
            height: 48px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            user-select: none;
            position: relative;
        }

        .time-slot.available {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
        }

        .time-slot.available:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            transform: scale(1.02);
            box-shadow: inset 0 0 0 2px #4caf50;
        }

        .time-slot.blocked {
            background: #f5f5f5;
            color: #bdbdbd;
            cursor: not-allowed;
        }

        .time-slot.blocked.removable {
            cursor: pointer;
            position: relative;
        }

        .time-slot.blocked.removable:hover {
            background: #ffebee;
            color: #c62828;
        }

        .time-slot.blocked.removable:hover::after {
            content: 'è§£é™¤';
            position: absolute;
            font-size: 11px;
            bottom: 2px;
            right: 4px;
        }

        .time-slot.pending {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #ef6c00;
            font-size: 13px;
            animation: pendingPulse 2s infinite;
        }

        .time-slot.pending:hover {
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
            transform: scale(1.02);
        }

        @keyframes pendingPulse {
            0%, 100% { box-shadow: inset 0 0 0 2px transparent; }
            50% { box-shadow: inset 0 0 0 2px #ff9800; }
        }

        .time-slot.confirmed {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            font-size: 13px;
        }

        

        .time-slot.rejected {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            font-size: 13px;
        }

        .time-slot.dragging {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            box-shadow: inset 0 0 0 3px #fbc02d;
        }

        /* åˆ©ç”¨è€…ç”»é¢ï¼ˆæ—§1æ™‚é–“UIã®CSSã¯æ•´ç†ã§å‰Šé™¤ï¼‰ */

        /* 15åˆ†ã‚°ãƒªãƒƒãƒ‰ï¼ˆPC/ãƒ¢ãƒã‚¤ãƒ«å…±é€šã®åŸºç¤ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ */
        .hp-calendar { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .hp-table { width: 100%; border-collapse: collapse; background: #fff; }
        .hp-table thead th { position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #e0e0e0; font-size: 13px; padding: 10px 0; }
        .hp-table th, .hp-table td { border-right: 1px solid #f0f0f0; }
        .hp-table th:last-child, .hp-table td:last-child { border-right: none; }
        .hp-time { background: #fafafa; position: sticky; left: 0; z-index: 5; font-size: 13px; color: #616161; padding: 10px 8px; border-right: 1px solid #e0e0e0; }
        .hp-slot { height: 48px; text-align: center; vertical-align: middle; padding: 0; }
        .hp-mark { display: inline-block; width: 24px; height: 24px; line-height: 24px; border-radius: 50%; font-weight: 700; font-size: 13px; }
        .hp-mark.ok { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; box-shadow: inset 0 0 0 2px #a5d6a7; }
        .hp-mark.ng { color: #9e9e9e; }
        .hp-cell-btn { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .hp-cell-btn:hover { background: #f7f7f7; }

        /* åˆ©ç”¨è€… 15åˆ†å±•é–‹ã‚¹ãƒ­ãƒƒãƒˆã‚’æ–½è¡“è€…ã¨çµ±ä¸€ */
        .quarter-slots { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 6px; }
        .quarter-slot { height: 48px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; border-radius: 0; cursor: pointer; user-select: none; }
        .quarter-slot.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; }
        .quarter-slot.available:hover { background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); box-shadow: inset 0 0 0 2px #4caf50; transform: scale(1.02); }
        .quarter-slot.blocked { background: #f5f5f5; color: #bdbdbd; cursor: not-allowed; }

        /* åˆ©ç”¨è€…ï¼ˆãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼é¢¨ï¼‰ã‚»ãƒ«ã‚‚æ–½è¡“è€…ã¨çµ±ä¸€ */
        .hp-cell { width: 100%; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; border-radius: 0; }
        .hp-cell.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; cursor: pointer; }
        .hp-cell.available:hover { background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); box-shadow: inset 0 0 0 2px #4caf50; transform: scale(1.02); }
        .hp-cell.blocked { background: #f5f5f5; color: #bdbdbd; }

        /* åˆ©ç”¨è€…ç”»é¢: 1æ™‚é–“è¡Œãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸¸ï¼ˆâ—‹/â–³/Ã—/-ï¼‰ */
        .status-icon { display: inline-block; width: 28px; height: 28px; line-height: 28px; border-radius: 50%; font-weight: 700; font-size: 14px; border: 1px solid #e0e0e0; text-align: center; }
        .status-icon.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; border-color: #a5d6a7; }
        .status-icon.partial { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #ef6c00; border-color: #ffcc80; }
        .status-icon.full { background: #f5f5f5; color: #bdbdbd; border-color: #e0e0e0; }
        .status-icon.unavailable { background: #fafafa; color: #bdbdbd; border-color: #e0e0e0; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 16px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 12px 48px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #212121;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-body .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-body .info-label {
            font-weight: 600;
            color: #757575;
            font-size: 14px;
        }

        .modal-body .info-value {
            color: #212121;
            font-weight: 500;
            font-size: 14px;
        }
        /* æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è£œåŠ©æƒ…å ±è¡Œ */
        .modal-body .sub-info { display: inline-block; margin-top: 4px; color: #757575; font-size: 12px; }

        .modal-body textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 8px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .modal-body textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            margin-top: 16px;
            font-weight: 600;
            color: #424242;
            font-size: 14px;
        }

        .modal-body select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .modal-body select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #757575;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #bdbdbd;
        }

        /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
        .instructions {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #1976d2;
        }

        .instructions h4 {
            margin-bottom: 12px;
            color: #1565c0;
            font-size: 15px;
            font-weight: 600;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin: 6px 0;
            color: #424242;
            font-size: 13px;
            line-height: 1.6;
        }

        
        /* å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; cursor: pointer; transition: border-color 0.2s ease; background: #fff; }
        .form-select:focus { outline: none; border-color: #1976d2; box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); }
        .inline-controls { display: flex; gap: 12px; align-items: center; }
        .inline-controls .status { color: #424242; font-size: 14px; }

        /* å‡¡ä¾‹ï¼ˆæ–½è¡“è€…ç”»é¢ï¼‰ */
        .legend { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; color: #616161; font-size: 12px; }
        .legend .item { display: inline-flex; align-items: center; gap: 6px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 16px; padding: 4px 10px; }
        .legend .chip { width: 14px; height: 14px; border-radius: 3px; box-shadow: inset 0 0 0 2px rgba(0,0,0,0.04); }
        .chip-ok { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #a5d6a7; }
        .chip-pending { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 1px solid #ffcc80; }
        .chip-confirmed { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; }
        .chip-block { background: #f5f5f5; border: 1px solid #e0e0e0; }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 22px;
            }

            /* é€±ãƒŠãƒ“: 2è¡Œæ§‹æˆï¼ˆ1è¡Œç›®=æ—¥ä»˜ã€2è¡Œç›®=å‰é€±/æ¬¡é€±ï¼‰ */
            .week-nav { display: grid; grid-template-columns: 1fr auto 1fr; grid-template-areas: "date date date" "prev . next"; row-gap: 8px; align-items: center; padding: 12px 14px; }
            .week-nav .week-info { grid-area: date; text-align: center; font-size: 14px; }
            .week-nav button { font-size: 12px; padding: 8px 12px; }
            #prevWeekProvider, #prevWeekCustomer { grid-area: prev; justify-self: start; }
            #nextWeekProvider, #nextWeekCustomer { grid-area: next; justify-self: end; }
            /* æ–½è¡“è€…ç”»é¢ã®ï¼‹ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸‹æ®µãƒ•ãƒ«å¹… */
            #openQuickBlockSheet { grid-column: 1 / -1; justify-self: stretch; }

            .menu-options {
                flex-direction: column;
            }

            .calendar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            /* åˆ©ç”¨è€…ç”»é¢ã®åˆ—å¹…ã‚’ã‚„ã‚„ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .calendar-table th {
                padding: 10px 4px;
                font-size: 12px;
            }
            .calendar-table th.date-header { padding: 6px 4px; }
            .date-header .day-name { font-size: 12px; }
            .date-header .date-num { font-size: 11px; }
            .time-label {
                padding: 10px 6px;
                font-size: 12px;
            }
            .hour-time-label { min-width: 64px; font-size: 12px; }

            /* ä½¿ã„æ–¹ï¼ˆèª¬æ˜ï¼‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            .instructions { padding: 12px 14px; margin-bottom: 16px; }
            .instructions h4 { font-size: 14px; margin-bottom: 8px; }
            .instructions li { font-size: 12px; line-height: 1.5; }

            

            /* ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼é¢¨ï¼ˆãƒ¢ãƒã‚¤ãƒ«æ™‚ã®åˆ©ç”¨è€…è¡¨ï¼‰ */
            .hp-calendar { border-radius: 0; box-shadow: none; }
            .hp-table { width: 100%; border-collapse: collapse; background: #fff; }
            .hp-table thead th { position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #e0e0e0; font-size: 12px; padding: 6px 0; }
            .hp-table th, .hp-table td { border-right: 1px solid #f0f0f0; }
            .hp-table th:last-child, .hp-table td:last-child { border-right: none; }
            .hp-time { background: #fafafa; position: sticky; left: 0; z-index: 5; font-size: 12px; color: #616161; padding: 8px 6px; border-right: 1px solid #e0e0e0; }
            .hp-slot { height: 48px; text-align: center; vertical-align: middle; padding: 0; }
            .hp-mark { display: inline-block; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; font-weight: 700; font-size: 12px; }
            .hp-mark.ok { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; box-shadow: inset 0 0 0 2px #a5d6a7; }
            .hp-mark.ng { color: #9e9e9e; }
            .hp-cell-btn { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
            .hp-cell-btn:active { background: #f5f5f5; }
            .hp-cell { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: 700; border-radius: 6px; }
            .hp-cell.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; }
            .hp-cell.blocked { background: #f5f5f5; color: #bdbdbd; }
            .status-icon { display: inline-block; width: 26px; height: 26px; line-height: 26px; border-radius: 50%; font-weight: 700; font-size: 13px; border: 1px solid #e0e0e0; text-align: center; }
            .status-icon.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; border-color: #a5d6a7; }
            .status-icon.partial { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #ef6c00; border-color: #ffcc80; }
            .status-icon.full { background: #f5f5f5; color: #bdbdbd; border-color: #e0e0e0; }
            .status-icon.unavailable { background: #fafafa; color: #bdbdbd; border-color: #e0e0e0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>æ–½è¡“è€…ã¨åˆ©ç”¨è€…ã®ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ </p>
            <button class="reset-btn" onclick="resetData()" title="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="tabs">
            <div class="tab active" data-tab="provider">
                æ–½è¡“è€…ç”»é¢
                <span class="badge" id="pendingBadge" style="display: none;">0</span>
            </div>
            <div class="tab" data-tab="customer">
                åˆ©ç”¨è€…ç”»é¢
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content">
            <!-- æ–½è¡“è€…ç”»é¢ -->
            <div class="tab-content active" id="provider-content">
                <div class="instructions">
                    <h4>ğŸ“Œ ä½¿ã„æ–¹</h4>
                    <ul>
                        <li>ã€Œå—ä»˜å¯èƒ½ã€ã®æ™‚é–“æ ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨­å®šã§ãã¾ã™</li>
                        <li>ã€ŒÃ—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®æ ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã§ãã¾ã™</li>
                        <li>æ—¥ä»˜ä¸‹ã®ã€Œçµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³ã§ä¸€æ—¥å…¨ä½“ã‚’ä¸€æ‹¬ãƒ–ãƒ­ãƒƒã‚¯ã§ãã¾ã™</li>
                        <li>ã‚ªãƒ¬ãƒ³ã‚¸ã®ã€Œæ‰¿èªå¾…ã¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ‰¿èª/ä¸æ‰¿èªã‚’é¸æŠã§ãã¾ã™</li>
                        <li>æ‰¿èªå¾Œã¯ã€äºˆç´„æ™‚é–“å¸¯ãŒã€Œäºˆç´„æ¸ˆã€ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆäºˆç´„æ¸ˆã¿ã‚’ã‚¿ãƒƒãƒ—ã§é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤ºï¼‰</li>
                    </ul>
                </div>
                <!-- äºˆç´„æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“è¨­å®š -->
                <div class="menu-selection" id="bufferSettingPanel">
                    <h3>äºˆç´„æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“</h3>
                    <div class="inline-controls">
                        <select id="defaultBufferSelect" class="form-select" style="max-width:200px;">
                            <option value="15" selected>15åˆ†</option>
                            <option value="30">30åˆ†</option>
                            <option value="45">45åˆ†</option>
                            <option value="60">60åˆ†</option>
                            <option value="75">75åˆ†</option>
                            <option value="90">90åˆ†</option>
                            <option value="105">105åˆ†</option>
                            <option value="120">120åˆ†</option>
                        </select>
                        <button class="btn-secondary" id="applyDefaultBufferBtn" title="é¸æŠã—ãŸãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’é©ç”¨">é©ç”¨</button>
                        <div class="status">é©ç”¨ä¸­: <span id="appliedBufferText">15</span>åˆ†</div>
                    </div>
                </div>
                

                <div class="week-nav">
                    <button id="prevWeekProvider">â† å‰é€±</button>
                    <div class="week-info" id="weekInfoProvider"></div>
                    <button id="nextWeekProvider">æ¬¡é€± â†’</button>
                    <button id="openQuickBlockSheet" class="btn-primary" style="margin-left:12px;">ï¼‹ ãƒ–ãƒ­ãƒƒã‚¯</button>
                </div>

                <div class="calendar">
                    <table class="calendar-table" id="providerCalendar"></table>
                </div>
                <div class="legend" aria-hidden="false">
                    <span class="item"><span class="chip chip-ok"></span>å—ä»˜å¯èƒ½</span>
                    <span class="item"><span class="chip chip-pending"></span>æ‰¿èªå¾…ã¡ï¼ˆæ–½è¡“ï¼‰</span>
                    <span class="item"><span class="chip chip-confirmed"></span>äºˆç´„æ¸ˆã¿ï¼ˆæ–½è¡“ï¼‰</span>
                    <span class="item"><span class="chip chip-block"></span>ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå‰å¾Œ or æ‰‹å‹•ï¼‰</span>
                </div>
            </div>

            <!-- åˆ©ç”¨è€…ç”»é¢ -->
            <div class="tab-content" id="customer-content">
                <div class="instructions">
                    <h4>ğŸ“Œ ä½¿ã„æ–¹</h4>
                    <ul>
                        <li>ã¾ãšæ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</li>
                        <li>15åˆ†åˆ»ã¿ã®ã‚°ãƒªãƒƒãƒ‰ã§ç©ºãçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆâ—‹:ç©ºãã€Ã—:æº€å¸­ï¼‰</li>
                        <li>â—‹ã®æ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã¾ã™</li>
                        <li>é€ä¿¡å¾Œã¯ãã®æ™‚é–“å¸¯ãŒÃ—ï¼ˆä»®æŠ¼ã•ãˆï¼‰ã¨ãªã‚Šã€æ–½è¡“è€…ã®æ‰¿èªå¾Œã«ç¢ºå®šã—ã¾ã™</li>
                    </ul>
                </div>

                <div class="menu-selection">
                    <h3>æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ</h3>
                    <div class="menu-options">
                        <div class="menu-option" data-menu="1">
                            <div class="menu-name">æ–½è¡“â‘ </div>
                            <div class="menu-duration">45åˆ†</div>
                        </div>
                        <div class="menu-option" data-menu="2">
                            <div class="menu-name">æ–½è¡“â‘¡</div>
                            <div class="menu-duration">60åˆ†</div>
                        </div>
                    </div>
                </div>

                <div class="week-nav">
                    <button id="prevWeekCustomer">â† å‰é€±</button>
                    <div class="week-info" id="weekInfoCustomer"></div>
                    <button id="nextWeekCustomer">æ¬¡é€± â†’</button>
                </div>

                <div class="calendar">
                    <table class="calendar-table" id="customerCalendar"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="blockModal" role="dialog" aria-modal="true" aria-labelledby="blockModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="blockModalTitle">ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’è¨­å®š</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="blockDateTime"></span>
                </div>
                <label>ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“:</label>
                <select id="blockDuration">
                    <option value="15">15åˆ†</option>
                    <option value="30">30åˆ†</option>
                    <option value="45">45åˆ†</option>
                    <option value="60">60åˆ†</option>
                    <option value="75">75åˆ†</option>
                    <option value="90">90åˆ†</option>
                    <option value="105">105åˆ†</option>
                    <option value="120">120åˆ†</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBlockModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="confirmBlock()">ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- äºˆç´„ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="bookingModal" role="dialog" aria-modal="true" aria-labelledby="bookingModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="bookingModalTitle">äºˆç´„å†…å®¹ç¢ºèª</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="bookingMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="bookingDateTime"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ‰€è¦æ™‚é–“:</span>
                    <span class="info-value" id="bookingDuration"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBookingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="confirmBooking()">äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡</button>
            </div>
        </div>
    </div>

    <!-- æ‰¿èª/ä¸æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="approvalModal" role="dialog" aria-modal="true" aria-labelledby="approvalModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="approvalModalTitle">äºˆç´„ã®æ‰¿èª/ä¸æ‰¿èª</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="approvalMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="approvalDateTime"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">äºˆç´„æ™‚é–“:</span>
                    <span class="info-value" id="approvalCoreTime"></span>
                </div>
                <label>ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                <textarea id="approvalComment" placeholder="åˆ©ç”¨è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹ï¼šç§»å‹•æ™‚é–“ã®éƒ½åˆä¸Šã€äºˆç´„å—ä»˜ãŒã§ãã¾ã›ã‚“&#10;ã€‡æœˆã€‡æ—¥ ã€‡ã€‡ï¼šã€‡ã€‡ï¼ã€‡ã€‡ï¼šã€‡ã€‡ã§ã‚ã‚Œã°å—ä»˜å¯èƒ½ã§ã™ã€‚"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeApprovalModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-danger" onclick="rejectBooking()">ä¸æ‰¿èª</button>
                <button class="btn-success" onclick="approveBooking()">æ‰¿èª</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆäºˆç´„æ¸ˆã¿ã‚»ãƒ«ç”¨ï¼‰ -->
    <div class="modal" id="customerInfoModal" role="dialog" aria-modal="true" aria-labelledby="customerInfoTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="customerInfoTitle">é¡§å®¢æƒ…å ±</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">ãŠåå‰:</span>
                    <span class="info-value" id="ciName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">é€£çµ¡å…ˆ:</span>
                    <span class="info-value" id="ciContact"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="ciMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="ciDateTime"></span>
                </div>
            </div>
            <div class="modal-footer">
                <a id="customerInfoLink" class="btn-primary" target="_blank" rel="noopener">é¡§å®¢è©³ç´°ã‚’é–‹ã</a>
                <button class="btn-secondary" onclick="closeCustomerInfoModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆï¼‰ -->
    <div class="modal" id="quickBlockSheet" role="dialog" aria-modal="true" aria-labelledby="quickBlockTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="quickBlockTitle">æ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆ</div>
            <div class="modal-body">
                <label for="quickBlockDate">æ—¥ä»˜</label>
                <select id="quickBlockDate"></select>
                <label for="quickBlockStart">é–‹å§‹æ™‚åˆ»</label>
                <select id="quickBlockStart"></select>
                <label for="quickBlockDuration">ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“</label>
                <select id="quickBlockDuration">
                    <option value="15" selected>15åˆ†</option>
                    <option value="30">30åˆ†</option>
                    <option value="45">45åˆ†</option>
                    <option value="60">60åˆ†</option>
                    <option value="75">75åˆ†</option>
                    <option value="90">90åˆ†</option>
                    <option value="105">105åˆ†</option>
                    <option value="120">120åˆ†</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('quickBlockSheet').classList.remove('active'); document.body.style.overflow='';">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" id="quickBlockConfirmBtn">ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentWeek = 0;
        let selectedMenu = null;
        let bookings = [];
        let blocks = [];
        let dragStart = null;
        let dragEnd = null;
        let isDragging = false;
        let selectedBookingId = null;
        let selectedBlockSlot = null;
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ï¼ˆäºˆç´„æ™‚ã®å‰å¾Œãƒ–ãƒ­ãƒƒã‚¯ï¼‰
        let defaultBlockDurationApplied = 15;
        let defaultBlockDurationPending = 15;
        
        // ã‚¿ãƒƒãƒç”¨
        let touchLongPressTimer = null;
        let isTouchDragging = false;
        let lastTouchSlot = null;

        const START_HOUR = 9;
        const END_HOUR = 21;
        const INTERVAL = 15; // 15åˆ†åˆ»ã¿

        // æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getWeekDates(weekOffset) {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1) + (weekOffset * 7));
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function formatWeekInfo(dates) {
            const startDate = dates[0];
            const endDate = dates[6];
            const startYear = startDate.getFullYear();
            const startMonth = startDate.getMonth() + 1;
            const startDay = startDate.getDate();
            const endYear = endDate.getFullYear();
            const endMonth = endDate.getMonth() + 1;
            const endDay = endDate.getDate();
            
            if (startYear !== endYear) {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endYear}å¹´${endMonth}æœˆ${endDay}æ—¥`;
            } else if (startMonth !== endMonth) {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endMonth}æœˆ${endDay}æ—¥`;
            } else {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endDay}æ—¥`;
            }
        }

        function getTimeSlots() {
            const slots = [];
            for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                for (let min = 0; min < 60; min += INTERVAL) {
                    slots.push(`${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`);
                }
            }
            slots.push(`${END_HOUR}:00`);
            return slots;
        }

        function timeToMinutes(time) {
            const [hour, min] = time.split(':').map(Number);
            return hour * 60 + min;
        }

        function minutesToTime(minutes) {
            const hour = Math.floor(minutes / 60);
            const min = minutes % 60;
            return `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        }

        function getMenuDuration(menuId) {
            return menuId === 1 ? 45 : 60;
        }

        // æ°¸ç¶šåŒ–: ä¿å­˜
        function persistState() {
            localStorage.setItem('rcs_bookings', JSON.stringify(bookings));
            localStorage.setItem('rcs_blocks', JSON.stringify(blocks));
            try { localStorage.setItem('rcs_default_block_duration_applied', String(defaultBlockDurationApplied)); } catch (e) {}
        }

        // æ¤œè¨¼ç”¨: ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetData() {
            if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆäºˆç´„ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
            try {
                localStorage.removeItem('rcs_bookings');
                localStorage.removeItem('rcs_blocks');
                localStorage.removeItem('rcs_default_block_duration_applied');
            } catch (e) {}
            bookings = [];
            blocks = [];
            selectedMenu = null;
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠã®UIãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.menu-option').forEach(o => o.classList.remove('selected'));
            // å†æç”»
            renderCalendar(true);
            renderCalendar(false);
            updatePendingBadge();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
        }

        // æ°¸ç¶šåŒ–: å¾©å…ƒ
        function restoreState() {
            try {
                bookings = JSON.parse(localStorage.getItem('rcs_bookings') || '[]');
                blocks = JSON.parse(localStorage.getItem('rcs_blocks') || '[]');
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒãƒƒãƒ•ã‚¡é …ç›®ãŒãªã„å ´åˆã«è£œå®Œï¼‰
                if (Array.isArray(bookings) && bookings.length > 0) {
                    let mutated = false;
                    bookings = bookings.map(b => {
                        const hasCore = typeof b.coreStartTime === 'string' && typeof b.coreEndTime === 'string';
                        const hasBuffer = typeof b.bufferDuration === 'number';
                        if (hasCore && hasBuffer) return b;
                        // è£œå®Œï¼šã‚³ã‚¢=å…¨ä½“ã€buffer=0 ã¨ã—ã¦ä¿æŒ
                        mutated = true;
                        const start = b.startTime;
                        const end = b.endTime;
                        return {
                            id: b.id,
                            date: b.date,
                            startTime: start,
                            endTime: end,
                            coreStartTime: b.coreStartTime || start,
                            coreEndTime: b.coreEndTime || end,
                            bufferDuration: typeof b.bufferDuration === 'number' ? b.bufferDuration : 0,
                            menuId: b.menuId,
                            status: b.status || 'pending',
                            comment: b.comment || '',
                            customerName: b.customerName || 'ã‚²ã‚¹ãƒˆ',
                            customerContact: b.customerContact || 'æœªç™»éŒ²',
                            customerDetailUrl: b.customerDetailUrl || ''
                        };
                    });
                    if (mutated) { try { localStorage.setItem('rcs_bookings', JSON.stringify(bookings)); } catch (e) {} }
                }
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã®å¾©å…ƒ
                const stored = parseInt(localStorage.getItem('rcs_default_block_duration_applied') || '15', 10);
                if (!isNaN(stored)) {
                    defaultBlockDurationApplied = stored;
                    defaultBlockDurationPending = stored;
                }
            } catch (e) {
                bookings = [];
                blocks = [];
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèª
        function isBlocked(date, time) {
            const dateStr = formatDate(date);
            return blocks.some(block => 
                block.date === dateStr && 
                timeToMinutes(time) >= timeToMinutes(block.startTime) && 
                timeToMinutes(time) < timeToMinutes(block.endTime)
            );
        }

        // ç¯„å›²å†…ãŒã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        function isAllBlockedInRange(dateStr, startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const slots = getTimeSlots();
            
            // ç¯„å›²å†…ã®ã™ã¹ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < slots.length - 1; i++) {
                const slotTime = slots[i];
                const slotMinutes = timeToMinutes(slotTime);
                
                if (slotMinutes >= startMinutes && slotMinutes < endMinutes) {
                    const date = new Date(dateStr + 'T00:00:00');
                    if (!isBlocked(date, slotTime)) {
                        return false;
                    }
                }
            }
            return true;
        }

        // äºˆç´„ç¢ºèª(ä¸æ‰¿èªã¯é™¤å¤–)
        function getBookingAtSlot(date, time) {
            const dateStr = formatDate(date);
            return bookings.find(booking => 
                booking.status !== 'rejected' &&
                booking.date === dateStr && 
                timeToMinutes(time) >= timeToMinutes(booking.startTime) && 
                timeToMinutes(time) < timeToMinutes(booking.endTime)
            );
        }

        // äºˆç´„å¯èƒ½ãƒã‚§ãƒƒã‚¯ï¼ˆå‰å¾Œãƒ–ãƒ­ãƒƒã‚¯ä»•æ§˜ï¼‰
        function canBook(date, startTime, duration) {
            const startMinutes = timeToMinutes(startTime);
            const bufferDuration = defaultBlockDurationApplied;
            // ã‚³ã‚¢ãŒå–¶æ¥­æ™‚é–“å†…ã«åã¾ã‚‰ãªã„å ´åˆã¯ä¸å¯ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³äºˆç´„ï¼‰
            if (startMinutes + duration > END_HOUR * 60) {
                return false;
            }
            const isFirstSlot = startMinutes === START_HOUR * 60;
            const isLastSlot = startMinutes + duration + bufferDuration > END_HOUR * 60;
            const checkStart = isFirstSlot ? startMinutes : startMinutes - bufferDuration;
            const checkEnd = isLastSlot ? startMinutes + duration : startMinutes + duration + bufferDuration;
            if (checkStart >= checkEnd) return false;
            const slots = getTimeSlots();
            for (let i = 0; i < slots.length - 1; i++) {
                const slotTime = slots[i];
                const slotMinutes = timeToMinutes(slotTime);
                if (slotMinutes >= checkStart && slotMinutes < checkEnd) {
                    if (isBlocked(date, slotTime) || getBookingAtSlot(date, slotTime)) {
                        return false;
                    }
                }
            }
            return true;
        }

        // 1æ™‚é–“æ ã®çŠ¶æ…‹åˆ¤å®š(åˆ©ç”¨è€…ç”»é¢ç”¨)
        function getHourSlotStatus(date, hour) {
            if (!selectedMenu) return 'unavailable';
            
            const duration = getMenuDuration(selectedMenu);
            const quarters = [0, 15, 30, 45];
            let availableCount = 0;
            
            quarters.forEach(min => {
                const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                if (canBook(date, time, duration)) {
                    availableCount++;
                }
            });
            
            if (availableCount === 4) return 'available';
            if (availableCount === 0) return 'full';
            return 'partial';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» - ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function renderCalendar(isProvider) {
            const dates = getWeekDates(currentWeek);
            const calendarId = isProvider ? 'providerCalendar' : 'customerCalendar';
            const calendar = document.getElementById(calendarId);
            const weekInfo = document.getElementById(isProvider ? 'weekInfoProvider' : 'weekInfoCustomer');
            
            weekInfo.textContent = formatWeekInfo(dates);
            
            if (isProvider) {
                calendar.innerHTML = renderProviderCalendar(dates);
                attachProviderEvents();
            } else {
                // PC/ãƒ¢ãƒã‚¤ãƒ«å•ã‚ãš15åˆ†ã‚°ãƒªãƒƒãƒ‰ã§è¡¨ç¤º
                calendar.innerHTML = renderCustomerCalendarMobile(dates);
                attachCustomerEvents();
            }
        }

        // æ–½è¡“è€…ç”»é¢ - 15åˆ†åˆ»ã¿å…¨è¡¨ç¤º
        function renderProviderCalendar(dates) {
            const slots = getTimeSlots();
            const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            
            let html = '<thead><tr><th>æ™‚é–“</th>';
            dates.forEach((date, i) => {
                html += `<th class="date-header">
                    <span class="day-name">${dayNames[i]}</span>
                    <span class="date-num">${formatDateDisplay(date)}</span>
                    <button class="block-all-btn" data-date="${formatDate(date)}">çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯</button>
                </th>`;
            });
            html += '</tr></thead><tbody>';
            
            slots.slice(0, -1).forEach(time => {
                html += `<tr><td class="time-label">${time}</td>`;
                dates.forEach(date => {
                    html += renderProviderTimeSlot(date, time);
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            return html;
        }

        // æ–½è¡“è€…ç”»é¢ - å€‹åˆ¥ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ
        function renderProviderTimeSlot(date, time) {
            const dateStr = formatDate(date);
            const displayDate = formatDateDisplay(date);
            const blocked = isBlocked(date, time);
            const booking = getBookingAtSlot(date, time);
            
            let className = 'time-slot';
            let content = '';
            let dataAttrs = `data-date="${dateStr}" data-time="${time}"`;
            let title = '';
            
            if (booking) {
                const slotMinutes = timeToMinutes(time);
                const startM = timeToMinutes(booking.startTime);
                const endM = timeToMinutes(booking.endTime);
                const coreStartM = timeToMinutes(booking.coreStartTime || booking.startTime);
                const coreEndM = timeToMinutes(booking.coreEndTime || booking.endTime);
                if (booking.status === 'pending') {
                    if (slotMinutes >= startM && slotMinutes < endM) {
                        if (slotMinutes >= coreStartM && slotMinutes < coreEndM) {
                            className += ' pending';
                            content = 'æ‰¿èªå¾…ã¡';
                            title = `æ‰¿èªå¾…ã¡ï¼šæ–½è¡“ ${booking.coreStartTime || booking.startTime}ã€œ${booking.coreEndTime || booking.endTime}`;
                        } else {
                            className += ' blocked';
                            content = 'ãƒ–ãƒ­ãƒƒã‚¯';
                            title = `ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ‰¿èªå¾…ã¡äºˆç´„ã®å‰å¾Œï¼‰`;
                        }
                    }
                } else if (booking.status === 'confirmed') {
                    if (slotMinutes >= startM && slotMinutes < endM) {
                        if (slotMinutes >= coreStartM && slotMinutes < coreEndM) {
                            className += ' confirmed';
                            content = 'äºˆç´„æ¸ˆ';
                            title = `äºˆç´„æ¸ˆã¿ï¼šæ–½è¡“ ${booking.coreStartTime || booking.startTime}ã€œ${booking.coreEndTime || booking.endTime}`;
                        } else {
                            className += ' blocked';
                            content = 'ãƒ–ãƒ­ãƒƒã‚¯';
                            title = `ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆäºˆç´„ã®å‰å¾Œï¼‰`;
                        }
                    }
                } else if (booking.status === 'rejected') {
                    className += ' rejected';
                    content = 'ä¸æ‰¿èª';
                    title = 'ä¸æ‰¿èª';
                }
                dataAttrs += ` data-booking-id="${booking.id}"`;
            } else if (blocked) {
                className += ' blocked removable';
                content = 'Ã—';
                title = 'ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆæ‰‹å‹•ï¼‰â€”ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤';
            } else {
                className += ' available';
                content = 'â—‹';
                title = 'å—ä»˜å¯èƒ½â€”ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š';
            }
            
            return `<td><div class="${className}" ${dataAttrs} title="${title}">${content}</div></td>`;
        }

        // åˆ©ç”¨è€…ç”»é¢ - 1æ™‚é–“å˜ä½+å±•é–‹
        function renderCustomerCalendar(dates) {
            const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            
            let html = '<thead><tr><th>æ™‚é–“</th>';
            dates.forEach((date, i) => {
                html += `<th>${dayNames[i]}<br>${formatDateDisplay(date)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // 1æ™‚é–“å˜ä½ã§æç”»
            for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                html += `<tr><td class="time-label">${hour}:00~</td>`;
                dates.forEach(date => {
                    html += renderCustomerHourSlot(date, hour);
                });
                html += '</tr>';
            }
            
            html += '</tbody>';
            return html;
        }

        // åˆ©ç”¨è€…ç”»é¢ - 1æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆ
        function renderCustomerHourSlot(date, hour) {
            const dateStr = formatDate(date);
            const status = getHourSlotStatus(date, hour);
            
            let statusIcon = '';
            let statusClass = '';
            let clickable = false;
            
            if (status === 'available') {
                statusIcon = 'â—‹';
                statusClass = 'available';
                clickable = true;
            } else if (status === 'partial') {
                statusIcon = 'â–³';
                statusClass = 'partial';
                clickable = true;
            } else if (status === 'full') {
                statusIcon = 'Ã—';
                statusClass = 'full';
                clickable = false;
            } else {
                statusIcon = '-';
                statusClass = 'unavailable';
                clickable = false;
            }
            
            const headerClass = clickable ? 'hour-header clickable' : 'hour-header disabled';
            const expandIcon = clickable ? '<span class="expand-icon">â–¼</span>' : '';
            
            let html = `
                <td>
                    <div class="hour-row-wrapper" data-date="${dateStr}" data-hour="${hour}">
                        <div class="${headerClass}" ${clickable ? `onclick="toggleHourSlot(this)"` : ''}>
                            <span class="status-icon ${statusClass}">${statusIcon}</span>
                            ${expandIcon}
                        </div>
                        ${clickable ? renderQuarterSlots(date, hour) : ''}
                    </div>
                </td>
            `;
            
            return html;
        }

        // 15åˆ†åˆ»ã¿ã‚¹ãƒ­ãƒƒãƒˆ(å±•é–‹æ™‚)
        function renderQuarterSlots(date, hour) {
            const quarters = [0, 15, 30, 45];
            const duration = getMenuDuration(selectedMenu);
            
            let html = '<div class="quarter-slots">';
            
            quarters.forEach(min => {
                const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                const dateStr = formatDate(date);
                
                let className = 'quarter-slot';
                let content = `â—‹`;
                let onclick = '';
                
                if (canBook(date, time, duration)) {
                    className += ' available';
                    onclick = `onclick=\"handleCustomerSlotClick('${dateStr}', '${time}')\"`;
                    html += `<div class="${className}" ${onclick} title="â—‹ äºˆç´„å¯èƒ½">${content}</div>`;
                } else {
                    className += ' blocked';
                    content = `Ã—`;
                    html += `<div class="${className}" title="Ã— äºˆç´„ä¸å¯ï¼ˆå‰å¾Œãƒ–ãƒ­ãƒƒã‚¯ã‚’å«ã‚ã¦ãƒã‚§ãƒƒã‚¯ï¼‰">${content}</div>`;
                }
            });
            
            html += '</div>';
            return html;
        }

        // ãƒ¢ãƒã‚¤ãƒ«ç”¨: ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼é¢¨ï¼ˆ15åˆ†ã‚°ãƒªãƒƒãƒ‰ï¼‰
        function renderCustomerCalendarMobile(dates) {
            const slots = getTimeSlots();
            const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            let html = '<table class="hp-table">';
            html += '<thead><tr><th class="hp-time">æ—¥æ™‚</th>';
            dates.forEach((date, i) => {
                html += `<th>${dayNames[i]}<br>${formatDateDisplay(date)}</th>`;
            });
            html += '</tr></thead><tbody>';
            const duration = selectedMenu ? getMenuDuration(selectedMenu) : null;
            slots.slice(0, -1).forEach(time => {
                html += `<tr>`;
                html += `<td class="hp-time">${time}</td>`;
                dates.forEach(date => {
                    let inner = '-';
                    if (selectedMenu) {
                        if (canBook(date, time, duration)) {
                            inner = `<div class=\"hp-cell available\" onclick=\"handleCustomerSlotClick('${formatDate(date)}','${time}')\">â—‹</div>`;
                        } else {
                            inner = `<div class=\"hp-cell blocked\">Ã—</div>`;
                        }
                    } else {
                        inner = `<div class=\"hp-cell\">-</div>`;
                    }
                    html += `<td class=\"hp-slot\">${inner}</td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';
            // ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰
            return `<div class=\"hp-calendar\">${html}</div>`;
        }

        // 1æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
        function toggleHourSlot(headerElement) {
            const wrapper = headerElement.closest('.hour-row-wrapper');
            const isExpanded = wrapper.classList.contains('expanded');
            
            // å…¨ã¦ã®ä»–ã®è¡Œã‚’é–‰ã˜ã‚‹(ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³)
            document.querySelectorAll('.hour-row-wrapper.expanded').forEach(w => {
                if (w !== wrapper) {
                    w.classList.remove('expanded');
                }
            });
            
            // ç¾åœ¨ã®è¡Œã‚’ãƒˆã‚°ãƒ«
            if (isExpanded) {
                wrapper.classList.remove('expanded');
            } else {
                wrapper.classList.add('expanded');
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => {
                    const quarterSlots = wrapper.querySelector('.quarter-slots');
                    if (quarterSlots) {
                        quarterSlots.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest' 
                        });
                    }
                }, 100);
            }
        }

        // åˆ©ç”¨è€… - ã‚¹ãƒ­ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯
        function handleCustomerSlotClick(date, time) {
            if (!selectedMenu) {
                alert('æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            showBookingModal(date, time);
        }

        // æ–½è¡“è€…ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ
        function attachProviderEvents() {
            const slots = document.querySelectorAll('#provider-content .time-slot');
            
            slots.forEach(slot => {
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                slot.addEventListener('mousedown', handleDragStart);
                slot.addEventListener('mouseenter', handleDragOver);
                slot.addEventListener('mouseup', handleDragEnd);
                // ã‚¿ãƒƒãƒå¯¾å¿œï¼ˆé•·æŠ¼ã—â†’ãƒ‰ãƒ©ãƒƒã‚°ï¼‰
                slot.addEventListener('touchstart', handleTouchStart, { passive: false });
                slot.addEventListener('touchmove', handleTouchMove, { passive: false });
                slot.addEventListener('touchend', handleTouchEnd);
                
                // æ‰¿èªå¾…ã¡ã‚¯ãƒªãƒƒã‚¯
                if (slot.classList.contains('pending')) {
                    slot.addEventListener('click', handlePendingClick);
                }
                // äºˆç´„æ¸ˆã¿ã‚¯ãƒªãƒƒã‚¯ï¼ˆé¡§å®¢æƒ…å ±ãƒãƒƒãƒ—ï¼‰
                if (slot.classList.contains('confirmed')) {
                    slot.addEventListener('click', handleConfirmedClick);
                }
                
                // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
                if (slot.classList.contains('removable')) {
                    slot.addEventListener('click', handleBlockRemove);
                }
            });

            // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³
            const blockAllBtns = document.querySelectorAll('.block-all-btn');
            blockAllBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleBlockAllDay(btn.dataset.date);
                });
            });

            // ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ
            const openQuick = document.getElementById('openQuickBlockSheet');
            if (openQuick) {
                openQuick.addEventListener('click', openQuickBlockSheet);
            }
        }

        // åˆ©ç”¨è€…ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ(æ—¢ã«onclickå±æ€§ã§è¨­å®šæ¸ˆã¿)
        function attachCustomerEvents() {
            // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        }

        // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆ1æ æ¯ã«è§£é™¤ï¼‰
        function handleBlockRemove(e) {
            e.stopPropagation();
            const slot = e.target;
            const date = slot.dataset.date;
            const time = slot.dataset.time;
            
            const timeMinutes = timeToMinutes(time);
            const newBlocks = [];
            
            blocks.forEach(block => {
                if (block.date !== date) {
                    newBlocks.push(block);
                    return;
                }
                
                const blockStart = timeToMinutes(block.startTime);
                const blockEnd = timeToMinutes(block.endTime);
                
                // ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚é–“æ ãŒã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (timeMinutes >= blockStart && timeMinutes < blockEnd) {
                    // ãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ†å‰²ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸ1æ ã ã‘ã‚’é™¤å¤–
                    if (blockStart < timeMinutes) {
                        // å‰åŠã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ 
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: block.startTime,
                            endTime: time
                        });
                    }
                    if (timeMinutes + INTERVAL < blockEnd) {
                        // å¾ŒåŠã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ 
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: minutesToTime(timeMinutes + INTERVAL),
                            endTime: block.endTime
                        });
                    }
                    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸ1æ ï¼ˆtimeMinutes ã‹ã‚‰ timeMinutes + INTERVALï¼‰ã¯è¿½åŠ ã—ãªã„ï¼ˆè§£é™¤ã•ã‚Œã‚‹ï¼‰
                } else {
                    // å¯¾è±¡å¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ãã®ã¾ã¾è¿½åŠ 
                    newBlocks.push(block);
                }
            });
            
            blocks = newBlocks;
            renderCalendar(true);
            renderCalendar(false);
        }

        // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯
        function handleBlockAllDay(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const displayDate = `${month}/${day}`;
            
            if (!confirm(`${displayDate}ã‚’çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹?`)) {
                return;
            }
            
            blocks = blocks.filter(block => block.date !== dateStr);
            
            blocks.push({
                id: Date.now(),
                date: dateStr,
                startTime: `${String(START_HOUR).padStart(2, '0')}:00`,
                endTime: `${String(END_HOUR).padStart(2, '0')}:00`
            });
            
            renderCalendar(true);
            renderCalendar(false);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        function handleDragStart(e) {
            const slot = e.target;
            // pending, confirmedã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
            // blockedï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ï¼‰ã¯removableï¼ˆè§£é™¤å¯èƒ½ï¼‰ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°å¯
            if (slot.classList.contains('pending') || 
                slot.classList.contains('confirmed') ||
                (slot.classList.contains('blocked') && !slot.classList.contains('removable'))) {
                return;
            }
            
            isDragging = true;
            dragStart = { date: slot.dataset.date, time: slot.dataset.time };
            slot.classList.add('dragging');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleDragOver(e) {
            if (!isDragging) return;
            const slot = e.target;
            if (!slot.classList.contains('time-slot')) return;
            // pending, confirmedã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
            // blockedï¼ˆãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ï¼‰ã¯removableï¼ˆè§£é™¤å¯èƒ½ï¼‰ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°å¯
            if (slot.classList.contains('pending') || 
                slot.classList.contains('confirmed') ||
                (slot.classList.contains('blocked') && !slot.classList.contains('removable'))) {
                return;
            }
            
            slot.classList.add('dragging');
        }

        // ç¯„å›²å†…ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹
        function removeBlocksInRange(dateStr, startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            // ç¯„å›²å†…ã®ã™ã¹ã¦ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€åº¦ã«å‡¦ç†
            const newBlocks = [];
            
            blocks.forEach(block => {
                if (block.date !== dateStr) {
                    // åˆ¥ã®æ—¥ä»˜ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ãã®ã¾ã¾è¿½åŠ 
                    newBlocks.push(block);
                    return;
                }
                
                const blockStart = timeToMinutes(block.startTime);
                const blockEnd = timeToMinutes(block.endTime);
                
                // ãƒ–ãƒ­ãƒƒã‚¯ã¨ç¯„å›²ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
                const overlapStart = Math.max(blockStart, startMinutes);
                const overlapEnd = Math.min(blockEnd, endMinutes);
                
                if (overlapStart < overlapEnd) {
                    // ãƒ–ãƒ­ãƒƒã‚¯ã¨ç¯„å›²ãŒé‡è¤‡ã—ã¦ã„ã‚‹
                    // ãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ†å‰²ã—ã¦ã€é‡è¤‡éƒ¨åˆ†ã‚’é™¤å¤–
                    if (blockStart < overlapStart) {
                        // å‰åŠã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆç¯„å›²ã®å‰ã®éƒ¨åˆ†ï¼‰
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: block.startTime,
                            endTime: minutesToTime(overlapStart)
                        });
                    }
                    if (overlapEnd < blockEnd) {
                        // å¾ŒåŠã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆç¯„å›²ã®å¾Œã®éƒ¨åˆ†ï¼‰
                        newBlocks.push({
                            id: Date.now() + Math.random() + 1,
                            date: block.date,
                            startTime: minutesToTime(overlapEnd),
                            endTime: block.endTime
                        });
                    }
                    // é‡è¤‡éƒ¨åˆ†ï¼ˆoverlapStart ã‹ã‚‰ overlapEndï¼‰ã¯è¿½åŠ ã—ãªã„ï¼ˆè§£é™¤ã•ã‚Œã‚‹ï¼‰
                } else {
                    // ãƒ–ãƒ­ãƒƒã‚¯ã¨ç¯„å›²ãŒé‡è¤‡ã—ã¦ã„ãªã„å ´åˆã¯ãã®ã¾ã¾è¿½åŠ 
                    newBlocks.push(block);
                }
            });
            
            blocks = newBlocks;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd(e) {
            if (!isDragging) return;
            
            const slot = e.target;
            if (!slot.classList.contains('time-slot')) {
                isDragging = false;
                clearDragging();
                return;
            }
            
            dragEnd = { date: slot.dataset.date, time: slot.dataset.time };
            
            if (dragStart.date !== dragEnd.date) {
                alert('åŒã˜æ—¥ä»˜å†…ã§ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã§ãã¾ã™');
                isDragging = false;
                clearDragging();
                return;
            }
            
            let startTime = dragStart.time;
            let endTime = dragEnd.time;
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            if (startMinutes > endMinutes) {
                [startTime, endTime] = [endTime, startTime];
            }
            
            // çµ‚äº†æ™‚é–“ã‚’æ¬¡ã®ã‚¹ãƒ­ãƒƒãƒˆã®é–‹å§‹æ™‚é–“ã«èª¿æ•´ï¼ˆ15åˆ†åˆ»ã¿ã®æœ€å¾Œã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å«ã‚€ï¼‰
            const actualEndMinutes = timeToMinutes(endTime) + INTERVAL;
            const actualEndTime = minutesToTime(actualEndMinutes);
            
            // ç¯„å›²å†…ãŒã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (isAllBlockedInRange(dragStart.date, startTime, actualEndTime)) {
                // ã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ãªã®ã§è§£é™¤
                removeBlocksInRange(dragStart.date, startTime, actualEndTime);
                renderCalendar(true);
                renderCalendar(false);
            } else {
                // ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                dragEnd = { date: dragStart.date, time: endTime };
                showBlockModal();
            }
            
            isDragging = false;
        }

        // ã‚¿ãƒƒãƒ: é•·æŠ¼ã—é–‹å§‹
        function handleTouchStart(e) {
            const slot = e.currentTarget;
            // pending, confirmedã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯
            if (slot.classList.contains('pending') || slot.classList.contains('confirmed')) return;
            if (slot.classList.contains('blocked') && !slot.classList.contains('removable')) return;
            if (touchLongPressTimer) clearTimeout(touchLongPressTimer);
            lastTouchSlot = null;
            isTouchDragging = false;
            touchLongPressTimer = setTimeout(() => {
                isTouchDragging = true;
                isDragging = true;
                dragStart = { date: slot.dataset.date, time: slot.dataset.time };
                slot.classList.add('dragging');
            }, 450);
        }

        // ã‚¿ãƒƒãƒ: ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleTouchMove(e) {
            if (!isTouchDragging) {
                if (touchLongPressTimer) e.preventDefault(); // é•·æŠ¼ã—åˆ¤å®šä¸­ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŠ‘æ­¢
                return;
            }
            e.preventDefault();
            const touch = e.touches[0];
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (!el) return;
            const slot = el.closest && el.closest('.time-slot');
            if (!slot) return;
            if (slot.dataset.date !== dragStart.date) return;
            if (slot.classList.contains('pending') || slot.classList.contains('confirmed')) return;
            if (slot.classList.contains('blocked') && !slot.classList.contains('removable')) return;
            if (lastTouchSlot === slot) return;
            lastTouchSlot = slot;
            slot.classList.add('dragging');
        }

        // ã‚¿ãƒƒãƒ: çµ‚äº†
        function handleTouchEnd() {
            if (touchLongPressTimer) {
                clearTimeout(touchLongPressTimer);
                touchLongPressTimer = null;
            }
            if (!isTouchDragging) return; // é•·æŠ¼ã—ã§ãªã‘ã‚Œã°ç„¡è¦–
            isTouchDragging = false;
            if (!isDragging) return;
            const slot = lastTouchSlot;
            if (!dragStart || !slot) { clearDragging(); isDragging = false; dragStart = null; dragEnd = null; return; }
            dragEnd = { date: slot.dataset.date, time: slot.dataset.time };
            if (dragStart.date !== dragEnd.date) {
                alert('åŒã˜æ—¥ä»˜å†…ã§ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã§ãã¾ã™');
                isDragging = false;
                clearDragging();
                dragStart = null; dragEnd = null;
                return;
            }
            let startTime = dragStart.time;
            let endTime = dragEnd.time;
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            if (startMinutes > endMinutes) [startTime, endTime] = [endTime, startTime];
            const actualEndMinutes = timeToMinutes(endTime) + INTERVAL;
            const actualEndTime = minutesToTime(actualEndMinutes);
            if (isAllBlockedInRange(dragStart.date, startTime, actualEndTime)) {
                removeBlocksInRange(dragStart.date, startTime, actualEndTime);
                renderCalendar(true);
                renderCalendar(false);
            } else {
                dragEnd = { date: dragStart.date, time: endTime };
                showBlockModal();
            }
            isDragging = false;
            clearDragging();
        }

        function clearDragging() {
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBlockModal() {
            const modal = document.getElementById('blockModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === dragStart.date);
            
            const startTime = dragStart.time;
            const endTime = dragEnd ? dragEnd.time : startTime;
            // ãƒ‰ãƒ©ãƒƒã‚°ã—ãŸç¯„å›²ã‚’åˆæœŸå€¤ã¨ã—ã¦ä½¿ç”¨
            const duration = (timeToMinutes(endTime) - timeToMinutes(startTime) + INTERVAL);
            
            document.getElementById('blockDateTime').textContent = 
                `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${startTime}ã€œ`;
            document.getElementById('blockDuration').value = duration;
            
            selectedBlockSlot = { date: dragStart.date, startTime, duration };
            openModal(modal, { primary: confirmBlock });
            clearDragging();
        }

        function closeBlockModal() {
            document.getElementById('blockModal').classList.remove('active');
            selectedBlockSlot = null;
            clearDragging();
            document.body.style.overflow = '';
        }

        function confirmBlock() {
            if (!selectedBlockSlot) return;
            
            const duration = parseInt(document.getElementById('blockDuration').value);
            const startMinutes = timeToMinutes(selectedBlockSlot.startTime);
            const endMinutes = Math.min(startMinutes + duration, END_HOUR * 60);
            const endTime = minutesToTime(endMinutes);
            
            if (startMinutes + duration > END_HOUR * 60) {
                alert(`å–¶æ¥­æ™‚é–“ã¯${END_HOUR}:00ã¾ã§ã§ã™ã€‚ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’${endTime}ã¾ã§èª¿æ•´ã—ã¾ã—ãŸã€‚`);
            }
            
            blocks.push({
                id: Date.now(),
                date: selectedBlockSlot.date,
                startTime: selectedBlockSlot.startTime,
                endTime: endTime
            });
            
            closeBlockModal();
            renderCalendar(true);
            renderCalendar(false);
            persistState();
        }

        // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBookingModal(date, time) {
            const modal = document.getElementById('bookingModal');
            const dates = getWeekDates(currentWeek);
            const dateObj = dates.find(d => formatDate(d) === date);
            const duration = getMenuDuration(selectedMenu);
            const menuName = selectedMenu === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';

            document.getElementById('bookingMenu').textContent = `${menuName}(${duration}åˆ†)`;
            document.getElementById('bookingDateTime').textContent = 
                `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dateObj.getDay()]})${time}ã€œ${minutesToTime(timeToMinutes(time) + duration)}`;
            document.getElementById('bookingDuration').textContent = `${duration}åˆ†`;
            
            selectedBookingId = { date, time, menuId: selectedMenu, duration };
            openModal(modal, { primary: confirmBooking });
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            selectedBookingId = null;
            document.body.style.overflow = '';
        }

        function confirmBooking() {
            if (!selectedBookingId) return;
            
            const { date, time, menuId, duration } = selectedBookingId;
            const startMinutes = timeToMinutes(time);
            const bufferDuration = defaultBlockDurationApplied;
            const isFirstSlot = startMinutes === START_HOUR * 60;
            const isLastSlot = startMinutes + duration + bufferDuration > END_HOUR * 60;
            const actualStart = isFirstSlot ? startMinutes : startMinutes - bufferDuration;
            const actualEnd = isLastSlot ? startMinutes + duration : startMinutes + duration + bufferDuration;
            const coreStart = startMinutes;
            const coreEnd = startMinutes + duration;
            
            // äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆæ‰¿èªå¾…ã¡ï¼‰ã‚’ä½œæˆ
            const booking = {
                id: Date.now(),
                date: date,
                startTime: minutesToTime(actualStart),
                endTime: minutesToTime(actualEnd),
                coreStartTime: minutesToTime(coreStart),
                coreEndTime: minutesToTime(coreEnd),
                bufferDuration: bufferDuration,
                menuId: menuId,
                status: 'pending',
                comment: '',
                
                // ç°¡æ˜“ãªé¡§å®¢æƒ…å ±ï¼ˆæœ¬ç•ªã§ã¯äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å–å¾—ï¼‰
                customerName: 'ã‚²ã‚¹ãƒˆ',
                customerContact: 'æœªç™»éŒ²',
                customerDetailUrl: `https://example.com/customers?bookingId=${Date.now()}`
            };
            bookings.push(booking);
            
            closeBookingModal();
            renderCalendar(true);
            renderCalendar(false);
            updatePendingBadge();
            persistState();
        }

        // æ‰¿èªå¾…ã¡ã‚¯ãƒªãƒƒã‚¯
        function handlePendingClick(e) {
            const slot = e.target;
            const bookingId = parseInt(slot.dataset.bookingId);
            const booking = bookings.find(b => b.id === bookingId);
            
            if (booking) {
                showApprovalModal(booking);
            }
        }

        // äºˆç´„æ¸ˆã¿ã‚¯ãƒªãƒƒã‚¯ -> é¡§å®¢æƒ…å ±ãƒãƒƒãƒ—
        function handleConfirmedClick(e) {
            const slot = e.target;
            const bookingId = parseInt(slot.dataset.bookingId);
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            showCustomerInfoModal(booking);
        }

        // æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ«
        function showApprovalModal(booking) {
            const modal = document.getElementById('approvalModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === booking.date);
            const menuName = booking.menuId === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';
            const duration = getMenuDuration(booking.menuId);
            
            document.getElementById('approvalMenu').textContent = `${menuName}(${duration}åˆ†)`;
            document.getElementById('approvalDateTime').textContent = 
                `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]})${booking.startTime}ã€œ`;
            document.getElementById('approvalCoreTime').textContent = `${booking.coreStartTime || booking.startTime}ã€œ${booking.coreEndTime || booking.endTime}`;
            // ä»•æ§˜ã«åŸºã¥ãå‰å¾Œãƒ–ãƒ­ãƒƒã‚¯ã®è£œåŠ©è¡¨ç¤ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ«ã®UIæ—¢å­˜é …ç›®ã«è¿½è¨˜ï¼‰
            // è¡¨ç¤ºç”¨ã®è£œè¶³ã‚’ approvalDateTime ã®å¾Œã«æ‹¬å¼§ä»˜ãã§è¡¨ç¤º
            try {
                const hasFront = (booking.coreStartTime || booking.startTime) !== booking.startTime;
                const hasBack = (booking.coreEndTime || booking.endTime) !== booking.endTime;
                const frontText = hasFront ? `${booking.startTime}ã€œ${booking.coreStartTime || booking.startTime}` : 'ãªã—';
                const backText = hasBack ? `${booking.coreEndTime || booking.endTime}ã€œ${booking.endTime}` : 'ãªã—';
                // æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã¯ãã®ã¾ã¾ã«ã—ã€æ—¥æ™‚ãƒ©ãƒ™ãƒ«ã®æœ«å°¾ã«ç°¡æ˜“è¡¨ç¤ºã‚’ä»˜ä¸
                const dtEl = document.getElementById('approvalDateTime');
                if (dtEl && !dtEl.dataset.buffAppended) {
                    const baseText = dtEl.textContent;
                    dtEl.innerHTML = `${baseText}<br><span class="sub-info">å‰å¾Œãƒ–ãƒ­ãƒƒã‚¯: å‰:${frontText} / å¾Œ:${backText}</span>`;
                    dtEl.dataset.buffAppended = '1';
                }
            } catch (e) {}
            document.getElementById('approvalComment').value = '';
            
            selectedBookingId = booking.id;
            openModal(modal, {});
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').classList.remove('active');
            selectedBookingId = null;
            document.body.style.overflow = '';
        }

        function approveBooking() {
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (booking) {
                booking.status = 'confirmed';
                booking.comment = document.getElementById('approvalComment').value;
                closeApprovalModal();
                renderCalendar(true);
                renderCalendar(false);
                updatePendingBadge();
                alert('äºˆç´„ã‚’æ‰¿èªã—ã¾ã—ãŸ');
                persistState();
            }
        }

        function rejectBooking() {
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (booking) {
                booking.status = 'rejected';
                booking.comment = document.getElementById('approvalComment').value;
                closeApprovalModal();
                renderCalendar(true);
                renderCalendar(false);
                updatePendingBadge();
                alert('äºˆç´„ã‚’ä¸æ‰¿èªã«ã—ã¾ã—ãŸ');
                persistState();
            }
        }

        // é¡§å®¢æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showCustomerInfoModal(booking) {
            const modal = document.getElementById('customerInfoModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === booking.date);
            const menuName = booking.menuId === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';
            document.getElementById('ciName').textContent = booking.customerName || 'ä¸æ˜';
            document.getElementById('ciContact').textContent = booking.customerContact || 'ä¸æ˜';
            document.getElementById('ciMenu').textContent = menuName;
            document.getElementById('ciDateTime').textContent = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${booking.startTime}ã€œ${booking.endTime}`;
            const link = document.getElementById('customerInfoLink');
            const url = booking.customerDetailUrl || `https://example.com/customers?bookingId=${booking.id}`;
            link.href = url;
            openModal(modal, {});
        }

        function closeCustomerInfoModal() {
            document.getElementById('customerInfoModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ãƒãƒƒã‚¸æ›´æ–°
        function updatePendingBadge() {
            const dates = getWeekDates(currentWeek);
            const weekDates = dates.map(d => formatDate(d));
            
            const count = bookings.filter(b => 
                b.status === 'pending' && weekDates.includes(b.date)
            ).length;
            
            const badge = document.getElementById('pendingBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                renderCalendar(tabName === 'provider');
            });
        });

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ
        document.querySelectorAll('.menu-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.menu-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedMenu = parseInt(option.dataset.menu);
                renderCalendar(false);
            });
        });

        

        // é€±ç§»å‹•
        document.getElementById('prevWeekProvider').addEventListener('click', () => {
            currentWeek--;
            renderCalendar(true);
            updatePendingBadge();
        });

        document.getElementById('nextWeekProvider').addEventListener('click', () => {
            currentWeek++;
            renderCalendar(true);
            updatePendingBadge();
        });

        document.getElementById('prevWeekCustomer').addEventListener('click', () => {
            currentWeek--;
            renderCalendar(false);
            updatePendingBadge();
        });

        document.getElementById('nextWeekCustomer').addEventListener('click', () => {
            currentWeek++;
            renderCalendar(false);
            updatePendingBadge();
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                clearDragging();
            }
        });

        // å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ»Escé–‰ã˜ãƒ»Enter=ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š
        function openModal(modalEl, actions) {
            const content = modalEl.querySelector('.modal-content');
            const previouslyFocused = document.activeElement;
            function closeInternal() {
                modalEl.classList.remove('active');
                document.body.style.overflow = '';
                document.removeEventListener('keydown', onKeydown, true);
                if (previouslyFocused && previouslyFocused.focus) previouslyFocused.focus();
            }
            function onKeydown(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeInternal();
                } else if (e.key === 'Enter') {
                    const tag = (e.target && e.target.tagName || '').toLowerCase();
                    if (tag !== 'textarea') {
                        e.preventDefault();
                        if (actions && typeof actions.primary === 'function') actions.primary();
                        closeInternal();
                    }
                } else if (e.key === 'Tab') {
                    const focusables = content.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled'));
                    if (list.length === 0) return;
                    const first = list[0];
                    const last = list[list.length - 1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            }
            modalEl.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', onKeydown, true);
            // åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ä¸»è¦ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°ãã“ã¸ã€ãªã‘ã‚Œã°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸
            const primary = modalEl.querySelector('.modal-footer .btn-primary');
            setTimeout(() => { (primary || content).focus(); }, 0);
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆï¼‹ãƒœã‚¿ãƒ³â†’æ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆï¼‰
        function openQuickBlockSheet() {
            const sheet = document.getElementById('quickBlockSheet');
            const dateSelect = document.getElementById('quickBlockDate');
            const startSelect = document.getElementById('quickBlockStart');
            const durationSelect = document.getElementById('quickBlockDuration');
            // æ—¥ä»˜å€™è£œï¼ˆå½“é€±ï¼‰
            dateSelect.innerHTML = '';
            const dates = getWeekDates(currentWeek);
            dates.forEach(d => {
                const v = formatDate(d);
                const opt = document.createElement('option');
                opt.value = v; opt.textContent = `${d.getMonth()+1}/${d.getDate()} (${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]})`;
                dateSelect.appendChild(opt);
            });
            // é–‹å§‹æ™‚åˆ»å€™è£œï¼ˆ15åˆ†åˆ»ã¿ï¼‰
            startSelect.innerHTML = '';
            for (let h = START_HOUR; h <= END_HOUR; h++) {
                for (let m = 0; m < 60; m += INTERVAL) {
                    const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    const opt = document.createElement('option');
                    opt.value = t; opt.textContent = t;
                    startSelect.appendChild(opt);
                }
            }
            durationSelect.value = '15';
            const confirmBtn = document.getElementById('quickBlockConfirmBtn');
            const onConfirm = () => {
                const date = dateSelect.value;
                const start = startSelect.value;
                const duration = parseInt(durationSelect.value, 10);
                addBlock(date, start, duration);
                renderCalendar(true);
                renderCalendar(false);
                document.getElementById('quickBlockSheet').classList.remove('active');
                document.body.style.overflow = '';
            };
            confirmBtn.onclick = onConfirm;
            openModal(sheet, { primary: onConfirm });
        }

        function addBlock(dateStr, startTime, duration) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = Math.min(startMinutes + duration, END_HOUR * 60);
            const endTime = minutesToTime(endMinutes);
            if (startMinutes >= END_HOUR * 60) {
                alert(`å–¶æ¥­æ™‚é–“ã¯${END_HOUR}:00ã¾ã§ã§ã™`);
                return;
            }
            blocks.push({ id: Date.now(), date: dateStr, startTime, endTime });
            persistState && persistState();
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ­ãƒƒã‚¯è¨­å®šUIã®ãƒãƒ³ãƒ‰ãƒ©
        (function initBufferSettingUI(){
            const sel = document.getElementById('defaultBufferSelect');
            const applyBtn = document.getElementById('applyDefaultBufferBtn');
            const appliedText = document.getElementById('appliedBufferText');
            if (sel && applyBtn && appliedText) {
                // å¾©å…ƒå€¤åæ˜ 
                sel.value = String(defaultBlockDurationApplied);
                appliedText.textContent = String(defaultBlockDurationApplied);
                sel.addEventListener('change', () => {
                    defaultBlockDurationPending = parseInt(sel.value, 10);
                });
                applyBtn.addEventListener('click', () => {
                    defaultBlockDurationApplied = defaultBlockDurationPending;
                    appliedText.textContent = String(defaultBlockDurationApplied);
                    persistState();
                    // äºˆç´„å¯å¦ãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚å†æç”»
                    renderCalendar(false);
                });
            }
        })();

        // åˆæœŸåŒ–
        restoreState();
        // UIã¸åæ˜ ï¼ˆå¾©å…ƒå¾Œï¼‰
        (function syncBufferUI(){
            const sel = document.getElementById('defaultBufferSelect');
            const appliedText = document.getElementById('appliedBufferText');
            if (sel) sel.value = String(defaultBlockDurationApplied);
            if (appliedText) appliedText.textContent = String(defaultBlockDurationApplied);
        })();
        renderCalendar(true);
        renderCalendar(false);
        updatePendingBadge();
    </script>
</body>
</html>


