<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 32px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³(æ¤œè¨¼ç”¨) */
        .reset-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 8px 12px;
            background: #ffffff;
            color: #1565c0;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            background: #e3f2fd;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255,255,255,0.25);
        }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .tabs {
            display: flex;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            background: #fafafa;
            transition: all 0.3s ease;
            position: relative;
            color: #757575;
        }

        .tab:hover {
            background: #f5f5f5;
            color: #424242;
        }

        .tab.active {
            background: white;
            color: #1976d2;
            border-bottom: 3px solid #1976d2;
        }

        .tab .badge {
            position: absolute;
            top: 8px;
            right: 16px;
            background: #f44336;
            color: white;
            border-radius: 10px;
            padding: 3px 8px;
            font-size: 11px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€±ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: #f5f5f5;
            border-radius: 12px;
        }

        .week-nav button {
            padding: 10px 20px;
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .week-nav button:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
        }

        .week-nav .week-info {
            font-size: 18px;
            font-weight: 600;
            color: #424242;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ */
        .menu-selection {
            margin-bottom: 24px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 12px;
        }

        .menu-selection h3 {
            margin-bottom: 16px;
            color: #424242;
            font-size: 16px;
            font-weight: 600;
        }

        .menu-options {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .menu-option {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .menu-option:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(25, 118, 210, 0.12);
        }

        .menu-option.selected {
            border-color: #1976d2;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .menu-option .menu-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #212121;
        }

        .menu-option .menu-duration {
            font-size: 14px;
            color: #757575;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            overflow-x: auto;
            margin-top: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .calendar-table th {
            background: linear-gradient(180deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 14px 8px;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .calendar-table th:last-child {
            border-right: none;
        }

        .calendar-table th.date-header {
            padding: 8px;
            /* æ›œæ—¥é–¢ä¿‚ãªãçµ±ä¸€ã•ã‚ŒãŸè‰² */
            background: #1976d2;
            color: white;
        }

        .date-header .day-name {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .date-header .date-num {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
        }

        .date-header .block-all-btn {
            background: rgba(255,255,255,0.9);
            border: 2px solid #212121;
            color: #212121;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            width: 100%;
            font-weight: 600;
        }

        .date-header .block-all-btn:hover {
            background: white;
            border-color: #424242;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .calendar-table td {
            border: 1px solid #f0f0f0;
            padding: 0;
            text-align: center;
            vertical-align: middle;
        }

        .time-label {
            background: #fafafa;
            font-weight: 600;
            color: #616161;
            font-size: 13px;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 2px solid #e0e0e0;
            padding: 12px 8px;
        }

        /* ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ */
        .time-slot {
            height: 48px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            user-select: none;
            position: relative;
        }

        .time-slot.available {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
        }

        .time-slot.available:hover {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            transform: scale(1.02);
            box-shadow: inset 0 0 0 2px #4caf50;
        }

        .time-slot.blocked {
            background: #f5f5f5;
            color: #bdbdbd;
            cursor: not-allowed;
        }

        .time-slot.blocked.removable {
            cursor: pointer;
            position: relative;
        }

        .time-slot.blocked.removable:hover {
            background: #ffebee;
            color: #c62828;
        }

        .time-slot.blocked.removable:hover::after {
            content: 'è§£é™¤';
            position: absolute;
            font-size: 11px;
            bottom: 2px;
            right: 4px;
        }

        .time-slot.pending {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #ef6c00;
            font-size: 13px;
            animation: pendingPulse 2s infinite;
        }

        .time-slot.pending:hover {
            background: linear-gradient(135deg, #ffe0b2 0%, #ffcc80 100%);
            transform: scale(1.02);
        }

        @keyframes pendingPulse {
            0%, 100% { box-shadow: inset 0 0 0 2px transparent; }
            50% { box-shadow: inset 0 0 0 2px #ff9800; }
        }

        .time-slot.confirmed {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            font-size: 13px;
        }

        .time-slot.confirmed:hover {
            cursor: pointer;
        }

        .time-slot.interval {
            background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
            color: #6a1b9a;
            font-size: 11px;
            cursor: pointer;
            animation: intervalPulse 2s infinite;
        }

        .time-slot.interval:hover {
            background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%);
            transform: scale(1.02);
        }

        @keyframes intervalPulse {
            0%, 100% { box-shadow: inset 0 0 0 2px transparent; }
            50% { box-shadow: inset 0 0 0 2px #9c27b0; }
        }

        .time-slot.rejected {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            font-size: 13px;
        }

        .time-slot.dragging {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            box-shadow: inset 0 0 0 3px #fbc02d;
        }

        /* äºˆç´„é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤º */
        .interval-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 700;
            z-index: 10;
            pointer-events: none;
        }

        .interval-indicator.ok {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .interval-indicator.warning {
            background: #fff9c4;
            color: #f57c00;
        }

        .interval-indicator.error {
            background: #ffcdd2;
            color: #c62828;
        }

        /* åˆ©ç”¨è€…ç”»é¢ - 15åˆ†ã‚°ãƒªãƒƒãƒ‰ */
        .hp-calendar { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .hp-table { width: 100%; border-collapse: collapse; background: #fff; }
        .hp-table thead th { 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            background: #1976d2; 
            border-bottom: 1px solid #1565c0; 
            font-size: 13px; 
            padding: 10px 0; 
            color: white; 
        }
        
        .hp-table th, .hp-table td { border-right: 1px solid #f0f0f0; }
        .hp-table th:last-child, .hp-table td:last-child { border-right: none; }
        .hp-time { background: #fafafa; position: sticky; left: 0; z-index: 5; font-size: 13px; color: #616161; padding: 10px 8px; border-right: 1px solid #e0e0e0; }
        .hp-slot { height: 48px; text-align: center; vertical-align: middle; padding: 0; }
        .hp-cell { width: 100%; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; border-radius: 0; }
        .hp-cell.available { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #2e7d32; cursor: pointer; }
        .hp-cell.available:hover { background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%); box-shadow: inset 0 0 0 2px #4caf50; transform: scale(1.02); }
        .hp-cell.blocked { background: #f5f5f5; color: #bdbdbd; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 16px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 12px 48px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #212121;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-body .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-body .info-label {
            font-weight: 600;
            color: #757575;
            font-size: 14px;
        }

        .modal-body .info-value {
            color: #212121;
            font-weight: 500;
            font-size: 14px;
        }

        .modal-body .sub-info { 
            display: inline-block; 
            margin-top: 4px; 
            color: #757575; 
            font-size: 12px; 
        }

        .modal-body textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 8px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .modal-body textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            margin-top: 16px;
            font-weight: 600;
            color: #424242;
            font-size: 14px;
        }

        .modal-body select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .modal-body select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-footer button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #43a047;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #e53935;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #757575;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #bdbdbd;
        }

        /* èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ */
        .instructions {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border-left: 4px solid #1976d2;
        }

        .instructions h4 {
            margin-bottom: 12px;
            color: #1565c0;
            font-size: 15px;
            font-weight: 600;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin: 6px 0;
            color: #424242;
            font-size: 13px;
            line-height: 1.6;
        }

        /* å…±é€šãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .form-select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 14px; 
            font-family: inherit; 
            cursor: pointer; 
            transition: border-color 0.2s ease; 
            background: #fff; 
        }
        .form-select:focus { 
            outline: none; 
            border-color: #1976d2; 
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); 
        }
        .inline-controls { 
            display: flex; 
            gap: 12px; 
            align-items: center; 
            flex-wrap: wrap;
        }
        .inline-controls .status { 
            color: #424242; 
            font-size: 14px; 
        }

        /* å‡¡ä¾‹ */
        .legend { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            margin-top: 10px; 
            color: #616161; 
            font-size: 12px; 
        }
        .legend .item { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            background: #fafafa; 
            border: 1px solid #e0e0e0; 
            border-radius: 16px; 
            padding: 4px 10px; 
        }
        .legend .chip { 
            width: 14px; 
            height: 14px; 
            border-radius: 3px; 
            box-shadow: inset 0 0 0 2px rgba(0,0,0,0.04); 
        }
        .chip-ok { 
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); 
            border: 1px solid #a5d6a7; 
        }
        .chip-pending { 
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); 
            border: 1px solid #ffcc80; 
        }
        .chip-confirmed { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
            border: 1px solid #90caf9; 
        }
        .chip-block { 
            background: #f5f5f5; 
            border: 1px solid #e0e0e0; 
        }

        /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæ–½è¡“è€…ç”»é¢ã®ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“è¨­å®šï¼‰ */
        .two-column-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .setting-box {
            padding: 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .setting-box h4 {
            margin-bottom: 12px;
            color: #424242;
            font-size: 14px;
            font-weight: 600;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 22px;
            }

            .week-nav { 
                display: grid; 
                grid-template-columns: 1fr auto 1fr; 
                grid-template-areas: "date date date" "prev . next"; 
                row-gap: 8px; 
                align-items: center; 
                padding: 12px 14px; 
            }
            .week-nav .week-info { 
                grid-area: date; 
                text-align: center; 
                font-size: 14px; 
            }
            .week-nav button { 
                font-size: 12px; 
                padding: 8px 12px; 
            }
            #prevWeekProvider, #prevWeekCustomer { 
                grid-area: prev; 
                justify-self: start; 
            }
            #nextWeekProvider, #nextWeekCustomer { 
                grid-area: next; 
                justify-self: end; 
            }
            #openQuickBlockSheet { 
                grid-column: 1 / -1; 
                justify-self: stretch; 
            }

            .menu-options {
                flex-direction: column;
            }

            .calendar {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .calendar-table th {
                padding: 10px 4px;
                font-size: 12px;
            }
            .calendar-table th.date-header { 
                padding: 6px 4px;
                /* æ›œæ—¥é–¢ä¿‚ãªãçµ±ä¸€ã•ã‚ŒãŸè‰² */
                background: #1976d2;
                color: white;
            }
            .date-header .day-name { 
                font-size: 12px; 
            }
            .date-header .date-num { 
                font-size: 11px; 
            }
            .time-label {
                padding: 10px 6px;
                font-size: 12px;
            }

            .instructions { 
                padding: 12px 14px; 
                margin-bottom: 16px; 
            }
            .instructions h4 { 
                font-size: 14px; 
                margin-bottom: 8px; 
            }
            .instructions li { 
                font-size: 12px; 
                line-height: 1.5; 
            }

            .hp-calendar { 
                border-radius: 0; 
                box-shadow: none; 
            }
            .hp-table thead th { 
                position: sticky; 
                top: 0; 
                z-index: 10; 
                /* æ›œæ—¥é–¢ä¿‚ãªãçµ±ä¸€ã•ã‚ŒãŸè‰² */
                background: #1976d2;
                color: white;
                border-bottom: 1px solid #1565c0; 
                font-size: 12px; 
                padding: 6px 0; 
            }
            .hp-time { 
                background: #fafafa; 
                position: sticky; 
                left: 0; 
                z-index: 5; 
                font-size: 12px; 
                color: #616161; 
                padding: 8px 6px; 
                border-right: 1px solid #e0e0e0; 
            }
            .hp-slot { 
                height: 48px; 
            }

            .two-column-settings {
                grid-template-columns: 1fr;
            }

            .shift-dashboard {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "summary"
                    "actions";
                gap: 16px;
            }

            .shift-summary {
                grid-area: summary;
                order: 1;
            }

            .quick-actions {
                grid-area: actions;
                order: 2;
            }

            .shift-summary h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .summary-item {
                padding: 6px 0;
                font-size: 13px;
            }

            .summary-label,
            .summary-value {
                font-size: 13px;
            }

            .quick-actions h3 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .quick-actions button {
                padding: 10px;
                font-size: 13px;
                margin-bottom: 8px;
            }

            .shift-grid {
                gap: 4px;
                grid-template-columns: repeat(7, minmax(80px, 1fr));
                width: 100%;
            }

            .shift-day-header {
                padding: 8px 4px;
                font-size: 12px;
                position: sticky;
                top: 0;
                /* æ›œæ—¥é–¢ä¿‚ãªãçµ±ä¸€ã•ã‚ŒãŸè‰² */
                background: #1976d2;
                color: white;
                z-index: 1;
                border-bottom: 1px solid #1565c0;
            }

            .shift-day {
                padding: 6px 4px;
                min-height: 70px;
                aspect-ratio: auto;
            }

            .shift-date-num {
                font-size: 14px;
                margin-bottom: 2px;
            }

            .shift-time {
                font-size: 9px;
                line-height: 1.3;
                margin-top: 4px;
                word-break: break-word;
            }

            .shift-status {
                font-size: 10px;
                margin-top: 4px;
            }

            .shift-calendar {
                padding: 12px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .shift-calendar .shift-grid {
                min-width: 560px; /* 7åˆ— x 80px = 560px minimum */
            }

            .month-nav {
                flex-direction: column;
                gap: 12px;
            }

            .month-nav button {
                width: 100%;
                padding: 10px;
            }

            .month-info {
                font-size: 16px;
                text-align: center;
            }
        }

        /* ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ */
        .shift-dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .quick-actions {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 12px;
        }

        .quick-actions h3 {
            margin-bottom: 16px;
            color: #424242;
            font-size: 16px;
            font-weight: 600;
        }

        .quick-actions button {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .quick-actions button:hover {
            background: #1976d2;
            color: white;
        }

        .shift-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #1976d2;
        }

        .shift-summary h3 {
            margin-bottom: 16px;
            color: #1565c0;
            font-size: 16px;
            font-weight: 600;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #616161;
            font-size: 14px;
        }

        .summary-value {
            font-weight: 600;
            color: #212121;
            font-size: 14px;
        }

        .summary-value.warning {
            color: #f57c00;
        }

        /* ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .shift-calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-nav button {
            padding: 8px 16px;
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .month-nav button:hover {
            background: #1976d2;
            color: white;
        }

        .month-info {
            font-size: 20px;
            font-weight: 600;
            color: #424242;
        }

        .shift-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            min-width: 100%;
        }

        .shift-day-header {
            text-align: center;
            padding: 8px;
            font-weight: 600;
            color: white;
            font-size: 13px;
            /* æ›œæ—¥é–¢ä¿‚ãªãçµ±ä¸€ã•ã‚ŒãŸè‰² */
            background: #1976d2;
        }

        .shift-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .shift-day:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.12);
        }

        .shift-day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .shift-day.other-month:hover {
            border-color: #e0e0e0;
            transform: none;
            box-shadow: none;
        }

        .shift-day.has-shift {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4caf50;
        }

        .shift-day.no-shift {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border-color: #fbc02d;
        }

        .shift-day.off-day {
            background: #f5f5f5;
            border-color: #e0e0e0;
        }

        .shift-date-num {
            font-weight: 600;
            color: #212121;
            font-size: 16px;
        }

        .shift-time {
            font-size: 11px;
            color: #616161;
            text-align: center;
            margin-top: 4px;
        }

        .shift-status {
            font-size: 10px;
            text-align: center;
            margin-top: 4px;
            font-weight: 600;
        }

        .shift-status.working {
            color: #2e7d32;
        }

        .shift-status.off {
            color: #757575;
        }

        .shift-status.warning {
            color: #f57c00;
        }

        /* ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç† */
        .pattern-list {
            display: grid;
            gap: 16px;
        }

        .pattern-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .pattern-card:hover {
            border-color: #1976d2;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.12);
        }

        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pattern-name {
            font-size: 18px;
            font-weight: 600;
            color: #212121;
        }

        .pattern-actions {
            display: flex;
            gap: 8px;
        }

        .pattern-actions button {
            padding: 6px 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .pattern-actions button:hover {
            border-color: #1976d2;
            color: #1976d2;
        }

        .pattern-schedule {
            font-size: 13px;
            color: #616161;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #424242;
            font-size: 14px;
        }

        .form-group input[type="date"],
        .form-group input[type="text"],
        .form-group input[type="checkbox"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .time-range select {
            flex: 1;
        }

        .weekday-selector {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .weekday-checkbox {
            flex: 1;
            min-width: 0;
        }

        .weekday-checkbox input {
            display: none;
        }

        .weekday-checkbox label {
            display: block;
            padding: 10px;
            text-align: center;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: #616161;
        }

        .weekday-checkbox input:checked + label {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .pattern-schedule-editor {
            display: grid;
            gap: 12px;
        }

        .schedule-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            gap: 12px;
            align-items: center;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: #fafafa;
            transition: all 0.2s ease;
        }

        .schedule-row:hover {
            border-color: #1976d2;
            background: #fff;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
        }

        .schedule-row:last-child {
            margin-bottom: 0;
        }

        .schedule-row .weekday-label {
            font-weight: 600;
            color: #1976d2;
            font-size: 15px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(25, 118, 210, 0.1);
            display: inline-block;
            width: fit-content;
        }

        .schedule-row .time-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            width: 100%;
        }

        .schedule-row input[type="checkbox"] {
            margin-right: 8px;
        }

        .time-slot.blocked.auto {
            background: #fafafa;
            color: #e0e0e0;
            font-size: 14px;
        }

        .time-slot.blocked.no-shift {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            color: #f57c00;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>æ–½è¡“è€…ã¨åˆ©ç”¨è€…ã®ãƒãƒƒãƒãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å‹ãƒ–ãƒ­ãƒƒã‚¯æ©Ÿèƒ½æ­è¼‰)</p>
            <button class="reset-btn" onclick="resetData()" title="ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="tabs">
            <div class="tab" data-tab="shift">
                ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†
            </div>
            <div class="tab active" data-tab="provider">
                æ–½è¡“è€…ç”»é¢
                <span class="badge" id="pendingBadge" style="display: none;">0</span>
            </div>
            <div class="tab" data-tab="customer">
                åˆ©ç”¨è€…ç”»é¢
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content">
            <!-- ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢ -->
            <div class="tab-content" id="shift-content">
                <div class="instructions">
                    <h4>ğŸ“Œ ã‚·ãƒ•ãƒˆç®¡ç†æ©Ÿèƒ½ã«ã¤ã„ã¦</h4>
                    <ul>
                        <li>ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã™ã‚‹ã¨ã€å‹¤å‹™æ™‚é–“å¤–ãŒè‡ªå‹•çš„ã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™</li>
                        <li>å€‹åˆ¥ç™»éŒ²ãƒ»ä¸€æ‹¬ç™»éŒ²ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ã®3ã¤ã®æ–¹æ³•ã§è¨­å®šå¯èƒ½ã§ã™</li>
                        <li>ã‚·ãƒ•ãƒˆæœªç™»éŒ²æ—¥ã¯âš ï¸è­¦å‘Šãƒãƒ¼ã‚¯ã§è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                        <li>ç¨¼åƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿å­˜ã™ã‚‹ã¨ã€ç¹°ã‚Šè¿”ã—ã®è¨­å®šãŒç°¡å˜ã«ãªã‚Šã¾ã™</li>
                    </ul>
                </div>

                <div class="shift-dashboard">
                    <div class="quick-actions">
                        <h3>ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ</h3>
                        <button onclick="openShiftModal()">ğŸ“ å€‹åˆ¥ã‚·ãƒ•ãƒˆç™»éŒ²</button>
                        <button onclick="openBulkShiftModal()">ğŸ“‹ ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²</button>
                        <button onclick="openPatternApplyModal()">ğŸ”„ ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨</button>
                        <button onclick="openPatternManageModal()">âš™ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†</button>
                    </div>

                    <div class="shift-summary">
                        <h3>ä»Šæœˆã®ã‚·ãƒ•ãƒˆæ¦‚è¦</h3>
                        <div class="summary-item">
                            <span class="summary-label">ç™»éŒ²æ¸ˆ</span>
                            <span class="summary-value" id="summaryRegistered">0æ—¥</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">æœªç™»éŒ²</span>
                            <span class="summary-value warning" id="summaryUnregistered">0æ—¥</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">ä¼‘æ—¥</span>
                            <span class="summary-value" id="summaryOff">0æ—¥</span>
                        </div>
                    </div>
                </div>

                <div class="shift-calendar">
                    <div class="month-nav">
                        <button onclick="changeMonth(-1)">â† å‰æœˆ</button>
                        <div class="month-info" id="monthInfo"></div>
                        <button onclick="changeMonth(1)">æ¬¡æœˆ â†’</button>
                    </div>
                    <div class="shift-grid" id="shiftGrid"></div>
                </div>
            </div>

            <!-- æ–½è¡“è€…ç”»é¢ -->
            <div class="tab-content active" id="provider-content">
                <div class="instructions">
                    <h4>ğŸ“Œ ä½¿ã„æ–¹</h4>
                    <ul>
                        <li>ã€Œå—ä»˜å¯èƒ½ã€ã®æ™‚é–“æ ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¨­å®šã§ãã¾ã™</li>
                        <li>ã€ŒÃ—ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã®æ ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã§ãã¾ã™</li>
                        <li>æ—¥ä»˜ä¸‹ã®ã€Œçµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³ã§ä¸€æ—¥å…¨ä½“ã‚’ä¸€æ‹¬ãƒ–ãƒ­ãƒƒã‚¯ã§ãã¾ã™</li>
                        <li>ã‚ªãƒ¬ãƒ³ã‚¸ã®ã€Œæ‰¿èªå¾…ã¡ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨æ‰¿èª/ä¸æ‰¿èªã‚’é¸æŠã§ãã¾ã™</li>
                        <li>æ‰¿èªå¾Œã¯ã€äºˆç´„æ™‚é–“å¸¯ãŒã€Œäºˆç´„æ¸ˆã€ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™(äºˆç´„æ¸ˆã¿ã‚’ã‚¿ãƒƒãƒ—ã§é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º)</li>
                        <li><strong>ğŸ†• ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å‹ãƒ–ãƒ­ãƒƒã‚¯:</strong> å„äºˆç´„é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒè¨­å®šæ™‚é–“ä»¥ä¸Šç¢ºä¿ã•ã‚Œã¦ã„ã‚Œã°OK</li>
                        <li><strong>ğŸ†• è¨ªå•æ–½è¡“ãƒ»åº—èˆ—æ–½è¡“:</strong> ãã‚Œãã‚Œå€‹åˆ¥ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</li>
                        <li><strong>ğŸ†• äºˆç´„é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤º:</strong> äºˆç´„ã‚»ãƒ«ã®å³ä¸‹ã«ã€Œå‰â—‹åˆ†/å¾Œâ—‹åˆ†ã€ã¨å®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    </ul>
                </div>
                
                <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“è¨­å®š -->
                <div class="menu-selection" id="intervalSettingPanel">
                    <h3>äºˆç´„é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“è¨­å®š</h3>
                    <div class="two-column-settings">
                        <div class="setting-box">
                            <h4>ğŸš— è¨ªå•æ–½è¡“</h4>
                            <div class="inline-controls">
                                <select id="intervalVisitSelect" class="form-select" style="max-width:180px;">
                                    <option value="0">0åˆ†(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—)</option>
                                    <option value="15">15åˆ†</option>
                                    <option value="30" selected>30åˆ†</option>
                                    <option value="45">45åˆ†</option>
                                    <option value="60">60åˆ†</option>
                                    <option value="75">75åˆ†</option>
                                    <option value="90">90åˆ†</option>
                                    <option value="105">105åˆ†</option>
                                    <option value="120">120åˆ†</option>
                                </select>
                                <button class="btn-secondary" id="applyIntervalVisitBtn">é©ç”¨</button>
                            </div>
                            <div class="status" style="margin-top:8px;">é©ç”¨ä¸­: <span id="appliedIntervalVisitText">30</span>åˆ†</div>
                        </div>
                        
                        <div class="setting-box">
                            <h4>ğŸ  åº—èˆ—æ–½è¡“</h4>
                            <div class="inline-controls">
                                <select id="intervalStoreSelect" class="form-select" style="max-width:180px;">
                                    <option value="0" selected>0åˆ†(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—)</option>
                                    <option value="15">15åˆ†</option>
                                    <option value="30">30åˆ†</option>
                                </select>
                                <button class="btn-secondary" id="applyIntervalStoreBtn">é©ç”¨</button>
                            </div>
                            <div class="status" style="margin-top:8px;">é©ç”¨ä¸­: <span id="appliedIntervalStoreText">0</span>åˆ†</div>
                        </div>
                    </div>
                </div>

                <div class="week-nav">
                    <button id="prevWeekProvider">â† å‰é€±</button>
                    <div class="week-info" id="weekInfoProvider"></div>
                    <button id="nextWeekProvider">æ¬¡é€± â†’</button>
                    <button id="openQuickBlockSheet" class="btn-primary" style="margin-left:12px;">+ ãƒ–ãƒ­ãƒƒã‚¯</button>
                </div>

                <div class="calendar">
                    <table class="calendar-table" id="providerCalendar"></table>
                </div>
                <div class="legend" aria-hidden="false">
                    <span class="item"><span class="chip chip-ok"></span>å—ä»˜å¯èƒ½</span>
                    <span class="item"><span class="chip chip-pending"></span>æ‰¿èªå¾…ã¡(æ–½è¡“)</span>
                    <span class="item"><span class="chip chip-confirmed"></span>äºˆç´„æ¸ˆã¿(æ–½è¡“)</span>
                    <span class="item"><span class="chip chip-block"></span>ãƒ–ãƒ­ãƒƒã‚¯(æ‰‹å‹•)</span>
                </div>
            </div>

            <!-- åˆ©ç”¨è€…ç”»é¢ -->
            <div class="tab-content" id="customer-content">
                <div class="instructions">
                    <h4>ğŸ“Œ ä½¿ã„æ–¹</h4>
                    <ul>
                        <li><strong>ğŸ†• æ–½è¡“ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ:</strong> ã¾ãšã€Œè¨ªå•æ–½è¡“ã€ã¾ãŸã¯ã€Œåº—èˆ—æ–½è¡“ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</li>
                        <li>æ¬¡ã«æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</li>
                        <li>15åˆ†åˆ»ã¿ã®ã‚°ãƒªãƒƒãƒ‰ã§ç©ºãçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™(â—¯:ç©ºãã€Ã—:æº€å¸­)</li>
                        <li>â—¯ã®æ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã¾ã™</li>
                        <li>é€ä¿¡å¾Œã¯ãã®æ™‚é–“å¸¯ãŒÃ—(ä»®æŠ¼ã•ãˆ)ã¨ãªã‚Šã€æ–½è¡“è€…ã®æ‰¿èªå¾Œã«ç¢ºå®šã—ã¾ã™</li>
                    </ul>
                </div>

                <!-- æ–½è¡“ã‚¿ã‚¤ãƒ—é¸æŠ -->
                <div class="menu-selection">
                    <h3>æ–½è¡“ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h3>
                    <div class="menu-options">
                        <div class="menu-option" data-type="visit">
                            <div class="menu-name">ğŸš— è¨ªå•æ–½è¡“</div>
                            <div class="menu-duration">å‡ºå¼µã‚µãƒ¼ãƒ“ã‚¹</div>
                        </div>
                        <div class="menu-option" data-type="store">
                            <div class="menu-name">ğŸ  åº—èˆ—æ–½è¡“</div>
                            <div class="menu-duration">åº—èˆ—ã§ã®ã‚µãƒ¼ãƒ“ã‚¹</div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ -->
                <div class="menu-selection">
                    <h3>æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠ</h3>
                    <div class="menu-options">
                        <div class="menu-option" data-menu="1">
                            <div class="menu-name">æ–½è¡“â‘ </div>
                            <div class="menu-duration">45åˆ†</div>
                        </div>
                        <div class="menu-option" data-menu="2">
                            <div class="menu-name">æ–½è¡“â‘¡</div>
                            <div class="menu-duration">60åˆ†</div>
                        </div>
                    </div>
                </div>

                <div class="week-nav">
                    <button id="prevWeekCustomer">â† å‰é€±</button>
                    <div class="week-info" id="weekInfoCustomer"></div>
                    <button id="nextWeekCustomer">æ¬¡é€± â†’</button>
                </div>

                <div class="calendar">
                    <table class="calendar-table" id="customerCalendar"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="blockModal" role="dialog" aria-modal="true" aria-labelledby="blockModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="blockModalTitle">ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’è¨­å®š</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="blockDateTime"></span>
                </div>
                <label>ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“:</label>
                <select id="blockDuration">
                    <option value="15">15åˆ†</option>
                    <option value="30">30åˆ†</option>
                    <option value="45">45åˆ†</option>
                    <option value="60">60åˆ†</option>
                    <option value="75">75åˆ†</option>
                    <option value="90">90åˆ†</option>
                    <option value="105">105åˆ†</option>
                    <option value="120">120åˆ†</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBlockModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="confirmBlock()">ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- äºˆç´„ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="bookingModal" role="dialog" aria-modal="true" aria-labelledby="bookingModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="bookingModalTitle">äºˆç´„å†…å®¹ç¢ºèª</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ–½è¡“ã‚¿ã‚¤ãƒ—:</span>
                    <span class="info-value" id="bookingType"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="bookingMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="bookingDateTime"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ‰€è¦æ™‚é–“:</span>
                    <span class="info-value" id="bookingDuration"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBookingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="confirmBooking()">äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡</button>
            </div>
        </div>
    </div>

    <!-- æ‰¿èª/ä¸æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="approvalModal" role="dialog" aria-modal="true" aria-labelledby="approvalModalTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="approvalModalTitle">äºˆç´„ã®æ‰¿èª/ä¸æ‰¿èª</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">æ–½è¡“ã‚¿ã‚¤ãƒ—:</span>
                    <span class="info-value" id="approvalType"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="approvalMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="approvalDateTime"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">äºˆç´„æ™‚é–“:</span>
                    <span class="info-value" id="approvalCoreTime"></span>
                </div>
                
                <label>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å¤‰æ›´:</label>
                <div style="margin-bottom:12px;">
                    <label style="font-size:13px;font-weight:500;color:#616161;margin-bottom:6px;display:block;">å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“:</label>
                    <select id="approvalIntervalBefore" class="form-select" style="margin-bottom:12px;">
                        <!-- é¸æŠè‚¢ã¯æ–½è¡“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                    <label style="font-size:13px;font-weight:500;color:#616161;margin-bottom:6px;display:block;">å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“:</label>
                    <select id="approvalIntervalAfter" class="form-select">
                        <!-- é¸æŠè‚¢ã¯æ–½è¡“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                <div class="sub-info" style="margin-top:4px;">â€»æ‰¿èªå¾Œã‚‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’å¤‰æ›´ãƒ»è§£é™¤ã§ãã¾ã™</div>
                
                <label>ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                <textarea id="approvalComment" placeholder="åˆ©ç”¨è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#10;ä¾‹:ç§»å‹•æ™‚é–“ã®éƒ½åˆä¸Šã€äºˆç´„å—ä»˜ãŒã§ãã¾ã›ã‚“&#10;ã€‡æœˆã€‡æ—¥ ã€‡ã€‡:ã€‡ã€‡ã€œã€‡ã€‡:ã€‡ã€‡ã§ã‚ã‚Œã°å—ä»˜å¯èƒ½ã§ã™ã€‚"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeApprovalModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-danger" onclick="rejectBooking()">ä¸æ‰¿èª</button>
                <button class="btn-success" onclick="approveBooking()">æ‰¿èª</button>
            </div>
        </div>
    </div>

    <!-- é¡§å®¢æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«(äºˆç´„æ¸ˆã¿ã‚»ãƒ«ç”¨) -->
    <div class="modal" id="customerInfoModal" role="dialog" aria-modal="true" aria-labelledby="customerInfoTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="customerInfoTitle">é¡§å®¢æƒ…å ±ãƒ»äºˆç´„è©³ç´°</div>
            <div class="modal-body">
                <div class="info-row">
                    <span class="info-label">ãŠåå‰:</span>
                    <span class="info-value" id="ciName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">é€£çµ¡å…ˆ:</span>
                    <span class="info-value" id="ciContact"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ–½è¡“ã‚¿ã‚¤ãƒ—:</span>
                    <span class="info-value" id="ciType"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ–½è¡“:</span>
                    <span class="info-value" id="ciMenu"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ—¥æ™‚:</span>
                    <span class="info-value" id="ciDateTime"></span>
                </div>
                
                <label>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å¤‰æ›´:</label>
                <div style="margin-bottom:12px;">
                    <label style="font-size:13px;font-weight:500;color:#616161;margin-bottom:6px;display:block;">å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“:</label>
                    <select id="ciIntervalBefore" class="form-select" style="margin-bottom:12px;">
                        <!-- é¸æŠè‚¢ã¯æ–½è¡“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                    <label style="font-size:13px;font-weight:500;color:#616161;margin-bottom:6px;display:block;">å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“:</label>
                    <select id="ciIntervalAfter" class="form-select">
                        <!-- é¸æŠè‚¢ã¯æ–½è¡“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                <button class="btn-primary" onclick="updateBookingInterval()" style="margin-top:12px;width:100%;">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’æ›´æ–°</button>
            </div>
            <div class="modal-footer">
                <a id="customerInfoLink" class="btn-primary" target="_blank" rel="noopener">é¡§å®¢è©³ç´°ã‚’é–‹ã</a>
                <button class="btn-secondary" onclick="closeCustomerInfoModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯(æ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆ) -->
    <div class="modal" id="quickBlockSheet" role="dialog" aria-modal="true" aria-labelledby="quickBlockTitle">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header" id="quickBlockTitle">æ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆ</div>
            <div class="modal-body">
                <label for="quickBlockDate">æ—¥ä»˜</label>
                <select id="quickBlockDate"></select>
                <label for="quickBlockStart">é–‹å§‹æ™‚åˆ»</label>
                <select id="quickBlockStart"></select>
                <label for="quickBlockDuration">ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“</label>
                <select id="quickBlockDuration">
                    <option value="15" selected>15åˆ†</option>
                    <option value="30">30åˆ†</option>
                    <option value="45">45åˆ†</option>
                    <option value="60">60åˆ†</option>
                    <option value="75">75åˆ†</option>
                    <option value="90">90åˆ†</option>
                    <option value="105">105åˆ†</option>
                    <option value="120">120åˆ†</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('quickBlockSheet').classList.remove('active'); document.body.style.overflow='';">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" id="quickBlockConfirmBtn">ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentWeek = 0;
        let selectedServiceType = null; // 'visit' or 'store'
        let selectedMenu = null;
        let bookings = [];
        let blocks = [];
        let dragStart = null;
        let dragEnd = null;
        let isDragging = false;
        let selectedBookingId = null;
        let selectedBlockSlot = null;
        let currentBookingForInfo = null;
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“è¨­å®š
        let intervalVisitApplied = 30;
        let intervalVisitPending = 30;
        let intervalStoreApplied = 0;
        let intervalStorePending = 0;
        
        // ã‚¿ãƒƒãƒç”¨
        let touchLongPressTimer = null;
        let isTouchDragging = false;
        let lastTouchSlot = null;

        const START_HOUR = 9;
        const END_HOUR = 21;
        const INTERVAL = 15;

        // æ—¥æœ¬ã®ç¥æ—¥åˆ¤å®š
        function isJapaneseHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();

            // å›ºå®šç¥æ—¥
            const fixedHolidays = {
                '1-1': 'å…ƒæ—¥',
                '2-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
                '4-29': 'æ˜­å’Œã®æ—¥',
                '5-3': 'æ†²æ³•è¨˜å¿µæ—¥',
                '5-4': 'ã¿ã©ã‚Šã®æ—¥',
                '5-5': 'ã“ã©ã‚‚ã®æ—¥',
                '8-11': 'å±±ã®æ—¥',
                '11-3': 'æ–‡åŒ–ã®æ—¥',
                '11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
                '12-23': 'å¤©çš‡èª•ç”Ÿæ—¥'
            };

            const dateKey = `${month}-${day}`;
            if (fixedHolidays[dateKey]) {
                return true;
            }

            // æ˜¥åˆ†ã®æ—¥ãƒ»ç§‹åˆ†ã®æ—¥ï¼ˆç°¡æ˜“è¨ˆç®—ï¼‰
            // 2000å¹´ã‹ã‚‰2100å¹´ã¾ã§ã®ç°¡æ˜“è¨ˆç®—å¼
            if (month === 3 && year >= 2000 && year < 2100) {
                // æ˜¥åˆ†ã®æ—¥: 20.8431 + 0.242194 * (year - 1980) - floor((year - 1980) / 4) ã®å°æ•°ç‚¹ä»¥ä¸‹ã‚’å››æ¨äº”å…¥
                const springDay = Math.round(20.8431 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
                if (day === springDay) return true;
            }
            if (month === 9 && year >= 2000 && year < 2100) {
                // ç§‹åˆ†ã®æ—¥: 23.2488 + 0.242194 * (year - 1980) - floor((year - 1980) / 4) ã®å°æ•°ç‚¹ä»¥ä¸‹ã‚’å››æ¨äº”å…¥
                const autumnDay = Math.round(23.2488 + 0.242194 * (year - 1980) - Math.floor((year - 1980) / 4));
                if (day === autumnDay) return true;
            }

            // ç§»å‹•ç¥æ—¥
            // æˆäººã®æ—¥ï¼ˆ1æœˆã®ç¬¬2æœˆæ›œæ—¥ï¼‰
            if (month === 1 && dayOfWeek === 1 && day >= 8 && day <= 14) {
                return true;
            }
            // æµ·ã®æ—¥
            if (month === 7) {
                if (year === 2020) {
                    // 2020å¹´ã¯7æœˆ23æ—¥
                    if (day === 23) return true;
                } else if (year === 2021) {
                    // 2021å¹´ã¯7æœˆ22æ—¥
                    if (day === 22) return true;
                } else if (year >= 2023) {
                    // 2023å¹´ä»¥é™ã¯7æœˆç¬¬3æœˆæ›œæ—¥
                    if (dayOfWeek === 1 && day >= 15 && day <= 21) {
                        return true;
                    }
                } else {
                    // ãã‚Œä»¥å‰ã¯7æœˆç¬¬3æœˆæ›œæ—¥
                    if (dayOfWeek === 1 && day >= 15 && day <= 21) {
                        return true;
                    }
                }
            }
            // æ•¬è€ã®æ—¥ï¼ˆ9æœˆã®ç¬¬3æœˆæ›œæ—¥ï¼‰
            if (month === 9 && dayOfWeek === 1 && day >= 15 && day <= 21) {
                return true;
            }
            // ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥ï¼ˆ10æœˆã®ç¬¬2æœˆæ›œæ—¥ï¼‰
            if (month === 10) {
                if (year === 2020) {
                    // 2020å¹´ã¯7æœˆ24æ—¥ï¼ˆå®Ÿéš›ã«ã¯10æœˆã«è¡¨ç¤ºã•ã‚Œãªã„ï¼‰
                    return false;
                } else if (year === 2021) {
                    // 2021å¹´ã¯7æœˆ23æ—¥ï¼ˆå®Ÿéš›ã«ã¯10æœˆã«è¡¨ç¤ºã•ã‚Œãªã„ï¼‰
                    return false;
                } else {
                    // é€šå¸¸ã¯10æœˆã®ç¬¬2æœˆæ›œæ—¥
                    if (dayOfWeek === 1 && day >= 8 && day <= 14) {
                        return true;
                    }
                }
            }

            return false;
        }

        // æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getWeekDates(weekOffset) {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (currentDay === 0 ? 6 : currentDay - 1) + (weekOffset * 7));
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }
            return dates;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        function formatWeekInfo(dates) {
            const startDate = dates[0];
            const endDate = dates[6];
            const startYear = startDate.getFullYear();
            const startMonth = startDate.getMonth() + 1;
            const startDay = startDate.getDate();
            const endYear = endDate.getFullYear();
            const endMonth = endDate.getMonth() + 1;
            const endDay = endDate.getDate();
            
            if (startYear !== endYear) {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endYear}å¹´${endMonth}æœˆ${endDay}æ—¥`;
            } else if (startMonth !== endMonth) {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endMonth}æœˆ${endDay}æ—¥`;
            } else {
                return `${startYear}å¹´${startMonth}æœˆ${startDay}æ—¥ã€œ${endDay}æ—¥`;
            }
        }

        // é€±ã”ã¨ã®ã‚·ãƒ•ãƒˆã‹ã‚‰æœ€å°é–‹å§‹æ™‚åˆ»ã¨æœ€å¤§çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—
        function getWeekTimeRange(dates) {
            let minStart = null;
            let maxEnd = null;
            
            dates.forEach(date => {
                const dateStr = formatDate(date);
                const shift = shifts.find(s => s.date === dateStr);
                
                if (shift && !shift.allDay) {
                    const startMinutes = timeToMinutes(shift.startTime);
                    const endTime = shift.endTime === '24:00' ? '24:00' : shift.endTime;
                    const endMinutes = endTime === '24:00' ? 24 * 60 : timeToMinutes(endTime);
                    
                    if (minStart === null || startMinutes < minStart) {
                        minStart = startMinutes;
                    }
                    if (maxEnd === null || endMinutes > maxEnd) {
                        maxEnd = endMinutes;
                    }
                }
            });
            
            // ã‚·ãƒ•ãƒˆãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
            if (minStart === null || maxEnd === null) {
                return { startHour: START_HOUR, endHour: END_HOUR };
            }
            
            // æ™‚åˆ»ã‚’æ™‚é–“å˜ä½ã«å¤‰æ›ï¼ˆåˆ‡ã‚Šæ¨ã¦ï¼‰
            const startHour = Math.floor(minStart / 60);
            // æœ€å¤§çµ‚äº†æ™‚åˆ»ã‚’æ™‚é–“å˜ä½ã«å¤‰æ›ï¼ˆåˆ‡ã‚Šä¸Šã’ï¼‰
            const endHour = Math.ceil(maxEnd / 60);
            
            return { startHour, endHour: Math.min(24, endHour) };
        }

        function getTimeSlots(dates = null) {
            let startHour = START_HOUR;
            let endHour = END_HOUR;
            
            // é€±ã®æ—¥ä»˜ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®é€±ã®ã‚·ãƒ•ãƒˆã‹ã‚‰æ™‚é–“ç¯„å›²ã‚’è¨ˆç®—
            if (dates && dates.length === 7) {
                const range = getWeekTimeRange(dates);
                startHour = range.startHour;
                endHour = range.endHour;
            }
            
            const slots = [];
            for (let hour = startHour; hour < endHour; hour++) {
                for (let min = 0; min < 60; min += INTERVAL) {
                    slots.push(`${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`);
                }
            }
            // æœ€å¾Œã®æ™‚åˆ»ã‚‚è¿½åŠ 
            slots.push(`${String(endHour).padStart(2, '0')}:00`);
            return slots;
        }

        function timeToMinutes(time) {
            if (time === '24:00') {
                return 24 * 60;
            }
            const [hour, min] = time.split(':').map(Number);
            return hour * 60 + min;
        }

        function minutesToTime(minutes) {
            const hour = Math.floor(minutes / 60);
            const min = minutes % 60;
            return `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        }

        function getMenuDuration(menuId) {
            return menuId === 1 ? 45 : 60;
        }

        function getServiceTypeName(type) {
            return type === 'visit' ? 'ğŸš— è¨ªå•æ–½è¡“' : 'ğŸ  åº—èˆ—æ–½è¡“';
        }

        // æ–½è¡“ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é¸æŠè‚¢ã‚’ç”Ÿæˆ
        function getIntervalOptions(serviceType) {
            if (serviceType === 'visit') {
                // è¨ªå•æ–½è¡“: 0åˆ†ã‹ã‚‰15åˆ†åˆ»ã¿ã§120åˆ†ã¾ã§
                return [0, 15, 30, 45, 60, 75, 90, 105, 120];
            } else {
                // åº—èˆ—æ–½è¡“: 0åˆ†ã€15åˆ†ã€30åˆ†
                return [0, 15, 30];
            }
        }

        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é¸æŠè‚¢ã®HTMLç”Ÿæˆ
        function generateIntervalOptionsHTML(serviceType, selectedValue) {
            const options = getIntervalOptions(serviceType);
            return options.map(val => {
                const label = val === 0 ? 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—' : `${val}åˆ†`;
                const selected = val === selectedValue ? 'selected' : '';
                return `<option value="${val}" ${selected}>${label}</option>`;
            }).join('');
        }

        // æŒ‡å®šã•ã‚ŒãŸäºˆç´„ã®å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¨ˆç®—
        function getIntervalsAroundBooking(booking) {
            const dateStr = booking.date;
            const thisStart = timeToMinutes(booking.startTime);
            const thisEnd = timeToMinutes(booking.endTime);
            
            let beforeInterval = null; // å‰ã®äºˆç´„ã¨ã®é–“éš”
            let afterInterval = null;  // æ¬¡ã®äºˆç´„ã¨ã®é–“éš”
            
            // åŒã˜æ—¥ã®ä»–ã®äºˆç´„ã‚’ç¢ºèª
            const sameDayBookings = bookings.filter(b => 
                b.date === dateStr && 
                b.id !== booking.id && 
                b.status !== 'rejected'
            ).sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
            
            sameDayBookings.forEach(other => {
                const otherStart = timeToMinutes(other.startTime);
                const otherEnd = timeToMinutes(other.endTime);
                
                // ã“ã®äºˆç´„ã®å‰ã«ã‚ã‚‹äºˆç´„
                if (otherEnd <= thisStart) {
                    const gap = thisStart - otherEnd;
                    if (beforeInterval === null || gap < beforeInterval) {
                        beforeInterval = gap;
                    }
                }
                // ã“ã®äºˆç´„ã®å¾Œã«ã‚ã‚‹äºˆç´„
                else if (otherStart >= thisEnd) {
                    const gap = otherStart - thisEnd;
                    if (afterInterval === null || gap < afterInterval) {
                        afterInterval = gap;
                    }
                }
            });
            
            return { beforeInterval, afterInterval };
        }

        // ç‰¹å®šã®æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã§ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆæ–½è¡“è€…ç”»é¢è¡¨ç¤ºç”¨ï¼‰
        function getIntervalInfoAtSlot(date, time) {
            const dateStr = formatDate(date);
            const slotMinutes = timeToMinutes(time);
            
            // ã“ã®ã‚¹ãƒ­ãƒƒãƒˆã«äºˆç´„ãŒã‚ã‚‹ã‹ç¢ºèª
            const booking = getBookingAtSlot(date, time);
            if (!booking) return null;
            
            // ã“ã®äºˆç´„ã®å…ˆé ­ã‚¹ãƒ­ãƒƒãƒˆã§ã®ã¿ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            if (timeToMinutes(booking.startTime) !== slotMinutes) return null;
            
            const intervals = getIntervalsAroundBooking(booking);
            // å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å–å¾—ï¼ˆå€‹åˆ¥è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°intervalDurationã‚’ä½¿ç”¨ï¼‰
            const requiredBefore = (typeof booking.intervalBefore === 'number' && booking.intervalBeforeActive !== false) ? booking.intervalBefore : (booking.intervalDuration || 0);
            const requiredAfter = (typeof booking.intervalAfter === 'number' && booking.intervalAfterActive !== false) ? booking.intervalAfter : (booking.intervalDuration || 0);
            
            return { 
                booking, 
                beforeInterval: intervals.beforeInterval,
                afterInterval: intervals.afterInterval,
                requiredBefore,
                requiredAfter
            };
        }

        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã‚’å–å¾—ï¼ˆæŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã‹åˆ¤å®šï¼‰
        function getIntervalBlockAtSlot(date, time) {
            const dateStr = formatDate(date);
            const slotMinutes = timeToMinutes(time);
            
            // å…¨ã¦ã®äºˆç´„ã‚’ãƒã‚§ãƒƒã‚¯
            for (const booking of bookings) {
                if (booking.date !== dateStr || booking.status === 'rejected') continue;
                
                const coreStart = timeToMinutes(booking.startTime);
                const coreEnd = timeToMinutes(booking.endTime);
                
                // å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å–å¾—ï¼ˆå€‹åˆ¥è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°intervalDurationã‚’ä½¿ç”¨ï¼‰
                const intervalBefore = (typeof booking.intervalBefore === 'number' ? booking.intervalBefore : (booking.intervalDuration || 0));
                const intervalAfter = (typeof booking.intervalAfter === 'number' ? booking.intervalAfter : (booking.intervalDuration || 0));
                
                // å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ0åˆ†ã®å ´åˆã¯éè¡¨ç¤ºï¼‰
                if (intervalBefore > 0 && booking.intervalBeforeActive !== false) {
                    const beforeStart = Math.max(START_HOUR * 60, coreStart - intervalBefore);
                    const beforeEnd = coreStart;
                    
                    // ã“ã®ã‚¹ãƒ­ãƒƒãƒˆãŒå‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«è©²å½“ã™ã‚‹ã‹
                    if (slotMinutes >= beforeStart && slotMinutes < beforeEnd) {
                        return { booking, type: 'before', interval: intervalBefore };
                    }
                }
                
                // å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ0åˆ†ã®å ´åˆã¯éè¡¨ç¤ºï¼‰
                if (intervalAfter > 0 && booking.intervalAfterActive !== false) {
                    const afterStart = coreEnd;
                    const afterEnd = Math.min(END_HOUR * 60, coreEnd + intervalAfter);
                    
                    // ã“ã®ã‚¹ãƒ­ãƒƒãƒˆãŒå¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«è©²å½“ã™ã‚‹ã‹
                    if (slotMinutes >= afterStart && slotMinutes < afterEnd) {
                        return { booking, type: 'after', interval: intervalAfter };
                    }
                }
            }
            
            return null;
        }

        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆäºˆç´„å¯èƒ½æ€§åˆ¤å®šç”¨ï¼‰
        function isIntervalBlocked(date, time) {
            return getIntervalBlockAtSlot(date, time) !== null;
        }

        // æ°¸ç¶šåŒ–: ä¿å­˜
        function persistState() {
            localStorage.setItem('rcs_bookings', JSON.stringify(bookings));
            localStorage.setItem('rcs_blocks', JSON.stringify(blocks));
            try { 
                localStorage.setItem('rcs_interval_visit_applied', String(intervalVisitApplied)); 
                localStorage.setItem('rcs_interval_store_applied', String(intervalStoreApplied)); 
            } catch (e) {}
        }

        // æ¤œè¨¼ç”¨: ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetData() {
            if (!confirm('ä¿å­˜ãƒ‡ãƒ¼ã‚¿(äºˆç´„ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒ»ã‚·ãƒ•ãƒˆãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³)ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹?')) return;
            try {
                localStorage.removeItem('rcs_bookings');
                localStorage.removeItem('rcs_blocks');
                localStorage.removeItem('rcs_interval_visit_applied');
                localStorage.removeItem('rcs_interval_store_applied');
                localStorage.removeItem('rcs_shifts');
                localStorage.removeItem('rcs_patterns');
            } catch (e) {}
            bookings = [];
            blocks = [];
            shifts = [];
            patterns = [];
            selectedMenu = null;
            selectedServiceType = null;
            
            document.querySelectorAll('.menu-option').forEach(o => o.classList.remove('selected'));
            renderShiftCalendar();
            updateSummary();
            updateBlocksFromShifts();
            renderCalendar(true);
            renderCalendar(false);
            updatePendingBadge();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
        }

        // æ°¸ç¶šåŒ–: å¾©å…ƒ
        function restoreState() {
            try {
                bookings = JSON.parse(localStorage.getItem('rcs_bookings') || '[]');
                blocks = JSON.parse(localStorage.getItem('rcs_blocks') || '[]');
                
                // ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: serviceType, intervalDuration ãŒãªã„å ´åˆã«è£œå®Œã€å‰å¾Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¿½åŠ 
                if (Array.isArray(bookings) && bookings.length > 0) {
                    let mutated = false;
                    bookings = bookings.map(b => {
                        const intervalDuration = typeof b.intervalDuration === 'number' ? b.intervalDuration : 15;
                        const hasIntervalBefore = typeof b.intervalBefore === 'number';
                        const hasIntervalAfter = typeof b.intervalAfter === 'number';
                        const hasBeforeActive = typeof b.intervalBeforeActive === 'boolean';
                        const hasAfterActive = typeof b.intervalAfterActive === 'boolean';
                        
                        // æ—¢ã«ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                        if (hasIntervalBefore && hasIntervalAfter && hasBeforeActive && hasAfterActive) {
                            return b;
                        }
                        
                        mutated = true;
                        return {
                            id: b.id,
                            date: b.date,
                            startTime: b.startTime,
                            endTime: b.endTime,
                            serviceType: b.serviceType || 'store',
                            menuId: b.menuId,
                            intervalDuration: intervalDuration,
                            intervalBefore: hasIntervalBefore ? b.intervalBefore : intervalDuration,
                            intervalAfter: hasIntervalAfter ? b.intervalAfter : intervalDuration,
                            intervalBeforeActive: hasBeforeActive ? b.intervalBeforeActive : (intervalDuration > 0),
                            intervalAfterActive: hasAfterActive ? b.intervalAfterActive : (intervalDuration > 0),
                            status: b.status || 'pending',
                            comment: b.comment || '',
                            customerName: b.customerName || 'ã‚²ã‚¹ãƒˆ',
                            customerContact: b.customerContact || 'æœªç™»éŒ²',
                            customerDetailUrl: b.customerDetailUrl || ''
                        };
                    });
                    if (mutated) { 
                        try { localStorage.setItem('rcs_bookings', JSON.stringify(bookings)); } catch (e) {} 
                    }
                }
                
                // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã®å¾©å…ƒ
                const storedVisit = parseInt(localStorage.getItem('rcs_interval_visit_applied') || '30', 10);
                const storedStore = parseInt(localStorage.getItem('rcs_interval_store_applied') || '0', 10);
                if (!isNaN(storedVisit)) {
                    intervalVisitApplied = storedVisit;
                    intervalVisitPending = storedVisit;
                }
                if (!isNaN(storedStore)) {
                    intervalStoreApplied = storedStore;
                    intervalStorePending = storedStore;
                }
            } catch (e) {
                bookings = [];
                blocks = [];
            }
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ç¢ºèª
        function isBlocked(date, time) {
            const dateStr = formatDate(date);
            return blocks.some(block => 
                block.date === dateStr && 
                timeToMinutes(time) >= timeToMinutes(block.startTime) && 
                timeToMinutes(time) < timeToMinutes(block.endTime)
            );
        }

        // ç¯„å›²å†…ãŒã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        function isAllBlockedInRange(dateStr, startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const dates = getWeekDates(currentWeek);
            const slots = getTimeSlots(dates);
            
            for (let i = 0; i < slots.length - 1; i++) {
                const slotTime = slots[i];
                const slotMinutes = timeToMinutes(slotTime);
                
                if (slotMinutes >= startMinutes && slotMinutes < endMinutes) {
                    const date = new Date(dateStr + 'T00:00:00');
                    if (!isBlocked(date, slotTime)) {
                        return false;
                    }
                }
            }
            return true;
        }

        // äºˆç´„ç¢ºèª(ä¸æ‰¿èªã¯é™¤å¤–)
        function getBookingAtSlot(date, time) {
            const dateStr = formatDate(date);
            return bookings.find(booking => 
                booking.status !== 'rejected' &&
                booking.date === dateStr && 
                timeToMinutes(time) >= timeToMinutes(booking.startTime) && 
                timeToMinutes(time) < timeToMinutes(booking.endTime)
            );
        }

        // äºˆç´„å¯èƒ½ãƒã‚§ãƒƒã‚¯(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å‹)
        function canBook(date, startTime, duration, serviceType) {
            if (!serviceType) return false;
            
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = startMinutes + duration;
            
            // é€±ã®è¡¨ç¤ºç¯„å›²ã‚’å–å¾—
            const dates = getWeekDates(currentWeek);
            const slots = getTimeSlots(dates);
            
            // ã‚³ã‚¢ãŒè¡¨ç¤ºç¯„å›²å†…ã«åã¾ã‚‰ãªã„å ´åˆã¯ä¸å¯
            const lastSlot = slots[slots.length - 1];
            const lastSlotMinutes = lastSlot === '24:00' ? 24 * 60 : timeToMinutes(lastSlot);
            if (endMinutes > lastSlotMinutes) {
                return false;
            }
            
            // ã‚³ã‚¢æ™‚é–“å¸¯ã®ã‚¹ãƒ­ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < slots.length - 1; i++) {
                const slotTime = slots[i];
                const slotMinutes = timeToMinutes(slotTime);
                if (slotMinutes >= startMinutes && slotMinutes < endMinutes) {
                    if (isBlocked(date, slotTime) || getBookingAtSlot(date, slotTime) || isIntervalBlocked(date, slotTime)) {
                        return false;
                    }
                }
            }
            
            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒã‚§ãƒƒã‚¯: å‰å¾Œã®äºˆç´„ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã‹
            const intervalDuration = serviceType === 'visit' ? intervalVisitApplied : intervalStoreApplied;
            const dateStr = formatDate(date);
            
            for (const booking of bookings) {
                if (booking.date !== dateStr || booking.status === 'rejected') continue;
                
                const bStart = timeToMinutes(booking.startTime);
                const bEnd = timeToMinutes(booking.endTime);
                
                // äºˆç´„ã®å‰ã«ã“ã®äºˆç´„ãŒæ¥ã‚‹å ´åˆï¼ˆæ—¢å­˜äºˆç´„ã®å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                if (endMinutes <= bStart) {
                    const gap = bStart - endMinutes;
                    // æ—¢å­˜äºˆç´„ã®å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å–å¾—
                    const bookingIntervalAfter = (typeof booking.intervalAfter === 'number' && booking.intervalAfterActive !== false) ? booking.intervalAfter : (booking.intervalDuration || 0);
                    // æ–°ã—ã„äºˆç´„ã®å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
                    const requiredInterval = Math.max(intervalDuration, bookingIntervalAfter);
                    if (gap < requiredInterval) {
                        return false;
                    }
                }
                // ã“ã®äºˆç´„ã®å‰ã«æ—¢å­˜äºˆç´„ãŒæ¥ã‚‹å ´åˆï¼ˆæ—¢å­˜äºˆç´„ã®å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã¨æ–°ã—ã„äºˆç´„ã®å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                else if (bEnd <= startMinutes) {
                    const gap = startMinutes - bEnd;
                    // æ—¢å­˜äºˆç´„ã®å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å–å¾—
                    const bookingIntervalAfter = (typeof booking.intervalAfter === 'number' && booking.intervalAfterActive !== false) ? booking.intervalAfter : (booking.intervalDuration || 0);
                    // æ–°ã—ã„äºˆç´„ã®å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
                    const requiredInterval = Math.max(intervalDuration, bookingIntervalAfter);
                    if (gap < requiredInterval) {
                        return false;
                    }
                }
            }
            
            return true;
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» - ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function renderCalendar(isProvider) {
            const dates = getWeekDates(currentWeek);
            const calendarId = isProvider ? 'providerCalendar' : 'customerCalendar';
            const calendar = document.getElementById(calendarId);
            const weekInfo = document.getElementById(isProvider ? 'weekInfoProvider' : 'weekInfoCustomer');
            
            weekInfo.textContent = formatWeekInfo(dates);
            
            if (isProvider) {
                calendar.innerHTML = renderProviderCalendar(dates);
                attachProviderEvents();
            } else {
                calendar.innerHTML = renderCustomerCalendarMobile(dates);
                attachCustomerEvents();
            }
        }

        // æ–½è¡“è€…ç”»é¢ - 15åˆ†åˆ»ã¿å…¨è¡¨ç¤º
        function renderProviderCalendar(dates) {
            const slots = getTimeSlots(dates);
            const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            
            let html = '<thead><tr><th>æ™‚é–“</th>';
            dates.forEach((date, i) => {
                const dayOfWeek = date.getDay(); // 0=æ—¥æ›œã€6=åœŸæ›œ
                const isHoliday = isJapaneseHoliday(date);
                let headerClass = 'date-header';
                if (isHoliday || dayOfWeek === 0) {
                    headerClass += ' holiday'; // ç¥æ—¥ã¾ãŸã¯æ—¥æ›œæ—¥
                } else if (dayOfWeek === 6) {
                    headerClass += ' saturday'; // åœŸæ›œæ—¥
                }
                html += `<th class="${headerClass}">
                    <span class="day-name">${dayNames[i]}</span>
                    <span class="date-num">${formatDateDisplay(date)}</span>
                    <button class="block-all-btn" data-date="${formatDate(date)}">çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯</button>
                </th>`;
            });
            html += '</tr></thead><tbody>';
            
            slots.slice(0, -1).forEach(time => {
                html += `<tr><td class="time-label">${time}</td>`;
                dates.forEach(date => {
                    html += renderProviderTimeSlot(date, time);
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            return html;
        }

        // æ–½è¡“è€…ç”»é¢ - å€‹åˆ¥ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆ
        function renderProviderTimeSlot(date, time) {
            const dateStr = formatDate(date);
            const displayDate = formatDateDisplay(date);
            const blocked = isBlocked(date, time);
            const booking = getBookingAtSlot(date, time);
            const intervalBlock = getIntervalBlockAtSlot(date, time);
            
            let className = 'time-slot';
            let content = '';
            let dataAttrs = `data-date="${dateStr}" data-time="${time}"`;
            let title = '';
            let intervalIndicator = '';
            
            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã®å ´åˆ
            if (intervalBlock && !booking) {
                className += ' interval';
                content = 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«';
                title = `ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«: ${intervalBlock.interval}åˆ†`;
                dataAttrs += ` data-booking-id="${intervalBlock.booking.id}" data-interval-type="${intervalBlock.type}"`;
            } else if (booking) {
                const slotMinutes = timeToMinutes(time);
                const startM = timeToMinutes(booking.startTime);
                const endM = timeToMinutes(booking.endTime);
                
                // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’å–å¾—ï¼ˆå…ˆé ­ã‚¹ãƒ­ãƒƒãƒˆã®ã¿ï¼‰
                const intervalInfo = getIntervalInfoAtSlot(date, time);
                if (intervalInfo) {
                    const { beforeInterval, afterInterval, requiredBefore, requiredAfter } = intervalInfo;
                    let intervalText = '';
                    let intervalClass = 'ok';
                    
                    // å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                    if (beforeInterval !== null && requiredBefore > 0) {
                        if (beforeInterval < requiredBefore) {
                            intervalClass = 'error';
                            intervalText = `å‰${beforeInterval}åˆ†`;
                        } else {
                            intervalText = `å‰${beforeInterval}åˆ†`;
                        }
                    }
                    // å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                    if (afterInterval !== null && requiredAfter > 0) {
                        if (afterInterval < requiredAfter) {
                            intervalClass = 'error';
                            intervalText += (intervalText ? '/' : '') + `å¾Œ${afterInterval}åˆ†`;
                        } else {
                            intervalText += (intervalText ? '/' : '') + `å¾Œ${afterInterval}åˆ†`;
                        }
                    }
                    
                    if (intervalText) {
                        intervalIndicator = `<span class="interval-indicator ${intervalClass}">${intervalText}</span>`;
                    }
                }
                
                if (booking.status === 'pending') {
                    className += ' pending';
                    content = 'æ‰¿èªå¾…ã¡';
                    title = `æ‰¿èªå¾…ã¡: æ–½è¡“ ${booking.startTime}ã€œ${booking.endTime}`;
                } else if (booking.status === 'confirmed') {
                    className += ' confirmed';
                    content = 'äºˆç´„æ¸ˆ';
                    title = `äºˆç´„æ¸ˆã¿: æ–½è¡“ ${booking.startTime}ã€œ${booking.endTime}`;
                } else if (booking.status === 'rejected') {
                    className += ' rejected';
                    content = 'ä¸æ‰¿èª';
                    title = 'ä¸æ‰¿èª';
                }
                dataAttrs += ` data-booking-id="${booking.id}"`;
            } else if (blocked) {
                className += ' blocked removable';
                content = 'Ã—';
                title = 'ãƒ–ãƒ­ãƒƒã‚¯(æ‰‹å‹•)â€”ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤';
            } else {
                className += ' available';
                content = 'â—¯';
                title = 'å—ä»˜å¯èƒ½â€”ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š';
            }
            
            return `<td><div class="${className}" ${dataAttrs} title="${title}">${content}${intervalIndicator}</div></td>`;
        }

        // åˆ©ç”¨è€…ç”»é¢ - ãƒ¢ãƒã‚¤ãƒ«ç”¨: ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼é¢¨(15åˆ†ã‚°ãƒªãƒƒãƒ‰)
        function renderCustomerCalendarMobile(dates) {
            const slots = getTimeSlots(dates);
            const dayNames = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            let html = '<table class="hp-table">';
            html += '<thead><tr><th class="hp-time">æ—¥æ™‚</th>';
            dates.forEach((date, i) => {
                const dayOfWeek = date.getDay(); // 0=æ—¥æ›œã€6=åœŸæ›œ
                const isHoliday = isJapaneseHoliday(date);
                let headerClass = '';
                if (isHoliday || dayOfWeek === 0) {
                    headerClass = ' holiday sunday'; // ç¥æ—¥ã¾ãŸã¯æ—¥æ›œæ—¥
                } else if (dayOfWeek === 6) {
                    headerClass = ' saturday'; // åœŸæ›œæ—¥
                }
                html += `<th class="${headerClass.trim()}">${dayNames[i]}<br>${formatDateDisplay(date)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            const duration = selectedMenu ? getMenuDuration(selectedMenu) : null;
            
            slots.slice(0, -1).forEach(time => {
                html += `<tr>`;
                html += `<td class="hp-time">${time}</td>`;
                dates.forEach(date => {
                    let inner = '-';
                    if (selectedMenu && selectedServiceType) {
                        if (canBook(date, time, duration, selectedServiceType)) {
                            inner = `<div class="hp-cell available" onclick="handleCustomerSlotClick('${formatDate(date)}','${time}')">â—¯</div>`;
                        } else {
                            inner = `<div class="hp-cell blocked">Ã—</div>`;
                        }
                    } else {
                        inner = `<div class="hp-cell">-</div>`;
                    }
                    html += `<td class="hp-slot">${inner}</td>`;
                });
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            return `<div class="hp-calendar">${html}</div>`;
        }

        // åˆ©ç”¨è€… - ã‚¹ãƒ­ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯
        function handleCustomerSlotClick(date, time) {
            if (!selectedServiceType) {
                alert('æ–½è¡“ã‚¿ã‚¤ãƒ—(è¨ªå•æ–½è¡“/åº—èˆ—æ–½è¡“)ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!selectedMenu) {
                alert('æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            showBookingModal(date, time);
        }

        // æ–½è¡“è€…ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ
        function attachProviderEvents() {
            const slots = document.querySelectorAll('#provider-content .time-slot');
            
            slots.forEach(slot => {
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                slot.addEventListener('mousedown', handleDragStart);
                slot.addEventListener('mouseenter', handleDragOver);
                slot.addEventListener('mouseup', handleDragEnd);
                // ã‚¿ãƒƒãƒå¯¾å¿œ(é•·æŠ¼ã—â†’ãƒ‰ãƒ©ãƒƒã‚°)
                slot.addEventListener('touchstart', handleTouchStart, { passive: false });
                slot.addEventListener('touchmove', handleTouchMove, { passive: false });
                slot.addEventListener('touchend', handleTouchEnd);
                
                // æ‰¿èªå¾…ã¡ã‚¯ãƒªãƒƒã‚¯
                if (slot.classList.contains('pending')) {
                    slot.addEventListener('click', handlePendingClick);
                }
                // äºˆç´„æ¸ˆã¿ã‚¯ãƒªãƒƒã‚¯(é¡§å®¢æƒ…å ±ãƒãƒƒãƒ—)
                if (slot.classList.contains('confirmed')) {
                    slot.addEventListener('click', handleConfirmedClick);
                }
                
                // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
                if (slot.classList.contains('removable')) {
                    slot.addEventListener('click', handleBlockRemove);
                }
            });

            // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³
            const blockAllBtns = document.querySelectorAll('.block-all-btn');
            blockAllBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleBlockAllDay(btn.dataset.date);
                });
            });

            // ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ
            const openQuick = document.getElementById('openQuickBlockSheet');
            if (openQuick) {
                openQuick.addEventListener('click', openQuickBlockSheet);
            }
        }

        // åˆ©ç”¨è€…ç”»é¢ã‚¤ãƒ™ãƒ³ãƒˆ(æ—¢ã«onclickå±æ€§ã§è¨­å®šæ¸ˆã¿)
        function attachCustomerEvents() {
            // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        }

        // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤(1æ æ¯ã«è§£é™¤)
        function handleBlockRemove(e) {
            e.stopPropagation();
            const slot = e.target;
            const date = slot.dataset.date;
            const time = slot.dataset.time;
            
            const timeMinutes = timeToMinutes(time);
            const newBlocks = [];
            
            blocks.forEach(block => {
                if (block.date !== date) {
                    newBlocks.push(block);
                    return;
                }
                
                const blockStart = timeToMinutes(block.startTime);
                const blockEnd = timeToMinutes(block.endTime);
                
                if (timeMinutes >= blockStart && timeMinutes < blockEnd) {
                    if (blockStart < timeMinutes) {
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: block.startTime,
                            endTime: time
                        });
                    }
                    if (timeMinutes + INTERVAL < blockEnd) {
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: minutesToTime(timeMinutes + INTERVAL),
                            endTime: block.endTime
                        });
                    }
                } else {
                    newBlocks.push(block);
                }
            });
            
            blocks = newBlocks;
            persistState();
            renderCalendar(true);
            renderCalendar(false);
        }

        // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯
        function handleBlockAllDay(dateStr) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const displayDate = `${month}/${day}`;
            
            if (!confirm(`${displayDate}ã‚’çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹?`)) {
                return;
            }
            
            blocks = blocks.filter(block => block.date !== dateStr);
            
            blocks.push({
                id: Date.now(),
                date: dateStr,
                startTime: `${String(START_HOUR).padStart(2, '0')}:00`,
                endTime: `${String(END_HOUR).padStart(2, '0')}:00`
            });
            
            persistState();
            renderCalendar(true);
            renderCalendar(false);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
        function handleDragStart(e) {
            const slot = e.target;
            if (slot.classList.contains('pending') || 
                slot.classList.contains('confirmed') ||
                (slot.classList.contains('blocked') && !slot.classList.contains('removable'))) {
                return;
            }
            
            isDragging = true;
            dragStart = { date: slot.dataset.date, time: slot.dataset.time };
            slot.classList.add('dragging');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleDragOver(e) {
            if (!isDragging) return;
            const slot = e.target;
            if (!slot.classList.contains('time-slot')) return;
            if (slot.classList.contains('pending') || 
                slot.classList.contains('confirmed') ||
                (slot.classList.contains('blocked') && !slot.classList.contains('removable'))) {
                return;
            }
            
            slot.classList.add('dragging');
        }

        // ç¯„å›²å†…ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã™ã‚‹
        function removeBlocksInRange(dateStr, startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const newBlocks = [];
            
            blocks.forEach(block => {
                if (block.date !== dateStr) {
                    newBlocks.push(block);
                    return;
                }
                
                const blockStart = timeToMinutes(block.startTime);
                const blockEnd = timeToMinutes(block.endTime);
                
                const overlapStart = Math.max(blockStart, startMinutes);
                const overlapEnd = Math.min(blockEnd, endMinutes);
                
                if (overlapStart < overlapEnd) {
                    if (blockStart < overlapStart) {
                        newBlocks.push({
                            id: Date.now() + Math.random(),
                            date: block.date,
                            startTime: block.startTime,
                            endTime: minutesToTime(overlapStart)
                        });
                    }
                    if (overlapEnd < blockEnd) {
                        newBlocks.push({
                            id: Date.now() + Math.random() + 1,
                            date: block.date,
                            startTime: minutesToTime(overlapEnd),
                            endTime: block.endTime
                        });
                    }
                } else {
                    newBlocks.push(block);
                }
            });
            
            blocks = newBlocks;
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
        function handleDragEnd(e) {
            if (!isDragging) return;
            
            const slot = e.target;
            if (!slot.classList.contains('time-slot')) {
                isDragging = false;
                clearDragging();
                return;
            }
            
            dragEnd = { date: slot.dataset.date, time: slot.dataset.time };
            
            if (dragStart.date !== dragEnd.date) {
                alert('åŒã˜æ—¥ä»˜å†…ã§ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã§ãã¾ã™');
                isDragging = false;
                clearDragging();
                return;
            }
            
            let startTime = dragStart.time;
            let endTime = dragEnd.time;
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            if (startMinutes > endMinutes) {
                [startTime, endTime] = [endTime, startTime];
            }
            
            const actualEndMinutes = timeToMinutes(endTime) + INTERVAL;
            const actualEndTime = minutesToTime(actualEndMinutes);
            
            if (isAllBlockedInRange(dragStart.date, startTime, actualEndTime)) {
                removeBlocksInRange(dragStart.date, startTime, actualEndTime);
                persistState();
                renderCalendar(true);
                renderCalendar(false);
            } else {
                dragEnd = { date: dragStart.date, time: endTime };
                showBlockModal();
            }
            
            isDragging = false;
        }

        // ã‚¿ãƒƒãƒ: é•·æŠ¼ã—é–‹å§‹
        function handleTouchStart(e) {
            const slot = e.currentTarget;
            if (slot.classList.contains('pending') || slot.classList.contains('confirmed')) return;
            if (slot.classList.contains('blocked') && !slot.classList.contains('removable')) return;
            if (touchLongPressTimer) clearTimeout(touchLongPressTimer);
            lastTouchSlot = null;
            isTouchDragging = false;
            touchLongPressTimer = setTimeout(() => {
                isTouchDragging = true;
                isDragging = true;
                dragStart = { date: slot.dataset.date, time: slot.dataset.time };
                slot.classList.add('dragging');
            }, 450);
        }

        // ã‚¿ãƒƒãƒ: ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        function handleTouchMove(e) {
            if (!isTouchDragging) {
                if (touchLongPressTimer) e.preventDefault();
                return;
            }
            e.preventDefault();
            const touch = e.touches[0];
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (!el) return;
            const slot = el.closest && el.closest('.time-slot');
            if (!slot) return;
            if (slot.dataset.date !== dragStart.date) return;
            if (slot.classList.contains('pending') || slot.classList.contains('confirmed')) return;
            if (slot.classList.contains('blocked') && !slot.classList.contains('removable')) return;
            if (lastTouchSlot === slot) return;
            lastTouchSlot = slot;
            slot.classList.add('dragging');
        }

        // ã‚¿ãƒƒãƒ: çµ‚äº†
        function handleTouchEnd() {
            if (touchLongPressTimer) {
                clearTimeout(touchLongPressTimer);
                touchLongPressTimer = null;
            }
            if (!isTouchDragging) return;
            isTouchDragging = false;
            if (!isDragging) return;
            const slot = lastTouchSlot;
            if (!dragStart || !slot) { 
                clearDragging(); 
                isDragging = false; 
                dragStart = null; 
                dragEnd = null; 
                return; 
            }
            dragEnd = { date: slot.dataset.date, time: slot.dataset.time };
            if (dragStart.date !== dragEnd.date) {
                alert('åŒã˜æ—¥ä»˜å†…ã§ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯è¨­å®šã§ãã¾ã™');
                isDragging = false;
                clearDragging();
                dragStart = null; 
                dragEnd = null;
                return;
            }
            let startTime = dragStart.time;
            let endTime = dragEnd.time;
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            if (startMinutes > endMinutes) [startTime, endTime] = [endTime, startTime];
            const actualEndMinutes = timeToMinutes(endTime) + INTERVAL;
            const actualEndTime = minutesToTime(actualEndMinutes);
            if (isAllBlockedInRange(dragStart.date, startTime, actualEndTime)) {
                removeBlocksInRange(dragStart.date, startTime, actualEndTime);
                persistState();
                renderCalendar(true);
                renderCalendar(false);
            } else {
                dragEnd = { date: dragStart.date, time: endTime };
                showBlockModal();
            }
            isDragging = false;
            clearDragging();
        }

        function clearDragging() {
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
        }

        // ãƒ–ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBlockModal() {
            const modal = document.getElementById('blockModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === dragStart.date);
            
            const startTime = dragStart.time;
            const endTime = dragEnd ? dragEnd.time : startTime;
            const duration = (timeToMinutes(endTime) - timeToMinutes(startTime) + INTERVAL);
            
            document.getElementById('blockDateTime').textContent = 
                `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${startTime}ã€œ`;
            document.getElementById('blockDuration').value = duration;
            
            selectedBlockSlot = { date: dragStart.date, startTime, duration };
            openModal(modal, { primary: confirmBlock });
            clearDragging();
        }

        function closeBlockModal() {
            document.getElementById('blockModal').classList.remove('active');
            selectedBlockSlot = null;
            clearDragging();
            document.body.style.overflow = '';
        }

        function confirmBlock() {
            if (!selectedBlockSlot) return;
            
            const duration = parseInt(document.getElementById('blockDuration').value);
            const startMinutes = timeToMinutes(selectedBlockSlot.startTime);
            const endMinutes = Math.min(startMinutes + duration, END_HOUR * 60);
            const endTime = minutesToTime(endMinutes);
            
            if (startMinutes + duration > END_HOUR * 60) {
                alert(`å–¶æ¥­æ™‚é–“ã¯${END_HOUR}:00ã¾ã§ã§ã™ã€‚ãƒ–ãƒ­ãƒƒã‚¯æ™‚é–“ã‚’${endTime}ã¾ã§èª¿æ•´ã—ã¾ã—ãŸã€‚`);
            }
            
            blocks.push({
                id: Date.now(),
                date: selectedBlockSlot.date,
                startTime: selectedBlockSlot.startTime,
                endTime: endTime
            });
            
            closeBlockModal();
            persistState();
            renderCalendar(true);
            renderCalendar(false);
        }

        // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showBookingModal(date, time) {
            const modal = document.getElementById('bookingModal');
            const dates = getWeekDates(currentWeek);
            const dateObj = dates.find(d => formatDate(d) === date);
            const duration = getMenuDuration(selectedMenu);
            const menuName = selectedMenu === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';
            const typeName = getServiceTypeName(selectedServiceType);

            document.getElementById('bookingType').textContent = typeName;
            document.getElementById('bookingMenu').textContent = `${menuName}(${duration}åˆ†)`;
            document.getElementById('bookingDateTime').textContent = 
                `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dateObj.getDay()]})${time}ã€œ${minutesToTime(timeToMinutes(time) + duration)}`;
            document.getElementById('bookingDuration').textContent = `${duration}åˆ†`;
            
            selectedBookingId = { date, time, menuId: selectedMenu, duration, serviceType: selectedServiceType };
            openModal(modal, { primary: confirmBooking });
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            selectedBookingId = null;
            document.body.style.overflow = '';
        }

        function confirmBooking() {
            if (!selectedBookingId) return;
            
            const { date, time, menuId, duration, serviceType } = selectedBookingId;
            const startMinutes = timeToMinutes(time);
            const endMinutes = startMinutes + duration;
            
            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å–å¾—ï¼ˆå‰å¾Œã¯åŒã˜å€¤ã§åˆæœŸåŒ–ï¼‰
            const intervalDuration = serviceType === 'visit' ? intervalVisitApplied : intervalStoreApplied;
            
            // äºˆç´„ãƒ¬ã‚³ãƒ¼ãƒ‰(æ‰¿èªå¾…ã¡)ã‚’ä½œæˆ
            const booking = {
                id: Date.now(),
                date: date,
                startTime: time,
                endTime: minutesToTime(endMinutes),
                serviceType: serviceType,
                menuId: menuId,
                intervalDuration: intervalDuration,
                intervalBefore: intervalDuration,  // å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                intervalAfter: intervalDuration,     // å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                intervalBeforeActive: intervalDuration > 0,  // å‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒæœ‰åŠ¹ã‹
                intervalAfterActive: intervalDuration > 0,   // å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒæœ‰åŠ¹ã‹
                status: 'pending',
                comment: '',
                customerName: 'ã‚²ã‚¹ãƒˆ',
                customerContact: 'æœªç™»éŒ²',
                customerDetailUrl: `https://example.com/customers?bookingId=${Date.now()}`
            };
            bookings.push(booking);
            
            closeBookingModal();
            persistState();
            renderCalendar(true);
            renderCalendar(false);
            updatePendingBadge();
        }

        // æ‰¿èªå¾…ã¡ã‚¯ãƒªãƒƒã‚¯
        function handlePendingClick(e) {
            const slot = e.target;
            const bookingId = parseInt(slot.dataset.bookingId);
            const booking = bookings.find(b => b.id === bookingId);
            
            if (booking) {
                showApprovalModal(booking);
            }
        }

        // äºˆç´„æ¸ˆã¿ã‚¯ãƒªãƒƒã‚¯ -> é¡§å®¢æƒ…å ±ãƒãƒƒãƒ—
        function handleConfirmedClick(e) {
            const slot = e.target;
            const bookingId = parseInt(slot.dataset.bookingId);
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            showCustomerInfoModal(booking);
        }

        // æ‰¿èªãƒ¢ãƒ¼ãƒ€ãƒ«
        function showApprovalModal(booking) {
            const modal = document.getElementById('approvalModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === booking.date);
            const menuName = booking.menuId === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';
            const duration = getMenuDuration(booking.menuId);
            const typeName = getServiceTypeName(booking.serviceType);
            
            document.getElementById('approvalType').textContent = typeName;
            document.getElementById('approvalMenu').textContent = `${menuName}(${duration}åˆ†)`;
            document.getElementById('approvalDateTime').textContent = 
                `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]})`;
            document.getElementById('approvalCoreTime').textContent = `${booking.startTime}ã€œ${booking.endTime}`;
            
            // å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã®é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
            const intervalBeforeSelect = document.getElementById('approvalIntervalBefore');
            const intervalAfterSelect = document.getElementById('approvalIntervalAfter');
            const intervalBefore = typeof booking.intervalBefore === 'number' ? booking.intervalBefore : (booking.intervalDuration || 0);
            const intervalAfter = typeof booking.intervalAfter === 'number' ? booking.intervalAfter : (booking.intervalDuration || 0);
            intervalBeforeSelect.innerHTML = generateIntervalOptionsHTML(booking.serviceType, intervalBefore);
            intervalAfterSelect.innerHTML = generateIntervalOptionsHTML(booking.serviceType, intervalAfter);
            
            document.getElementById('approvalComment').value = '';
            
            selectedBookingId = booking.id;
            openModal(modal, {});
        }

        function closeApprovalModal() {
            document.getElementById('approvalModal').classList.remove('active');
            selectedBookingId = null;
            document.body.style.overflow = '';
        }

        function approveBooking() {
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (booking) {
                booking.status = 'confirmed';
                booking.comment = document.getElementById('approvalComment').value;
                
                // å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’å€‹åˆ¥ã«è¨­å®š
                const intervalBefore = parseInt(document.getElementById('approvalIntervalBefore').value) || 0;
                const intervalAfter = parseInt(document.getElementById('approvalIntervalAfter').value) || 0;
                booking.intervalBefore = intervalBefore;
                booking.intervalAfter = intervalAfter;
                booking.intervalBeforeActive = intervalBefore > 0;
                booking.intervalAfterActive = intervalAfter > 0;
                // intervalDurationã¯å‰å¾Œã®æœ€å¤§å€¤ã«è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                booking.intervalDuration = Math.max(intervalBefore, intervalAfter);
                
                closeApprovalModal();
                persistState();
                renderCalendar(true);
                renderCalendar(false);
                updatePendingBadge();
                alert('äºˆç´„ã‚’æ‰¿èªã—ã¾ã—ãŸ');
            }
        }

        function rejectBooking() {
            const booking = bookings.find(b => b.id === selectedBookingId);
            if (booking) {
                booking.status = 'rejected';
                booking.comment = document.getElementById('approvalComment').value;
                closeApprovalModal();
                persistState();
                renderCalendar(true);
                renderCalendar(false);
                updatePendingBadge();
                alert('äºˆç´„ã‚’ä¸æ‰¿èªã«ã—ã¾ã—ãŸ');
            }
        }

        // é¡§å®¢æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showCustomerInfoModal(booking) {
            currentBookingForInfo = booking;
            const modal = document.getElementById('customerInfoModal');
            const dates = getWeekDates(currentWeek);
            const date = dates.find(d => formatDate(d) === booking.date);
            const menuName = booking.menuId === 1 ? 'æ–½è¡“â‘ ' : 'æ–½è¡“â‘¡';
            const typeName = getServiceTypeName(booking.serviceType);
            
            document.getElementById('ciName').textContent = booking.customerName || 'ä¸æ˜';
            document.getElementById('ciContact').textContent = booking.customerContact || 'ä¸æ˜';
            document.getElementById('ciType').textContent = typeName;
            document.getElementById('ciMenu').textContent = menuName;
            document.getElementById('ciDateTime').textContent = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${booking.startTime}ã€œ${booking.endTime}`;
            
            // å‰å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã®é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
            const intervalBeforeSelect = document.getElementById('ciIntervalBefore');
            const intervalAfterSelect = document.getElementById('ciIntervalAfter');
            const intervalBefore = typeof booking.intervalBefore === 'number' ? booking.intervalBefore : (booking.intervalDuration || 0);
            const intervalAfter = typeof booking.intervalAfter === 'number' ? booking.intervalAfter : (booking.intervalDuration || 0);
            intervalBeforeSelect.innerHTML = generateIntervalOptionsHTML(booking.serviceType, intervalBefore);
            intervalAfterSelect.innerHTML = generateIntervalOptionsHTML(booking.serviceType, intervalAfter);
            
            const link = document.getElementById('customerInfoLink');
            const url = booking.customerDetailUrl || `https://example.com/customers?bookingId=${booking.id}`;
            link.href = url;
            openModal(modal, {});
        }

        function closeCustomerInfoModal() {
            document.getElementById('customerInfoModal').classList.remove('active');
            currentBookingForInfo = null;
            document.body.style.overflow = '';
        }

        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“æ›´æ–°ï¼ˆç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä»˜ãï¼‰
        function updateBookingInterval() {
            if (!currentBookingForInfo) return;
            
            const newIntervalBefore = parseInt(document.getElementById('ciIntervalBefore').value) || 0;
            const newIntervalAfter = parseInt(document.getElementById('ciIntervalAfter').value) || 0;
            
            // ç¾åœ¨ã®å€¤ã¨æ¯”è¼ƒ
            const currentBefore = typeof currentBookingForInfo.intervalBefore === 'number' ? currentBookingForInfo.intervalBefore : (currentBookingForInfo.intervalDuration || 0);
            const currentAfter = typeof currentBookingForInfo.intervalAfter === 'number' ? currentBookingForInfo.intervalAfter : (currentBookingForInfo.intervalDuration || 0);
            
            // å¤‰æ›´ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (newIntervalBefore === currentBefore && newIntervalAfter === currentAfter) {
                alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // ç¢ºèªãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            const beforeText = newIntervalBefore === 0 ? 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—' : `å‰${newIntervalBefore}åˆ†`;
            const afterText = newIntervalAfter === 0 ? 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—' : `å¾Œ${newIntervalAfter}åˆ†`;
            const confirmMsg = `ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\nå‰: ${beforeText}\nå¾Œ: ${afterText}`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // æ›´æ–°
            currentBookingForInfo.intervalBefore = newIntervalBefore;
            currentBookingForInfo.intervalAfter = newIntervalAfter;
            currentBookingForInfo.intervalBeforeActive = newIntervalBefore > 0;
            currentBookingForInfo.intervalAfterActive = newIntervalAfter > 0;
            // intervalDurationã¯å‰å¾Œã®æœ€å¤§å€¤ã«è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
            currentBookingForInfo.intervalDuration = Math.max(newIntervalBefore, newIntervalAfter);
            
            persistState();
            alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            closeCustomerInfoModal();
            renderCalendar(true);
            renderCalendar(false);
        }

        // ãƒãƒƒã‚¸æ›´æ–°
        function updatePendingBadge() {
            const dates = getWeekDates(currentWeek);
            const weekDates = dates.map(d => formatDate(d));
            
            const count = bookings.filter(b => 
                b.status === 'pending' && weekDates.includes(b.date)
            ).length;
            
            const badge = document.getElementById('pendingBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                if (tabName === 'shift') {
                    renderShiftCalendar();
                    updateSummary();
                } else {
                    renderCalendar(tabName === 'provider');
                }
            });
        });

        // æ–½è¡“ã‚¿ã‚¤ãƒ—é¸æŠ
        document.querySelectorAll('.menu-option[data-type]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.menu-option[data-type]').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedServiceType = option.dataset.type;
                renderCalendar(false);
            });
        });

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ
        document.querySelectorAll('.menu-option[data-menu]').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.menu-option[data-menu]').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedMenu = parseInt(option.dataset.menu);
                renderCalendar(false);
            });
        });

        // é€±ç§»å‹•
        document.getElementById('prevWeekProvider').addEventListener('click', () => {
            currentWeek--;
            renderCalendar(true);
            updatePendingBadge();
        });

        document.getElementById('nextWeekProvider').addEventListener('click', () => {
            currentWeek++;
            renderCalendar(true);
            updatePendingBadge();
        });

        document.getElementById('prevWeekCustomer').addEventListener('click', () => {
            currentWeek--;
            renderCalendar(false);
            updatePendingBadge();
        });

        document.getElementById('nextWeekCustomer').addEventListener('click', () => {
            currentWeek++;
            renderCalendar(false);
            updatePendingBadge();
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ—
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                clearDragging();
            }
        });

        // å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«: ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ãƒ»Escé–‰ã˜ãƒ»Enter=ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š
        function openModal(modalEl, actions) {
            const content = modalEl.querySelector('.modal-content');
            const previouslyFocused = document.activeElement;
            function closeInternal() {
                modalEl.classList.remove('active');
                document.body.style.overflow = '';
                document.removeEventListener('keydown', onKeydown, true);
                if (previouslyFocused && previouslyFocused.focus) previouslyFocused.focus();
            }
            function onKeydown(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeInternal();
                } else if (e.key === 'Enter') {
                    const tag = (e.target && e.target.tagName || '').toLowerCase();
                    if (tag !== 'textarea') {
                        e.preventDefault();
                        if (actions && typeof actions.primary === 'function') actions.primary();
                        closeInternal();
                    }
                } else if (e.key === 'Tab') {
                    const focusables = content.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const list = Array.from(focusables).filter(el => !el.hasAttribute('disabled'));
                    if (list.length === 0) return;
                    const first = list[0];
                    const last = list[list.length - 1];
                    if (e.shiftKey && document.activeElement === first) { 
                        e.preventDefault(); 
                        last.focus(); 
                    } else if (!e.shiftKey && document.activeElement === last) { 
                        e.preventDefault(); 
                        first.focus(); 
                    }
                }
            }
            modalEl.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', onKeydown, true);
            const primary = modalEl.querySelector('.modal-footer .btn-primary');
            setTimeout(() => { (primary || content).focus(); }, 0);
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ãƒ–ãƒ­ãƒƒã‚¯(+ãƒœã‚¿ãƒ³â†’æ™‚é–“é¸æŠã‚·ãƒ¼ãƒˆ)
        function openQuickBlockSheet() {
            const sheet = document.getElementById('quickBlockSheet');
            const dateSelect = document.getElementById('quickBlockDate');
            const startSelect = document.getElementById('quickBlockStart');
            const durationSelect = document.getElementById('quickBlockDuration');
            
            dateSelect.innerHTML = '';
            const dates = getWeekDates(currentWeek);
            dates.forEach(d => {
                const v = formatDate(d);
                const opt = document.createElement('option');
                opt.value = v; 
                opt.textContent = `${d.getMonth()+1}/${d.getDate()} (${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()]})`;
                dateSelect.appendChild(opt);
            });
            
            startSelect.innerHTML = '';
            for (let h = START_HOUR; h <= END_HOUR; h++) {
                for (let m = 0; m < 60; m += INTERVAL) {
                    const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    const opt = document.createElement('option');
                    opt.value = t; 
                    opt.textContent = t;
                    startSelect.appendChild(opt);
                }
            }
            durationSelect.value = '15';
            
            const confirmBtn = document.getElementById('quickBlockConfirmBtn');
            const onConfirm = () => {
                const date = dateSelect.value;
                const start = startSelect.value;
                const duration = parseInt(durationSelect.value, 10);
                addBlock(date, start, duration);
                persistState();
                renderCalendar(true);
                renderCalendar(false);
                document.getElementById('quickBlockSheet').classList.remove('active');
                document.body.style.overflow = '';
            };
            confirmBtn.onclick = onConfirm;
            openModal(sheet, { primary: onConfirm });
        }

        function addBlock(dateStr, startTime, duration) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = Math.min(startMinutes + duration, END_HOUR * 60);
            const endTime = minutesToTime(endMinutes);
            if (startMinutes >= END_HOUR * 60) {
                alert(`å–¶æ¥­æ™‚é–“ã¯${END_HOUR}:00ã¾ã§ã§ã™`);
                return;
            }
            blocks.push({ id: Date.now(), date: dateStr, startTime, endTime });
        }

        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šUIã®ãƒãƒ³ãƒ‰ãƒ©
        (function initIntervalSettingUI(){
            const visitSel = document.getElementById('intervalVisitSelect');
            const visitApplyBtn = document.getElementById('applyIntervalVisitBtn');
            const visitAppliedText = document.getElementById('appliedIntervalVisitText');
            
            const storeSel = document.getElementById('intervalStoreSelect');
            const storeApplyBtn = document.getElementById('applyIntervalStoreBtn');
            const storeAppliedText = document.getElementById('appliedIntervalStoreText');
            
            if (visitSel && visitApplyBtn && visitAppliedText) {
                visitSel.value = String(intervalVisitApplied);
                visitAppliedText.textContent = String(intervalVisitApplied);
                visitSel.addEventListener('change', () => {
                    intervalVisitPending = parseInt(visitSel.value, 10);
                });
                visitApplyBtn.addEventListener('click', () => {
                    intervalVisitApplied = intervalVisitPending;
                    visitAppliedText.textContent = String(intervalVisitApplied);
                    persistState();
                    renderCalendar(false);
                });
            }
            
            if (storeSel && storeApplyBtn && storeAppliedText) {
                storeSel.value = String(intervalStoreApplied);
                storeAppliedText.textContent = String(intervalStoreApplied);
                storeSel.addEventListener('change', () => {
                    intervalStorePending = parseInt(storeSel.value, 10);
                });
                storeApplyBtn.addEventListener('click', () => {
                    intervalStoreApplied = intervalStorePending;
                    storeAppliedText.textContent = String(intervalStoreApplied);
                    persistState();
                    renderCalendar(false);
                });
            }
        })();

        // ========== ã‚·ãƒ•ãƒˆç®¡ç†æ©Ÿèƒ½ ==========
        let currentMonth = new Date();
        let shifts = [];
        let patterns = [];
        let editingPatternId = null;

        // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
        function persistShiftData() {
            localStorage.setItem('rcs_shifts', JSON.stringify(shifts));
            localStorage.setItem('rcs_patterns', JSON.stringify(patterns));
        }

        function restoreShiftData() {
            try {
                shifts = JSON.parse(localStorage.getItem('rcs_shifts') || '[]');
                patterns = JSON.parse(localStorage.getItem('rcs_patterns') || '[]');
            } catch (e) {
                shifts = [];
                patterns = [];
            }
        }

        // æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getMonthDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = [];

            // å‰æœˆã®æ—¥ä»˜ã‚’è¿½åŠ ï¼ˆé€±ã®é–‹å§‹ã‚’æœˆæ›œæ—¥ã«ã™ã‚‹ãŸã‚ï¼‰
            const firstDayOfWeek = firstDay.getDay();
            const offset = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            for (let i = offset; i > 0; i--) {
                const date = new Date(year, month, 1 - i);
                days.push({ date, otherMonth: true });
            }

            // å½“æœˆã®æ—¥ä»˜
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const date = new Date(year, month, i);
                days.push({ date, otherMonth: false });
            }

            // æ¬¡æœˆã®æ—¥ä»˜ã‚’è¿½åŠ ï¼ˆ7ã®å€æ•°ã«ãªã‚‹ã¾ã§ï¼‰
            const remaining = 7 - (days.length % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    const date = new Date(year, month + 1, i);
                    days.push({ date, otherMonth: true });
                }
            }

            return days;
        }

        // ã‚·ãƒ•ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderShiftCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const days = getMonthDays(year, month);

            document.getElementById('monthInfo').textContent = 
                `${year}å¹´${month + 1}æœˆ`;

            const grid = document.getElementById('shiftGrid');
            grid.innerHTML = '';

            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šã®ãŸã‚ç¥æ—¥åˆ¤å®šãªã—ï¼‰
            const weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            weekdays.forEach((day, index) => {
                const header = document.createElement('div');
                header.className = 'shift-day-header';
                // 0=æœˆæ›œã€5=åœŸæ›œã€6=æ—¥æ›œ
                if (index === 5) {
                    header.classList.add('saturday'); // åœŸæ›œæ—¥
                } else if (index === 6) {
                    header.classList.add('sunday'); // æ—¥æ›œæ—¥
                }
                header.textContent = day;
                grid.appendChild(header);
            });

            // æ—¥ä»˜ã‚»ãƒ«
            days.forEach(({ date, otherMonth }) => {
                const cell = document.createElement('div');
                cell.className = 'shift-day';
                if (otherMonth) cell.classList.add('other-month');

                const dateNum = document.createElement('div');
                dateNum.className = 'shift-date-num';
                dateNum.textContent = date.getDate();

                const dateStr = formatDate(date);
                const shift = shifts.find(s => s.date === dateStr);

                let statusDiv, timeDiv;
                
                if (!otherMonth) {
                    if (shift) {
                        cell.classList.add('has-shift');
                        if (shift.allDay) {
                            timeDiv = document.createElement('div');
                            timeDiv.className = 'shift-time';
                            timeDiv.textContent = 'çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯';
                        } else {
                            timeDiv = document.createElement('div');
                            timeDiv.className = 'shift-time';
                            let timeText = `${shift.startTime}ã€œ${shift.endTime}`;
                            if (shift.breakStartTime && shift.breakEndTime) {
                                timeText += ` (ä¼‘æ†©: ${shift.breakStartTime}ã€œ${shift.breakEndTime})`;
                            }
                            timeDiv.textContent = timeText;
                        }
                        
                        statusDiv = document.createElement('div');
                        statusDiv.className = 'shift-status working';
                        statusDiv.textContent = shift.allDay ? 'ãƒ–ãƒ­ãƒƒã‚¯' : 'å‹¤å‹™';
                    } else {
                        const dayOfWeek = date.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            cell.classList.add('off-day');
                            statusDiv = document.createElement('div');
                            statusDiv.className = 'shift-status off';
                            statusDiv.textContent = 'ä¼‘ã¿';
                        } else {
                            cell.classList.add('no-shift');
                            statusDiv = document.createElement('div');
                            statusDiv.className = 'shift-status warning';
                            statusDiv.textContent = 'âš ï¸ æœªç™»éŒ²';
                        }
                    }

                    cell.onclick = () => editShiftDay(dateStr, shift);
                }

                cell.appendChild(dateNum);
                if (timeDiv) cell.appendChild(timeDiv);
                if (statusDiv) cell.appendChild(statusDiv);
                
                grid.appendChild(cell);
            });
        }

        // æœˆå¤‰æ›´
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderShiftCalendar();
            updateSummary();
            updateBlocksFromShifts();
        }

        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateSummary() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const days = getMonthDays(year, month).filter(d => !d.otherMonth);

            let registered = 0;
            let unregistered = 0;
            let off = 0;

            days.forEach(({ date }) => {
                const dateStr = formatDate(date);
                const shift = shifts.find(s => s.date === dateStr);
                const dayOfWeek = date.getDay();

                if (shift) {
                    registered++;
                } else if (dayOfWeek === 0 || dayOfWeek === 6) {
                    off++;
                } else {
                    unregistered++;
                }
            });

            document.getElementById('summaryRegistered').textContent = `${registered}æ—¥`;
            document.getElementById('summaryUnregistered').textContent = `${unregistered}æ—¥`;
            document.getElementById('summaryOff').textContent = `${off}æ—¥`;
        }

        // ã‚·ãƒ•ãƒˆã‹ã‚‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ›´æ–°
        function updateBlocksFromShifts() {
            // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
            blocks = blocks.filter(b => !b.fromShift);
            
            // ã‚·ãƒ•ãƒˆã«åŸºã¥ã„ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ 
            shifts.forEach(shift => {
                if (shift.allDay) {
                    // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ - é€±ã®è¡¨ç¤ºç¯„å›²å…¨ä½“ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                    const dates = getWeekDates(currentWeek);
                    const range = getWeekTimeRange(dates);
                    const startTime = `${String(range.startHour).padStart(2, '0')}:00`;
                    const endTime = `${String(range.endHour).padStart(2, '0')}:00`;
                    
                    blocks.push({
                        id: Date.now() + Math.random(),
                        date: shift.date,
                        startTime: startTime,
                        endTime: endTime,
                        fromShift: true
                    });
                } else {
                    // ã‚·ãƒ•ãƒˆæ™‚é–“å¤–ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¼‘æ†©æ™‚é–“ã‚‚å«ã‚€ï¼‰
                    const dates = getWeekDates(currentWeek);
                    const range = getWeekTimeRange(dates);
                    const slots = getTimeSlots(dates);
                    
                    const startMinutes = timeToMinutes(shift.startTime);
                    const endTime = shift.endTime === '24:00' ? '24:00' : shift.endTime;
                    const endMinutes = endTime === '24:00' ? 24 * 60 : timeToMinutes(endTime);
                    
                    // ä¼‘æ†©æ™‚é–“ã®ç¯„å›²ã‚’è¨ˆç®—
                    let breakStartMinutes = null;
                    let breakEndMinutes = null;
                    if (shift.breakStartTime && shift.breakEndTime) {
                        breakStartMinutes = timeToMinutes(shift.breakStartTime);
                        const breakEndTime = shift.breakEndTime === '24:00' ? '24:00' : shift.breakEndTime;
                        breakEndMinutes = breakEndTime === '24:00' ? 24 * 60 : timeToMinutes(breakEndTime);
                    }
                    
                    slots.forEach((slot, index) => {
                        if (slot.endsWith(':00') && index === slots.length - 1) return;
                        
                        const slotMinutes = timeToMinutes(slot);
                        const nextSlot = slots[index + 1] || slots[slots.length - 1];
                        
                        // ã‚·ãƒ•ãƒˆæ™‚é–“å¤–ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                        if (slotMinutes < startMinutes || slotMinutes >= endMinutes) {
                            blocks.push({
                                id: Date.now() + Math.random(),
                                date: shift.date,
                                startTime: slot,
                                endTime: nextSlot,
                                fromShift: true
                            });
                        }
                        // ä¼‘æ†©æ™‚é–“ã‚’ãƒ–ãƒ­ãƒƒã‚¯
                        else if (breakStartMinutes !== null && breakEndMinutes !== null) {
                            if (slotMinutes >= breakStartMinutes && slotMinutes < breakEndMinutes) {
                                blocks.push({
                                    id: Date.now() + Math.random(),
                                    date: shift.date,
                                    startTime: slot,
                                    endTime: nextSlot,
                                    fromShift: true,
                                    isBreak: true
                                });
                            }
                        }
                    });
                }
            });
            
            persistState();
            renderCalendar(true);
            renderCalendar(false);
        }

        // æ™‚é–“é¸æŠã®åˆæœŸåŒ–ï¼ˆ24æ™‚é–“å¯¾å¿œï¼‰ - å…¨ä½“çš„ãªåˆæœŸåŒ–
        function initializeTimeSelects() {
            const selects = [
                'shiftStartTime', 'shiftEndTime',
                'bulkStartTime', 'bulkEndTime',
                'shiftBreakStartTime', 'shiftBreakEndTime'
            ];

            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                select.innerHTML = '';
                // 0:00ï½23:59ã®ç¯„å›²ã§ç”Ÿæˆ
                for (let h = 0; h < 24; h++) {
                    for (let m = 0; m < 60; m += INTERVAL) {
                        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        select.appendChild(option);
                    }
                }
                // 24:00ã‚‚è¿½åŠ 
                const option24 = document.createElement('option');
                option24.value = '24:00';
                option24.textContent = '24:00';
                select.appendChild(option24);
            });

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
            if (document.getElementById('shiftStartTime')) {
                document.getElementById('shiftStartTime').value = '10:00';
                document.getElementById('shiftEndTime').value = '19:00';
            }
            if (document.getElementById('bulkStartTime')) {
                document.getElementById('bulkStartTime').value = '10:00';
                document.getElementById('bulkEndTime').value = '19:00';
            }
        }

        // å€‹åˆ¥ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®æ™‚é–“é¸æŠåˆæœŸåŒ–
        function initializeShiftTimeSelects() {
            const selects = ['shiftStartTime', 'shiftEndTime', 'shiftBreakStartTime', 'shiftBreakEndTime'];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                // æ—¢ã«é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå€¤ã‚’ä¿æŒï¼‰
                if (select.children.length > 0) return;
                
                select.innerHTML = '';
                // 0:00ï½23:59ã®ç¯„å›²ã§ç”Ÿæˆ
                for (let h = 0; h < 24; h++) {
                    for (let m = 0; m < 60; m += INTERVAL) {
                        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        select.appendChild(option);
                    }
                }
                // 24:00ã‚‚è¿½åŠ 
                const option24 = document.createElement('option');
                option24.value = '24:00';
                option24.textContent = '24:00';
                select.appendChild(option24);
            });

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
            const shiftStart = document.getElementById('shiftStartTime');
            const shiftEnd = document.getElementById('shiftEndTime');
            if (shiftStart && !shiftStart.value) {
                shiftStart.value = '10:00';
            }
            if (shiftEnd && !shiftEnd.value) {
                shiftEnd.value = '19:00';
            }
        }

        // ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®æ™‚é–“é¸æŠåˆæœŸåŒ–
        function initializeBulkTimeSelects() {
            const selects = ['bulkStartTime', 'bulkEndTime', 'bulkBreakStartTime', 'bulkBreakEndTime'];
            
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                // æ—¢ã«é¸æŠè‚¢ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå€¤ã‚’ä¿æŒï¼‰
                if (select.children.length > 0) return;
                
                select.innerHTML = '';
                // 0:00ï½23:59ã®ç¯„å›²ã§ç”Ÿæˆ
                for (let h = 0; h < 24; h++) {
                    for (let m = 0; m < 60; m += INTERVAL) {
                        const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = time;
                        option.textContent = time;
                        select.appendChild(option);
                    }
                }
                // 24:00ã‚‚è¿½åŠ 
                const option24 = document.createElement('option');
                option24.value = '24:00';
                option24.textContent = '24:00';
                select.appendChild(option24);
            });

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
            const bulkStart = document.getElementById('bulkStartTime');
            const bulkEnd = document.getElementById('bulkEndTime');
            const bulkBreakStart = document.getElementById('bulkBreakStartTime');
            const bulkBreakEnd = document.getElementById('bulkBreakEndTime');
            if (bulkStart && !bulkStart.value) {
                bulkStart.value = '10:00';
            }
            if (bulkEnd && !bulkEnd.value) {
                bulkEnd.value = '19:00';
            }
            if (bulkBreakStart && !bulkBreakStart.value) {
                bulkBreakStart.value = '12:00';
            }
            if (bulkBreakEnd && !bulkBreakEnd.value) {
                bulkBreakEnd.value = '13:00';
            }
        }

        // ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²ã®ä¼‘æ†©æ™‚é–“å…¥åŠ›ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleBulkBreakInputs() {
            const hasBreak = document.getElementById('bulkHasBreak').checked;
            const breakTimeGroup = document.getElementById('bulkBreakTimeGroup');
            if (breakTimeGroup) {
                breakTimeGroup.style.display = hasBreak ? 'block' : 'none';
            }
        }

        // ä¼‘æ†©æ™‚é–“å…¥åŠ›ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleBreakInputs() {
            const hasBreak = document.getElementById('shiftHasBreak').checked;
            const breakGroup = document.getElementById('breakTimeGroup');
            if (hasBreak) {
                breakGroup.style.display = 'block';
            } else {
                breakGroup.style.display = 'none';
            }
        }

        // çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleShiftTimeInputs() {
            const allDay = document.getElementById('shiftAllDay').checked;
            const timeGroup = document.getElementById('shiftTimeGroup');
            const breakGroup = document.getElementById('shiftBreakGroup');
            if (allDay) {
                timeGroup.style.display = 'none';
                breakGroup.style.display = 'none';
            } else {
                timeGroup.style.display = 'block';
                breakGroup.style.display = 'block';
            }
        }

        // ã‚·ãƒ•ãƒˆæ—¥ç·¨é›†
        function editShiftDay(dateStr, shift) {
            if (shift) {
                // ç·¨é›†
                document.getElementById('shiftDate').value = dateStr;
                document.getElementById('shiftAllDay').checked = shift.allDay || false;
                toggleShiftTimeInputs();
                if (!shift.allDay) {
                    document.getElementById('shiftStartTime').value = shift.startTime;
                    document.getElementById('shiftEndTime').value = shift.endTime;
                    if (shift.breakStartTime && shift.breakEndTime) {
                        document.getElementById('shiftHasBreak').checked = true;
                        document.getElementById('shiftBreakStartTime').value = shift.breakStartTime;
                        document.getElementById('shiftBreakEndTime').value = shift.breakEndTime;
                    } else {
                        document.getElementById('shiftHasBreak').checked = false;
                    }
                    toggleBreakInputs();
                }
                document.getElementById('shiftMemo').value = shift.memo || '';
                openShiftModal();
            } else {
                // æ–°è¦ç™»éŒ²
                document.getElementById('shiftDate').value = dateStr;
                document.getElementById('shiftAllDay').checked = false;
                document.getElementById('shiftHasBreak').checked = false;
                toggleShiftTimeInputs();
                toggleBreakInputs();
                openShiftModal();
            }
        }

        // å€‹åˆ¥ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openShiftModal() {
            const today = formatDate(new Date());
            if (!document.getElementById('shiftDate').value) {
                document.getElementById('shiftDate').value = today;
            }
            
            // æ™‚é–“é¸æŠã‚’åˆæœŸåŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚Œã‚‹ãŸã³ã«ç¢ºå®Ÿã«åˆæœŸåŒ–ï¼‰
            initializeShiftTimeSelects();
            
            document.getElementById('shiftModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('active');
            document.body.style.overflow = '';
            // ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('shiftDate').value = '';
            document.getElementById('shiftAllDay').checked = false;
            document.getElementById('shiftHasBreak').checked = false;
            document.getElementById('shiftMemo').value = '';
            toggleShiftTimeInputs();
            toggleBreakInputs();
        }

        function saveShift() {
            const date = document.getElementById('shiftDate').value;
            const allDay = document.getElementById('shiftAllDay').checked;
            const startTime = document.getElementById('shiftStartTime').value;
            const endTime = document.getElementById('shiftEndTime').value;
            const hasBreak = document.getElementById('shiftHasBreak').checked;
            const breakStartTime = document.getElementById('shiftBreakStartTime').value;
            const breakEndTime = document.getElementById('shiftBreakEndTime').value;
            const memo = document.getElementById('shiftMemo').value;

            if (!date) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!allDay && (!startTime || !endTime)) {
                alert('å‹¤å‹™æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!allDay) {
                const start = timeToMinutes(startTime);
                const end = timeToMinutes(endTime === '24:00' ? '24:00' : endTime);
                const endMinutes = end === '24:00' ? 24 * 60 : timeToMinutes(endTime);
                if (start >= endMinutes) {
                    alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }

                // ä¼‘æ†©æ™‚é–“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (hasBreak && breakStartTime && breakEndTime) {
                    const breakStart = timeToMinutes(breakStartTime);
                    const breakEnd = timeToMinutes(breakEndTime === '24:00' ? '24:00' : breakEndTime);
                    const breakEndMinutes = breakEnd === '24:00' ? 24 * 60 : timeToMinutes(breakEndTime);
                    
                    if (breakStart >= breakEndMinutes) {
                        alert('ä¼‘æ†©çµ‚äº†æ™‚åˆ»ã¯ä¼‘æ†©é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    if (breakStart < start || breakEndMinutes > endMinutes) {
                        alert('ä¼‘æ†©æ™‚é–“ã¯å‹¤å‹™æ™‚é–“ã®ç¯„å›²å†…ã«è¨­å®šã—ã¦ãã ã•ã„');
                        return;
                    }
                }
            }

            // æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤
            shifts = shifts.filter(s => s.date !== date);

            // æ–°è¦è¿½åŠ 
            const shiftData = {
                id: Date.now(),
                date,
                memo,
                patternId: null,
                patternName: null,
                allDay: allDay || false
            };
            
            if (!allDay) {
                shiftData.startTime = startTime;
                shiftData.endTime = endTime;
                if (hasBreak && breakStartTime && breakEndTime) {
                    shiftData.breakStartTime = breakStartTime;
                    shiftData.breakEndTime = breakEndTime;
                }
            }

            shifts.push(shiftData);

            persistShiftData();
            renderShiftCalendar();
            updateSummary();
            updateBlocksFromShifts();
            closeShiftModal();
            alert('ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openBulkShiftModal() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('bulkStartDate').value = formatDate(today);
            document.getElementById('bulkEndDate').value = formatDate(nextWeek);
            
            // ä¼‘æ†©æ™‚é–“ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const bulkHasBreak = document.getElementById('bulkHasBreak');
            if (bulkHasBreak) {
                bulkHasBreak.checked = false;
                toggleBulkBreakInputs();
            }
            
            // æ™‚é–“é¸æŠã‚’åˆæœŸåŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚Œã‚‹ãŸã³ã«ç¢ºå®Ÿã«åˆæœŸåŒ–ï¼‰
            initializeBulkTimeSelects();
            
            document.getElementById('bulkShiftModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBulkShiftModal() {
            document.getElementById('bulkShiftModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function saveBulkShift() {
            const startDate = new Date(document.getElementById('bulkStartDate').value);
            const endDate = new Date(document.getElementById('bulkEndDate').value);
            const startTime = document.getElementById('bulkStartTime').value;
            const endTime = document.getElementById('bulkEndTime').value;
            const hasBreak = document.getElementById('bulkHasBreak').checked;
            const breakStartTime = hasBreak ? document.getElementById('bulkBreakStartTime').value : null;
            const breakEndTime = hasBreak ? document.getElementById('bulkBreakEndTime').value : null;

            // é¸æŠã•ã‚ŒãŸæ›œæ—¥
            const selectedDays = [];
            ['bulk-mon', 'bulk-tue', 'bulk-wed', 'bulk-thu', 'bulk-fri', 'bulk-sat', 'bulk-sun'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox.checked) {
                    selectedDays.push(parseInt(checkbox.value));
                }
            });

            if (selectedDays.length === 0) {
                alert('å¯¾è±¡æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            {
                const start = timeToMinutes(startTime);
                const endTimeValue = endTime === '24:00' ? '24:00' : endTime;
                const end = endTimeValue === '24:00' ? 24 * 60 : timeToMinutes(endTime);
                if (start >= end) {
                    alert('çµ‚äº†æ™‚åˆ»ã¯é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }

                // ä¼‘æ†©æ™‚é–“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (hasBreak && breakStartTime && breakEndTime) {
                    const breakStart = timeToMinutes(breakStartTime);
                    const breakEnd = timeToMinutes(breakEndTime);
                    if (breakStart >= breakEnd) {
                        alert('ä¼‘æ†©çµ‚äº†æ™‚åˆ»ã¯ä¼‘æ†©é–‹å§‹æ™‚åˆ»ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
                        return;
                    }
                    if (breakStart < start || breakEnd > end) {
                        alert('ä¼‘æ†©æ™‚é–“ã¯å‹¤å‹™æ™‚é–“ã®ç¯„å›²å†…ã«è¨­å®šã—ã¦ãã ã•ã„');
                        return;
                    }
                }
            }

            let count = 0;
            let blockCount = 0;
            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                
                // æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤
                shifts = shifts.filter(s => s.date !== dateStr);
                
                // æ›œæ—¥ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
                if (selectedDays.includes(dayOfWeek)) {
                    // é¸æŠã•ã‚ŒãŸæ›œæ—¥ã¯ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²
                    const shiftData = {
                        id: Date.now() + count,
                        date: dateStr,
                        startTime,
                        endTime: endTime === '24:00' ? '24:00' : endTime,
                        memo: '',
                        patternId: null,
                        patternName: null,
                        allDay: false
                    };
                    
                    if (hasBreak && breakStartTime && breakEndTime) {
                        shiftData.breakStartTime = breakStartTime;
                        shiftData.breakEndTime = breakEndTime;
                    }
                    
                    shifts.push(shiftData);
                    count++;
                } else {
                    // é¸æŠã•ã‚Œã¦ã„ãªã„æ›œæ—¥ã¯çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯
                    shifts.push({
                        id: Date.now() + count + blockCount + 1000000,
                        date: dateStr,
                        memo: '',
                        patternId: null,
                        patternName: null,
                        allDay: true
                    });
                    blockCount++;
                }
            }

            persistShiftData();
            renderShiftCalendar();
            updateSummary();
            updateBlocksFromShifts();
            closeBulkShiftModal();
            const message = count > 0 && blockCount > 0 
                ? `${count}ä»¶ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã€${blockCount}ä»¶ã‚’çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ`
                : count > 0 
                    ? `${count}ä»¶ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ`
                    : `${blockCount}ä»¶ã‚’çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ`;
            alert(message);
        }

        // ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openPatternManageModal() {
            renderPatternList();
            document.getElementById('patternManageModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePatternManageModal() {
            document.getElementById('patternManageModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function renderPatternList() {
            const list = document.getElementById('patternList');
            list.innerHTML = '';

            if (patterns.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #757575; padding: 20px;">ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            patterns.forEach(pattern => {
                const card = document.createElement('div');
                card.className = 'pattern-card';

                const header = document.createElement('div');
                header.className = 'pattern-header';

                const name = document.createElement('div');
                name.className = 'pattern-name';
                name.textContent = pattern.name;

                const actions = document.createElement('div');
                actions.className = 'pattern-actions';

                const editBtn = document.createElement('button');
                editBtn.textContent = 'ç·¨é›†';
                editBtn.onclick = () => editPattern(pattern.id);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'å‰Šé™¤';
                deleteBtn.onclick = () => deletePattern(pattern.id);

                actions.appendChild(editBtn);
                actions.appendChild(deleteBtn);

                header.appendChild(name);
                header.appendChild(actions);

                const schedule = document.createElement('div');
                schedule.className = 'pattern-schedule';
                schedule.innerHTML = getPatternSummary(pattern);

                card.appendChild(header);
                card.appendChild(schedule);
                list.appendChild(card);
            });
        }

        function getPatternSummary(pattern) {
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const keys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            let summary = '';
            keys.forEach((key, index) => {
                const day = pattern.schedule[key];
                if (day.enabled) {
                    let timeText = `${days[index]}: ${day.startTime}ã€œ${day.endTime}`;
                    if (day.breakStartTime && day.breakEndTime) {
                        timeText += ` (ä¼‘æ†©: ${day.breakStartTime}ã€œ${day.breakEndTime})`;
                    }
                    summary += `${timeText}<br>`;
                } else {
                    summary += `${days[index]}: ä¼‘ã¿<br>`;
                }
            });
            
            // ç¥æ—¥ã®è¨­å®šã‚’è¡¨ç¤º
            if (pattern.schedule.holiday && pattern.schedule.holiday.enabled) {
                let holidayText = `ç¥æ—¥: ${pattern.schedule.holiday.startTime}ã€œ${pattern.schedule.holiday.endTime}`;
                if (pattern.schedule.holiday.breakStartTime && pattern.schedule.holiday.breakEndTime) {
                    holidayText += ` (ä¼‘æ†©: ${pattern.schedule.holiday.breakStartTime}ã€œ${pattern.schedule.holiday.breakEndTime})`;
                }
                summary += `${holidayText}<br>`;
            }
            
            return summary;
        }

        // ãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openPatternEditModal(patternId = null) {
            editingPatternId = patternId;
            
            if (patternId) {
                const pattern = patterns.find(p => p.id === patternId);
                document.getElementById('patternEditTitle').textContent = 'ãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†';
                document.getElementById('patternName').value = pattern.name;
                document.getElementById('patternDescription').value = pattern.description || '';
            } else {
                document.getElementById('patternEditTitle').textContent = 'ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ';
                document.getElementById('patternName').value = '';
                document.getElementById('patternDescription').value = '';
            }

            renderPatternScheduleEditor(patternId);
            document.getElementById('patternEditModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePatternEditModal() {
            document.getElementById('patternEditModal').classList.remove('active');
            document.body.style.overflow = '';
            editingPatternId = null;
        }

        function renderPatternScheduleEditor(patternId) {
            const editor = document.getElementById('patternScheduleEditor');
            editor.innerHTML = '';

            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            const keys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

            const pattern = patternId ? patterns.find(p => p.id === patternId) : null;

            keys.forEach((key, index) => {
                const row = document.createElement('div');
                row.className = 'schedule-row';

                const label = document.createElement('div');
                label.className = 'weekday-label';
                label.textContent = days[index];

                const controls = document.createElement('div');
                controls.className = 'time-controls';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `pattern-${key}`;
                checkbox.checked = pattern ? pattern.schedule[key].enabled : true;

                const startSelect = createTimeSelect(`pattern-start-${key}`);
                const endSelect = createTimeSelect(`pattern-end-${key}`);

                if (pattern && pattern.schedule[key].enabled) {
                    startSelect.value = pattern.schedule[key].startTime;
                    endSelect.value = pattern.schedule[key].endTime;
                } else {
                    startSelect.value = '10:00';
                    endSelect.value = '19:00';
                }

                // ä¼‘æ†©æ™‚é–“ã®è¦ç´ 
                const breakCheckbox = document.createElement('input');
                breakCheckbox.type = 'checkbox';
                breakCheckbox.id = `pattern-break-${key}`;
                const hasBreak = pattern ? (pattern.schedule[key].breakStartTime && pattern.schedule[key].breakEndTime) : false;
                breakCheckbox.checked = hasBreak;

                const breakStartSelect = createTimeSelect(`pattern-break-start-${key}`);
                const breakEndSelect = createTimeSelect(`pattern-break-end-${key}`);

                if (pattern && hasBreak) {
                    breakStartSelect.value = pattern.schedule[key].breakStartTime;
                    breakEndSelect.value = pattern.schedule[key].breakEndTime;
                } else {
                    breakStartSelect.value = '12:00';
                    breakEndSelect.value = '13:00';
                }

                const breakTimeGroup = document.createElement('div');
                breakTimeGroup.style.cssText = 'display: none; margin-left: 28px; margin-top: 4px;';
                const breakTimeSelects = document.createElement('div');
                breakTimeSelects.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                breakTimeSelects.appendChild(breakStartSelect);
                breakTimeSelects.appendChild(document.createTextNode(' ã€œ '));
                breakTimeSelects.appendChild(breakEndSelect);
                breakTimeGroup.appendChild(breakTimeSelects);

                const updateControls = () => {
                    const enabled = checkbox.checked;
                    startSelect.disabled = !enabled;
                    endSelect.disabled = !enabled;
                    breakCheckbox.disabled = !enabled;
                    breakStartSelect.disabled = !enabled || !breakCheckbox.checked;
                    breakEndSelect.disabled = !enabled || !breakCheckbox.checked;
                    
                    if (!enabled) {
                        breakCheckbox.checked = false;
                        breakTimeGroup.style.display = 'none';
                    }
                };

                const updateBreakControls = () => {
                    const showBreak = checkbox.checked && breakCheckbox.checked;
                    breakTimeGroup.style.display = showBreak ? 'block' : 'none';
                    breakStartSelect.disabled = !checkbox.checked || !breakCheckbox.checked;
                    breakEndSelect.disabled = !checkbox.checked || !breakCheckbox.checked;
                };

                checkbox.addEventListener('change', updateControls);
                breakCheckbox.addEventListener('change', updateBreakControls);
                updateControls();
                updateBreakControls();

                // å‹¤å‹™æ™‚é–“ã®è¡Œ
                const workTimeRow = document.createElement('div');
                workTimeRow.style.cssText = 'display: flex; align-items: center; gap: 8px; width: 100%;';
                workTimeRow.appendChild(checkbox);
                workTimeRow.appendChild(startSelect);
                workTimeRow.appendChild(document.createTextNode(' ã€œ '));
                workTimeRow.appendChild(endSelect);

                // ä¼‘æ†©æ™‚é–“ã®è¡Œ
                const breakRow = document.createElement('div');
                breakRow.style.cssText = 'display: flex; flex-direction: column; width: 100%;';
                const breakLabel = document.createElement('label');
                breakLabel.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer;';
                breakLabel.appendChild(breakCheckbox);
                breakLabel.appendChild(document.createTextNode('ä¼‘æ†©æ™‚é–“'));
                breakRow.appendChild(breakLabel);
                breakRow.appendChild(breakTimeGroup);

                controls.appendChild(workTimeRow);
                controls.appendChild(breakRow);

                row.appendChild(label);
                row.appendChild(controls);
                editor.appendChild(row);
            });
            
            // ç¥æ—¥ã®è¨­å®šã‚’è¿½åŠ 
            const holidayRow = document.createElement('div');
            holidayRow.className = 'schedule-row';
            
            const holidayLabel = document.createElement('div');
            holidayLabel.className = 'weekday-label';
            holidayLabel.textContent = 'ç¥æ—¥';
            
            const holidayControls = document.createElement('div');
            holidayControls.className = 'time-controls';
            
            const holidayCheckbox = document.createElement('input');
            holidayCheckbox.type = 'checkbox';
            holidayCheckbox.id = 'pattern-holiday';
            holidayCheckbox.checked = pattern ? (pattern.holiday && pattern.holiday.enabled) : true;
            
            const holidayStartSelect = createTimeSelect('pattern-holiday-start');
            const holidayEndSelect = createTimeSelect('pattern-holiday-end');
            
            if (pattern && pattern.holiday && pattern.holiday.enabled) {
                holidayStartSelect.value = pattern.holiday.startTime;
                holidayEndSelect.value = pattern.holiday.endTime;
            } else {
                holidayStartSelect.value = '10:00';
                holidayEndSelect.value = '19:00';
            }
            
            // ä¼‘æ†©æ™‚é–“ã®è¦ç´ 
            const holidayBreakCheckbox = document.createElement('input');
            holidayBreakCheckbox.type = 'checkbox';
            holidayBreakCheckbox.id = 'pattern-holiday-break';
            const hasHolidayBreak = pattern ? (pattern.holiday && pattern.holiday.breakStartTime && pattern.holiday.breakEndTime) : false;
            holidayBreakCheckbox.checked = hasHolidayBreak;
            
            const holidayBreakStartSelect = createTimeSelect('pattern-holiday-break-start');
            const holidayBreakEndSelect = createTimeSelect('pattern-holiday-break-end');
            
            if (pattern && hasHolidayBreak) {
                holidayBreakStartSelect.value = pattern.holiday.breakStartTime;
                holidayBreakEndSelect.value = pattern.holiday.breakEndTime;
            } else {
                holidayBreakStartSelect.value = '12:00';
                holidayBreakEndSelect.value = '13:00';
            }
            
            const holidayBreakTimeGroup = document.createElement('div');
            holidayBreakTimeGroup.style.cssText = 'display: none; margin-left: 28px; margin-top: 4px;';
            const holidayBreakTimeSelects = document.createElement('div');
            holidayBreakTimeSelects.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            holidayBreakTimeSelects.appendChild(holidayBreakStartSelect);
            holidayBreakTimeSelects.appendChild(document.createTextNode(' ã€œ '));
            holidayBreakTimeSelects.appendChild(holidayBreakEndSelect);
            holidayBreakTimeGroup.appendChild(holidayBreakTimeSelects);
            
            const updateHolidayControls = () => {
                const enabled = holidayCheckbox.checked;
                holidayStartSelect.disabled = !enabled;
                holidayEndSelect.disabled = !enabled;
                holidayBreakCheckbox.disabled = !enabled;
                holidayBreakStartSelect.disabled = !enabled || !holidayBreakCheckbox.checked;
                holidayBreakEndSelect.disabled = !enabled || !holidayBreakCheckbox.checked;
                
                if (!enabled) {
                    holidayBreakCheckbox.checked = false;
                    holidayBreakTimeGroup.style.display = 'none';
                }
            };
            
            const updateHolidayBreakControls = () => {
                const showBreak = holidayCheckbox.checked && holidayBreakCheckbox.checked;
                holidayBreakTimeGroup.style.display = showBreak ? 'block' : 'none';
                holidayBreakStartSelect.disabled = !holidayCheckbox.checked || !holidayBreakCheckbox.checked;
                holidayBreakEndSelect.disabled = !holidayCheckbox.checked || !holidayBreakCheckbox.checked;
            };
            
            holidayCheckbox.addEventListener('change', updateHolidayControls);
            holidayBreakCheckbox.addEventListener('change', updateHolidayBreakControls);
            updateHolidayControls();
            updateHolidayBreakControls();
            
            // å‹¤å‹™æ™‚é–“ã®è¡Œ
            const holidayWorkTimeRow = document.createElement('div');
            holidayWorkTimeRow.style.cssText = 'display: flex; align-items: center; gap: 8px; width: 100%;';
            holidayWorkTimeRow.appendChild(holidayCheckbox);
            holidayWorkTimeRow.appendChild(holidayStartSelect);
            holidayWorkTimeRow.appendChild(document.createTextNode(' ã€œ '));
            holidayWorkTimeRow.appendChild(holidayEndSelect);
            
            // ä¼‘æ†©æ™‚é–“ã®è¡Œ
            const holidayBreakRow = document.createElement('div');
            holidayBreakRow.style.cssText = 'display: flex; flex-direction: column; width: 100%;';
            const holidayBreakLabel = document.createElement('label');
            holidayBreakLabel.style.cssText = 'display: flex; align-items: center; gap: 8px; cursor: pointer;';
            holidayBreakLabel.appendChild(holidayBreakCheckbox);
            holidayBreakLabel.appendChild(document.createTextNode('ä¼‘æ†©æ™‚é–“'));
            holidayBreakRow.appendChild(holidayBreakLabel);
            holidayBreakRow.appendChild(holidayBreakTimeGroup);
            
            holidayControls.appendChild(holidayWorkTimeRow);
            holidayControls.appendChild(holidayBreakRow);
            
            holidayRow.appendChild(holidayLabel);
            holidayRow.appendChild(holidayControls);
            editor.appendChild(holidayRow);
        }

        function createTimeSelect(id) {
            const select = document.createElement('select');
            select.id = id;
            // 0:00ï½23:59ã®ç¯„å›²ã§ç”Ÿæˆï¼ˆ24æ™‚é–“å¯¾å¿œï¼‰
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += INTERVAL) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    select.appendChild(option);
                }
            }
            // 24:00ã‚‚è¿½åŠ 
            const option24 = document.createElement('option');
            option24.value = '24:00';
            option24.textContent = '24:00';
            select.appendChild(option24);
            return select;
        }

        function savePattern() {
            const name = document.getElementById('patternName').value.trim();
            const description = document.getElementById('patternDescription').value.trim();

            if (!name) {
                alert('ãƒ‘ã‚¿ãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const keys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const schedule = {};

            keys.forEach(key => {
                const checkbox = document.getElementById(`pattern-${key}`);
                const enabled = checkbox.checked;
                
                if (enabled) {
                    const startTime = document.getElementById(`pattern-start-${key}`).value;
                    const endTime = document.getElementById(`pattern-end-${key}`).value;
                    const breakCheckbox = document.getElementById(`pattern-break-${key}`);
                    const hasBreak = breakCheckbox && breakCheckbox.checked;
                    
                    if (hasBreak) {
                        const breakStartTime = document.getElementById(`pattern-break-start-${key}`).value;
                        const breakEndTime = document.getElementById(`pattern-break-end-${key}`).value;
                        schedule[key] = { 
                            enabled: true, 
                            startTime, 
                            endTime,
                            breakStartTime,
                            breakEndTime
                        };
                    } else {
                        schedule[key] = { enabled: true, startTime, endTime };
                    }
                } else {
                    schedule[key] = { enabled: false };
                }
            });
            
            // ç¥æ—¥ã®è¨­å®šã‚’ä¿å­˜
            const holidayCheckbox = document.getElementById('pattern-holiday');
            const holidayEnabled = holidayCheckbox && holidayCheckbox.checked;
            
            if (holidayEnabled) {
                const holidayStartTime = document.getElementById('pattern-holiday-start').value;
                const holidayEndTime = document.getElementById('pattern-holiday-end').value;
                const holidayBreakCheckbox = document.getElementById('pattern-holiday-break');
                const hasHolidayBreak = holidayBreakCheckbox && holidayBreakCheckbox.checked;
                
                if (hasHolidayBreak) {
                    const holidayBreakStartTime = document.getElementById('pattern-holiday-break-start').value;
                    const holidayBreakEndTime = document.getElementById('pattern-holiday-break-end').value;
                    schedule.holiday = {
                        enabled: true,
                        startTime: holidayStartTime,
                        endTime: holidayEndTime,
                        breakStartTime: holidayBreakStartTime,
                        breakEndTime: holidayBreakEndTime
                    };
                } else {
                    schedule.holiday = {
                        enabled: true,
                        startTime: holidayStartTime,
                        endTime: holidayEndTime
                    };
                }
            } else {
                schedule.holiday = { enabled: false };
            }

            if (editingPatternId) {
                // ç·¨é›†
                const pattern = patterns.find(p => p.id === editingPatternId);
                pattern.name = name;
                pattern.description = description;
                pattern.schedule = schedule;
            } else {
                // æ–°è¦
                patterns.push({
                    id: Date.now(),
                    name,
                    description,
                    schedule
                });
            }

            persistShiftData();
            renderPatternList();
            closePatternEditModal();
            alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function editPattern(patternId) {
            closePatternManageModal();
            openPatternEditModal(patternId);
        }

        function deletePattern(patternId) {
            if (!confirm('ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) return;
            patterns = patterns.filter(p => p.id !== patternId);
            persistShiftData();
            renderPatternList();
        }

        // ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openPatternApplyModal() {
            const select = document.getElementById('patternSelect');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            patterns.forEach(pattern => {
                const option = document.createElement('option');
                option.value = pattern.id;
                option.textContent = pattern.name;
                select.appendChild(option);
            });

            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(today.getMonth() + 1);
            
            document.getElementById('applyStartDate').value = formatDate(today);
            document.getElementById('applyEndDate').value = formatDate(nextMonth);
            document.getElementById('overwriteShifts').checked = false;

            document.getElementById('patternApplyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePatternApplyModal() {
            document.getElementById('patternApplyModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function applyPattern() {
            const patternId = parseInt(document.getElementById('patternSelect').value);
            const startDate = new Date(document.getElementById('applyStartDate').value);
            const endDate = new Date(document.getElementById('applyEndDate').value);
            const overwrite = document.getElementById('overwriteShifts').checked;

            if (!patternId) {
                alert('ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const pattern = patterns.find(p => p.id === patternId);
            if (!pattern) return;

            const keys = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            let count = 0;

            for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const dayKey = keys[dayOfWeek];
                const daySetting = pattern.schedule[dayKey];
                const isHoliday = isJapaneseHoliday(date);
                const holidaySetting = pattern.schedule.holiday;

                // æ—¢å­˜ã‚·ãƒ•ãƒˆãƒã‚§ãƒƒã‚¯
                const existingShift = shifts.find(s => s.date === dateStr);
                if (existingShift && !overwrite) continue;

                // ç¥æ—¥è¨­å®šãŒæœ‰åŠ¹ã§ç¥æ—¥ã®å ´åˆã¯ç¥æ—¥è¨­å®šã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯æ›œæ—¥è¨­å®šã‚’ä½¿ç”¨
                const useHoliday = holidaySetting && holidaySetting.enabled && isHoliday;
                const targetSetting = useHoliday ? holidaySetting : daySetting;

                if (targetSetting && targetSetting.enabled) {
                    // æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤
                    shifts = shifts.filter(s => s.date !== dateStr);

                    // æ–°è¦è¿½åŠ 
                    const shiftData = {
                        id: Date.now() + count,
                        date: dateStr,
                        startTime: targetSetting.startTime,
                        endTime: targetSetting.endTime,
                        memo: '',
                        patternId: pattern.id,
                        patternName: pattern.name,
                        allDay: false
                    };

                    // ä¼‘æ†©æ™‚é–“ãŒã‚ã‚Œã°è¿½åŠ 
                    if (targetSetting.breakStartTime && targetSetting.breakEndTime) {
                        shiftData.breakStartTime = targetSetting.breakStartTime;
                        shiftData.breakEndTime = targetSetting.breakEndTime;
                    }

                    shifts.push(shiftData);
                    count++;
                } else if (overwrite && existingShift) {
                    // ä¼‘æ—¥è¨­å®šã®å ´åˆã¯æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤
                    shifts = shifts.filter(s => s.date !== dateStr);
                }
            }

            persistShiftData();
            renderShiftCalendar();
            updateSummary();
            updateBlocksFromShifts();
            closePatternApplyModal();
            alert(`${count}ä»¶ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        }

        // åˆæœŸåŒ–
        restoreState();
        restoreShiftData();
        (function syncIntervalUI(){
            const visitSel = document.getElementById('intervalVisitSelect');
            const visitAppliedText = document.getElementById('appliedIntervalVisitText');
            if (visitSel) visitSel.value = String(intervalVisitApplied);
            if (visitAppliedText) visitAppliedText.textContent = String(intervalVisitApplied);
            
            const storeSel = document.getElementById('intervalStoreSelect');
            const storeAppliedText = document.getElementById('appliedIntervalStoreText');
            if (storeSel) storeSel.value = String(intervalStoreApplied);
            if (storeAppliedText) storeAppliedText.textContent = String(intervalStoreApplied);
        })();
        initializeTimeSelects();
        renderShiftCalendar();
        updateSummary();
        updateBlocksFromShifts();
        renderCalendar(true);
        renderCalendar(false);
        updatePendingBadge();
    </script>

    <!-- å€‹åˆ¥ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <div class="modal-header">ã‚·ãƒ•ãƒˆç™»éŒ²</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ—¥ä»˜ *</label>
                    <input type="date" id="shiftDate" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="shiftAllDay" onchange="toggleShiftTimeInputs()">
                        çµ‚æ—¥ãƒ–ãƒ­ãƒƒã‚¯
                    </label>
                </div>
                <div class="form-group" id="shiftTimeGroup">
                    <label>å‹¤å‹™æ™‚é–“ *</label>
                    <div class="time-range">
                        <select id="shiftStartTime"></select>
                        <span>ã€œ</span>
                        <select id="shiftEndTime"></select>
                    </div>
                </div>
                <div class="form-group" id="shiftBreakGroup">
                    <label>
                        <input type="checkbox" id="shiftHasBreak" onchange="toggleBreakInputs()">
                        ä¼‘æ†©æ™‚é–“ã‚’è¨­å®šã™ã‚‹
                    </label>
                    <div id="breakTimeGroup" style="display: none; margin-top: 12px;">
                        <div class="time-range">
                            <select id="shiftBreakStartTime"></select>
                            <span>ã€œ</span>
                            <select id="shiftBreakEndTime"></select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¢</label>
                    <textarea id="shiftMemo" rows="3" placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeShiftModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="saveShift()">ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <!-- ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="bulkShiftModal">
        <div class="modal-content">
            <div class="modal-header">ä¸€æ‹¬ã‚·ãƒ•ãƒˆç™»éŒ²</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æœŸé–“ *</label>
                    <div class="time-range">
                        <input type="date" id="bulkStartDate" required>
                        <span>ã€œ</span>
                        <input type="date" id="bulkEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>å¯¾è±¡æ›œæ—¥ *</label>
                    <div class="weekday-selector">
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-mon" value="1">
                            <label for="bulk-mon">æœˆ</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-tue" value="2">
                            <label for="bulk-tue">ç«</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-wed" value="3">
                            <label for="bulk-wed">æ°´</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-thu" value="4">
                            <label for="bulk-thu">æœ¨</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-fri" value="5">
                            <label for="bulk-fri">é‡‘</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-sat" value="6">
                            <label for="bulk-sat">åœŸ</label>
                        </div>
                        <div class="weekday-checkbox">
                            <input type="checkbox" id="bulk-sun" value="0">
                            <label for="bulk-sun">æ—¥</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‹¤å‹™æ™‚é–“ *</label>
                    <div class="time-range">
                        <select id="bulkStartTime"></select>
                        <span>ã€œ</span>
                        <select id="bulkEndTime"></select>
                    </div>
                </div>
                <div class="form-group" id="bulkBreakGroup">
                    <label>
                        <input type="checkbox" id="bulkHasBreak" onchange="toggleBulkBreakInputs()">
                        ä¼‘æ†©æ™‚é–“ã‚’è¨­å®šã™ã‚‹
                    </label>
                    <div id="bulkBreakTimeGroup" style="display: none; margin-top: 12px;">
                        <div class="time-range">
                            <select id="bulkBreakStartTime"></select>
                            <span>ã€œ</span>
                            <select id="bulkBreakEndTime"></select>
                        </div>
                    </div>
                </div>
                <p style="color: #f57c00; font-size: 13px; margin-top: 12px;">
                    âš ï¸ æ—¢å­˜ã®ã‚·ãƒ•ãƒˆãŒã‚ã‚‹æ—¥ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBulkShiftModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="saveBulkShift()">ä¸€æ‹¬ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="patternManageModal">
        <div class="modal-content">
            <div class="modal-header">ç¨¼åƒãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†</div>
            <div class="modal-body">
                <button class="btn-primary" onclick="openPatternEditModal()" style="width: 100%; margin-bottom: 20px; padding: 12px 24px;">
                    + æ–°è¦ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ
                </button>
                <div class="pattern-list" id="patternList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePatternManageModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="patternEditModal">
        <div class="modal-content">
            <div class="modal-header" id="patternEditTitle">ç¨¼åƒãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ãƒ‘ã‚¿ãƒ¼ãƒ³å *</label>
                    <input type="text" id="patternName" placeholder="ä¾‹: é€šå¸¸å–¶æ¥­">
                </div>
                <div class="form-group">
                    <label>èª¬æ˜</label>
                    <textarea id="patternDescription" rows="2" placeholder="ãƒ‘ã‚¿ãƒ¼ãƒ³ã®èª¬æ˜ã‚’å…¥åŠ›"></textarea>
                </div>
                <div class="form-group">
                    <label>æ›œæ—¥åˆ¥è¨­å®š</label>
                    <div class="pattern-schedule-editor" id="patternScheduleEditor"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePatternEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="savePattern()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="patternApplyModal">
        <div class="modal-content">
            <div class="modal-header">ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ãƒ‘ã‚¿ãƒ¼ãƒ³ *</label>
                    <select id="patternSelect"></select>
                </div>
                <div class="form-group">
                    <label>é©ç”¨æœŸé–“ *</label>
                    <div class="time-range">
                        <input type="date" id="applyStartDate" required>
                        <span>ã€œ</span>
                        <input type="date" id="applyEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="overwriteShifts">
                        æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’ä¸Šæ›¸ãã™ã‚‹
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePatternApplyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-primary" onclick="applyPattern()">é©ç”¨</button>
            </div>
        </div>
    </div>
</body>
</html>
